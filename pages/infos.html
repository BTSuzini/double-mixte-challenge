<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infos ‚Äî Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">Suzini BT ‚Äî Double Mixte Challenge</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="classement.html">Classement</a>
      <a href="reglement.html">R√®glement</a>
      <a href="infos.html" aria-current="page">Infos</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Admin: ajout d'infos (affich√© uniquement si r√¥le = admin) -->
  <section class="card" id="adminBox" style="display:none;">
    <h2 style="margin:0 0 10px 0;">üõ†Ô∏è Admin ‚Äî Publier une info</h2>

    <form id="infoForm" class="form" autocomplete="off">
      <div class="field">
        <label for="infoTitle">Titre *</label>
        <input id="infoTitle" name="infoTitle" type="text" required maxlength="80" placeholder="Ex : Inscriptions ouvertes ‚úÖ">
      </div>

      <div class="field">
        <label for="infoText">Texte *</label>
        <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
          placeholder="√âcris ici le message (emojis ok üòÑ)"></textarea>
      </div>

      <button id="publishBtn" class="btn" type="submit" style="font-weight:800; color:#111;">
        üì£ Publier
      </button>

      <p id="adminStatus" class="muted" role="status" aria-live="polite"></p>
    </form>

    <p class="muted" style="margin-top:10px;">
      Les infos apparaissent automatiquement c√¥t√© public (plus r√©cent en haut).
    </p>
  </section>

  <!-- Public: fil d'infos -->
  <section class="card">
    <h2 style="margin:0 0 10px 0;">üì∞ Derni√®res infos</h2>
    <p class="muted" style="margin-top:0;">
      Retrouvez ici les derni√®res annonces de l‚Äôorganisation.
    </p>

    <!-- Compteur -->
    <p class="muted" id="infosCount" style="margin:10px 0 0;">Chargement‚Ä¶</p>

    <!-- Liste -->
    <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

</main>

<script type="module">
  // Firebase (CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ Ta config
  const firebaseConfig = {
    apiKey: "AIzaSyDAW66BD1V2Kr2w6ksM1_8bHGugeG6_cUI",
    authDomain: "suzini-double-mixte-challenge.firebaseapp.com",
    projectId: "suzini-double-mixte-challenge",
    storageBucket: "suzini-double-mixte-challenge.firebasestorage.app",
    messagingSenderId: "148641893645",
    appId: "1:148641893645:web:d73cb1727a7b96af3ff444"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üîß Collection des infos (publique en lecture)
  // -> C√¥t√© rules: allow read: if true; allow create: seulement admin
  const COL_INFOS = "infos";

  // Elements DOM
  const infosList = document.getElementById("infosList");
  const infosCount = document.getElementById("infosCount");

  const adminBox = document.getElementById("adminBox");
  const infoForm = document.getElementById("infoForm");
  const publishBtn = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");

  const fmtDate = (ts) => {
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "";
      return d.toLocaleString("fr-FR", { year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit" });
    } catch {
      return "";
    }
  };

  function escapeHTML(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderInfos(docs){
    infosList.innerHTML = "";

    infosCount.textContent = `üìå ${docs.length} info${docs.length > 1 ? "s" : ""}`;

    if(docs.length === 0){
      infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info pour le moment.</p>`;
      return;
    }

    for(const it of docs){
      const title = escapeHTML(it.title);
      const text = escapeHTML(it.text).replaceAll("\n","<br>");
      const date = fmtDate(it.createdAt);

      const card = document.createElement("div");
      card.className = "card";
      card.style.margin = "0";
      card.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <div style="font-weight:900;">${title}</div>
          <div class="muted" style="margin:0;">üóìÔ∏è ${date || "‚Äî"}</div>
          <div style="margin-top:2px; line-height:1.45;">${text}</div>
        </div>
      `;
      infosList.appendChild(card);
    }
  }

  // üîÑ Flux live (plus r√©cent en haut)
  const q = query(collection(db, COL_INFOS), orderBy("createdAt", "desc"));
  onSnapshot(q, (snap) => {
    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInfos(docs);
  }, (err) => {
    console.error(err);
    infosCount.textContent = "‚ùå Impossible de charger les infos.";
  });

  // üîê Afficher le bloc admin uniquement si r√¥le = admin
  async function getRoleByEmail(email){
    const ref = doc(db, "roles", email);
    const s = await getDoc(ref);
    if(!s.exists()) return null;
    return s.data().role || null;
  }

  onAuthStateChanged(auth, async (user) => {
    adminBox.style.display = "none";
    adminStatus.textContent = "";

    if(!user) return;

    try{
      const role = await getRoleByEmail(user.email);
      if(role === "admin"){
        adminBox.style.display = "block";
      }
    } catch(e){
      console.warn("Role lookup failed:", e);
    }
  });

  // üõ†Ô∏è Publication (admin)
  infoForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publication en cours‚Ä¶";

    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text  = (infoForm.infoText.value || "").trim();

      if(!title || !text){
        throw new Error("Titre et texte obligatoires.");
      }

      await addDoc(collection(db, COL_INFOS), {
        title,
        text,
        createdAt: serverTimestamp()
      });

      infoForm.reset();
      adminStatus.textContent = "‚úÖ Info publi√©e !";
    } catch(err){
      console.error(err);
      adminStatus.textContent = "‚ùå Erreur : " + (err?.message || "publication impossible.");
    } finally {
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });
</script>

</body>
</html>
