<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infos â€” Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">Suzini BT â€” Double Mixte Challenge</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">ğŸ  Accueil</a>
      <a href="classement.html">ğŸ† Classement</a>
      <a href="reglement.html">ğŸ“˜ RÃ¨glement</a>
      <a href="infos.html" aria-current="page">ğŸ“° Infos</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Admin: ajout d'infos (affichÃ© uniquement si rÃ´le = admin) -->
  <section class="card" id="adminBox" style="display:none;">
    <h2 style="margin:0 0 10px 0;">ğŸ› ï¸ Admin â€” Publier une info</h2>

    <form id="infoForm" class="form" autocomplete="off">
      <div class="field">
        <label for="infoTitle">Titre *</label>
        <input id="infoTitle" name="infoTitle" type="text" required maxlength="80"
               placeholder="Ex : Inscriptions ouvertes âœ…">
      </div>

      <div class="field">
        <label for="infoText">Texte *</label>
        <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
                  placeholder="Ã‰cris ici le message (emojis ok ğŸ˜„)"></textarea>
      </div>

      <button id="publishBtn" class="btn" type="submit" style="font-weight:800; color:#111;">
        ğŸ“£ Publier
      </button>

      <p id="adminStatus" class="muted" role="status" aria-live="polite" style="margin:8px 0 0;"></p>
    </form>

    <p class="muted" style="margin-top:10px;">
      Les infos apparaissent automatiquement cÃ´tÃ© public (plus rÃ©cent en haut).
    </p>
  </section>

  <!-- Public: fil d'infos -->
  <section class="card">
    <h2 style="margin:0 0 10px 0;">ğŸ“° DerniÃ¨res infos</h2>
    <p class="muted" style="margin-top:0;">
      Retrouvez ici les derniÃ¨res annonces de lâ€™organisation.
    </p>

    <!-- Compteur / statut -->
    <p class="muted" id="infosCount" style="margin:10px 0 0;">Chargementâ€¦</p>

    <!-- Liste -->
    <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

</main>

<script type="module">
  // Firebase (CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // âœ… Ta config
  const firebaseConfig = {
    apiKey: "AIzaSyDAW66BD1V2Kr2w6ksM1_8bHGugeG6_cUI",
    authDomain: "suzini-double-mixte-challenge.firebaseapp.com",
    projectId: "suzini-double-mixte-challenge",
    storageBucket: "suzini-double-mixte-challenge.firebasestorage.app",
    messagingSenderId: "148641893645",
    appId: "1:148641893645:web:d73cb1727a7b96af3ff444"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ğŸ”§ Collection des infos
  const COL_INFOS = "infos";

  // DOM
  const infosList  = document.getElementById("infosList");
  const infosCount = document.getElementById("infosCount");

  const adminBox    = document.getElementById("adminBox");
  const infoForm    = document.getElementById("infoForm");
  const publishBtn  = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");

  let isAdmin = false;

  function escapeHTML(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "â€”";
      return d.toLocaleString("fr-FR", {
        year:"numeric", month:"long", day:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
    } catch {
      return "â€”";
    }
  }

  async function getRoleByEmail(email){
    const ref = doc(db, "roles", email);
    const s = await getDoc(ref);
    if(!s.exists()) return null;
    return s.data().role || null;
  }

  function renderInfos(items){
    infosList.innerHTML = "";

    infosCount.textContent = `ğŸ“Œ ${items.length} info${items.length > 1 ? "s" : ""}`;

    if(items.length === 0){
      infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info pour le moment.</p>`;
      return;
    }

    for(const it of items){
      const title = escapeHTML(it.title);
      const text  = escapeHTML(it.text).replaceAll("\n","<br>");
      const date  = fmtDate(it.createdAt);

      const card = document.createElement("div");
      card.className = "card";
      card.style.margin = "0";

      // Bouton supprimer uniquement si admin
      const adminActions = isAdmin ? `
        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">
            ğŸ—‘ï¸ Supprimer
          </button>
        </div>
      ` : "";

      card.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <div style="font-weight:900;">${title}</div>
          <div class="muted" style="margin:0;">ğŸ—“ï¸ ${date}</div>
          <div style="margin-top:2px; line-height:1.45;">${text}</div>
          ${adminActions}
        </div>
      `;

      infosList.appendChild(card);
    }

    // Bind delete (admin only)
    if(isAdmin){
      infosList.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          const ok = confirm("Supprimer cette info ?\n\nâš ï¸ Action irrÃ©versible.");
          if(!ok) return;

          try{
            await deleteDoc(doc(db, COL_INFOS, id));
            alert("Info supprimÃ©e âœ…");
          } catch(e){
            console.error(e);
            alert("Erreur suppression âŒ");
          }
        });
      });
    }
  }

  // ğŸ” DÃ©tection admin
  onAuthStateChanged(auth, async (user) => {
    adminBox.style.display = "none";
    isAdmin = false;

    if(!user){
      // Re-render pour enlever les boutons delete si la personne se dÃ©connecte
      // (le flux snapshot continuera)
      return;
    }

    try{
      const role = await getRoleByEmail(user.email);
      if(role === "admin"){
        isAdmin = true;
        adminBox.style.display = "block";
      }
    } catch(e){
      console.warn("Role lookup failed:", e);
    }
  });

  // ğŸ”„ Flux live (plus rÃ©cent en haut)
  infosCount.textContent = "Chargementâ€¦";
  const q = query(collection(db, COL_INFOS), orderBy("createdAt", "desc"));

  onSnapshot(q, (snap) => {
    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInfos(items);
  }, (err) => {
    console.error(err);
    infosCount.textContent = "âŒ Impossible de charger les infos.";
  });

  // ğŸ› ï¸ Publication (admin)
  infoForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publication en coursâ€¦";

    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text  = (infoForm.infoText.value || "").trim();

      if(!title || !text){
        throw new Error("Titre et texte obligatoires.");
      }

      await addDoc(collection(db, COL_INFOS), {
        title,
        text,
        createdAt: serverTimestamp()
      });

      infoForm.reset();
      adminStatus.textContent = "âœ… Info publiÃ©e !";
    } catch(err){
      console.error(err);
      adminStatus.textContent = "âŒ Erreur : " + (err?.message || "publication impossible.");
    } finally {
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });
</script>

</body>
</html>
