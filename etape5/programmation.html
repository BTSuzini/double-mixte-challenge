<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programmation ‚Äî √âtape 5</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260222" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        √âtape 5 ‚Äî TEST<br>
        <span style="opacity:.95;font-weight:800;">Programmation üìÖ</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="programmation.html" aria-current="page">Programmation</a>
      <a href="equipes.html">√âquipes</a>
      <a href="inscriptions.html">Inscriptions</a>
      <a href="repas.html">Repas</a>
      <a href="tirage.html">Tirage au sort</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card">
    <h2 style="margin:0 0 10px;">üìÖ Programmation</h2>
    <p class="muted" id="statusText" style="margin:0;">Chargement‚Ä¶</p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="tabChrono" style="font-weight:900; color:#111;">üïí Chronologique</button>
      <button class="btn" id="tabTableau" style="font-weight:900; color:#111;">üß© Tableau</button>
    </div>

    <p class="muted" id="subtitle" style="margin-top:10px;"></p>
  </section>

  <!-- CHRONO -->
  <section class="card" id="panelChrono" style="display:none;">
    <h2 style="margin:0 0 10px;">üïí Planning des matchs</h2>
    <div id="chronoCards" style="display:grid; gap:12px;"></div>
  </section>

  <!-- TABLEAU -->
  <section class="card" id="panelTableau" style="display:none;">
    <h2 style="margin:0 0 10px;">üß© Tableau</h2>

    <div class="grid" style="margin-bottom:10px;">
      <div class="field" style="margin:0;">
        <label for="selBracket">Tableau</label>
        <select id="selBracket">
          <option value="main">Tableau principal</option>
          <option value="5-8">Tableau 5‚Äì8</option>
        </select>
      </div>

      <div class="field" style="margin:0;">
        <label for="selRound">Tour</label>
        <select id="selRound"></select>
      </div>
    </div>

    <div id="tableCards" style="display:grid; gap:12px;"></div>

    <p class="muted" style="margin-top:10px;">
      Les √©quipes se ‚Äúplacent‚Äù automatiquement d√®s qu‚Äôun r√©sultat est valid√©.
    </p>
  </section>

</main>

<style>
  .pill{
    display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px;
    border:1px solid #eee; background:#fafafa; white-space:nowrap;
  }

  /* --- Match cards (responsive) --- */
  .match-card{
    border-radius:16px;
    border:1px solid rgba(0,0,0,.06);
    overflow:hidden;
    background:#fff;
  }
  .match-card.yellow{ background:rgba(255, 221, 87, .22); border-color:rgba(255, 221, 87, .55); }
  .match-card.red{ background:rgba(255, 77, 77, .12); border-color:rgba(255, 77, 77, .28); }

  .match-inner{
    padding:12px;
    display:flex;
    gap:12px;
    align-items:stretch;
  }

  .match-left{ flex:1 1 auto; min-width:0; }

  .match-topline{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
  }

  .when-line{
    display:flex;
    align-items:baseline;
    gap:10px;
    min-width:0;
  }

  .when-time{
    font-weight:1000;
    font-size:20px;
    letter-spacing:.2px;
    white-space:nowrap;
  }

  /* court small, non-bold, single line */
  .when-court{
    font-size:13px;
    font-weight:600;
    opacity:.92;
    font-style:italic;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .status-emoji{
    font-size:18px;
    line-height:1;
    white-space:nowrap;
  }

  .teams{
    margin-top:10px;
    display:grid;
    gap:8px;
  }
  .team-name{
    font-weight:950;
    font-size:18px;
    line-height:1.15;
    word-break:break-word;
  }
  .vsline{
    text-align:center;
    font-weight:900;
    opacity:.55;
    letter-spacing:.25em;
  }

  .match-right{
    width:92px;
    flex:0 0 auto;
    display:flex;
    align-items:stretch;
  }

  .scorebox{
    width:100%;
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.70);
    border-radius:16px;
    padding:10px 10px;
    display:flex;
    flex-direction:column;
    gap:10px;
    justify-content:center;
  }
  .scoreline{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    font-weight:1000;
  }
  .scoreval{
    font-size:18px;
    line-height:1;
    min-width:18px;
    text-align:right;
  }

  .muted-mini{
    font-size:12px;
    opacity:.7;
  }

  @media (max-width: 420px){
    .match-inner{ padding:10px; gap:10px; }
    .when-time{ font-size:18px; }
    .team-name{ font-size:16px; }
    .match-right{ width:86px; }
    .scoreval{ font-size:16px; }
  }
</style>

<script type="module">
  import { db } from "../assets/js/firebase.js";
  import {
    doc, onSnapshot, collection
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const scope = "etape5";

  const statusText = document.getElementById("statusText");
  const subtitle = document.getElementById("subtitle");

  const tabChrono = document.getElementById("tabChrono");
  const tabTableau = document.getElementById("tabTableau");

  const panelChrono = document.getElementById("panelChrono");
  const panelTableau = document.getElementById("panelTableau");

  const chronoCards = document.getElementById("chronoCards");

  const selBracket = document.getElementById("selBracket");
  const selRound = document.getElementById("selRound");
  const tableCards = document.getElementById("tableCards");

  const PROG_REF = doc(db, "programmations", scope);
  const RESULTS_COL = collection(db, `resultats_${scope}`);

  let currentProg = null;
  let resultsByMatch = new Map(); // matchId -> {winnerSide, scoreA, scoreB, score, updatedAt}

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function teamLabel(t){
    if(!t) return "‚Äî";
    return `${t.teamName || "√âquipe"} (${t.p1FirstName || "?"} / ${t.p2FirstName || "?"})`;
  }

  function courtName(courtKey){
    const c = currentProg?.courts || {};
    return c[courtKey] || (courtKey || "‚Äî");
  }

  function courtDecor(courtKey){
    if(courtKey === "A") return { cls:"yellow", emo:"üêù" };
    if(courtKey === "B") return { cls:"red", emo:"üå∂Ô∏è" };
    return { cls:"", emo:"üéæ" };
  }

  function parseHHMM(hhmm){
    const m = String(hhmm || "").match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return null;
    const H = Number(m[1]), M = Number(m[2]);
    if(!Number.isFinite(H) || !Number.isFinite(M)) return null;
    return { H, M };
  }

  function statusEmoji(slotTime, done){
    if(done) return "‚úÖ";
    const p = parseHHMM(slotTime);
    if(!p) return "‚è≥";
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), p.H, p.M, 0, 0);
    return now >= start ? "üü¢" : "‚è≥";
  }

  function roundOptions(bracket){
    if(bracket === "main"){
      return [
        ["QF", "Quarts de finale"],
        ["SF", "Demi-finales"],
        ["3rd", "Match 3e place"],
        ["F", "Finale"]
      ];
    }
    return [
      ["SF", "Demi-finales (5‚Äì8)"],
      ["7th", "Match 7e place"],
      ["5th", "Match 5e place"]
    ];
  }

  function setActiveTab(which){
    const isChrono = which === "chrono";
    panelChrono.style.display = isChrono ? "block" : "none";
    panelTableau.style.display = isChrono ? "none" : "block";

    tabChrono.style.fontWeight = isChrono ? "900" : "800";
    tabTableau.style.fontWeight = isChrono ? "800" : "900";
  }

  // R√©solution des √©quipes (direct / winner / loser)
  function resolveTeamRef(ref){
    if(!currentProg) return null;

    const teams = currentProg.teams || {};
    const matches = currentProg.matches || {};

    if(!ref) return null;

    if(ref.type === "team"){
      return teams[ref.key] || null;
    }

    if(ref.type === "winner" || ref.type === "loser"){
      const mid = ref.matchId;
      const m = matches[mid];
      if(!m) return null;

      const res = resultsByMatch.get(mid);
      if(!res || (res.winnerSide !== "A" && res.winnerSide !== "B")) return null;

      const teamA = resolveTeamRef(m.A);
      const teamB = resolveTeamRef(m.B);

      const winner = (res.winnerSide === "A") ? teamA : teamB;
      const loser  = (res.winnerSide === "A") ? teamB : teamA;

      return ref.type === "winner" ? winner : loser;
    }

    return null;
  }

  function scoreForMatch(mid){
    const r = resultsByMatch.get(mid);
    if(!r) return { A:"‚Äî", B:"‚Äî", done:false };
    const A = (r.scoreA ?? "‚Äî");
    const B = (r.scoreB ?? "‚Äî");
    const done = !!(r.winnerSide === "A" || r.winnerSide === "B");
    return { A, B, done };
  }

  function refreshRounds(){
    const opts = roundOptions(selBracket.value);
    selRound.innerHTML = opts.map(([v, lbl]) => `<option value="${esc(v)}">${esc(lbl)}</option>`).join("");
  }

  function renderChrono(){
    if(!currentProg){
      chronoCards.innerHTML = "";
      return;
    }

    const matches = currentProg.matches || {};
    const slots = Array.isArray(currentProg.slots) ? currentProg.slots : [];
    const schedule = currentProg.schedule || {};

    // slot -> matchId
    const slotToMatch = new Map();
    Object.entries(schedule).forEach(([mid, slotNum])=>{
      slotToMatch.set(Number(slotNum), mid);
    });

    const cards = [];
    for(const s of slots){
      const mid = slotToMatch.get(Number(s.slot));
      const m = mid ? matches[mid] : null;
      if(!m) continue;

      const teamA = resolveTeamRef(m.A);
      const teamB = resolveTeamRef(m.B);

      const aTxt = teamA ? teamLabel(teamA) : (m.A.type === "team" ? m.A.key : (m.A.type === "winner" ? `V${m.A.matchId.slice(1)}` : `P${m.A.matchId.slice(1)}`));
      const bTxt = teamB ? teamLabel(teamB) : (m.B.type === "team" ? m.B.key : (m.B.type === "winner" ? `V${m.B.matchId.slice(1)}` : `P${m.B.matchId.slice(1)}`));

      const courtKey = s.court;
      const courtTxt = courtName(courtKey);
      const deco = courtDecor(courtKey);

      const sc = scoreForMatch(mid);
      const st = statusEmoji(s.time, sc.done);

      cards.push(`
        <div class="match-card ${esc(deco.cls)}">
          <div class="match-inner">
            <div class="match-left">
              <div class="match-topline">
                <div class="when-line">
                  <div class="when-time">${esc(s.time)}</div>
                  <div class="when-court">${esc(deco.emo)} ${esc(courtTxt)} ${esc(deco.emo)}</div>
                </div>
                <div class="status-emoji" title="Statut">${esc(st)}</div>
              </div>

              ${s.note ? `<div class="muted-mini" style="margin-top:6px;">‚ö†Ô∏è ${esc(s.note)}</div>` : ""}

              <div class="teams">
                <div class="team-name">${esc(aTxt)}</div>
                <div class="vsline">VS</div>
                <div class="team-name">${esc(bTxt)}</div>
              </div>
            </div>

            <div class="match-right">
              <div class="scorebox" aria-label="Score">
                <div class="scoreline"><span class="muted-mini">A</span><span class="scoreval">${esc(sc.A)}</span></div>
                <div class="scoreline"><span class="muted-mini">B</span><span class="scoreval">${esc(sc.B)}</span></div>
              </div>
            </div>
          </div>
        </div>
      `);
    }

    chronoCards.innerHTML = cards.join("") || `<div class="muted">Aucun match.</div>`;
  }

  function renderTableau(){
    if(!currentProg){
      tableCards.innerHTML = "";
      return;
    }

    const bracket = selBracket.value;
    const round = selRound.value;

    const matches = currentProg.matches || {};
    const list = Object.values(matches)
      .filter(m => m.bracket === bracket && m.round === round)
      .sort((a,b)=> (a.n||0) - (b.n||0));

    const cards = list.map(m=>{
      // Court/time depuis schedule+slots (si on veut l'afficher ici aussi)
      const schedule = currentProg.schedule || {};
      const slotNum = Number(schedule[m.id] || 0);
      const slot = (Array.isArray(currentProg.slots) ? currentProg.slots : []).find(x => Number(x.slot) === slotNum) || null;

      const time = slot?.time || "";
      const courtKey = slot?.court || "";
      const deco = courtDecor(courtKey);
      const courtTxt = courtKey ? courtName(courtKey) : "";

      const teamA = resolveTeamRef(m.A);
      const teamB = resolveTeamRef(m.B);

      const aTxt = teamA ? teamLabel(teamA) : (m.A.type === "team" ? m.A.key : (m.A.type === "winner" ? `V${m.A.matchId.slice(1)}` : `P${m.A.matchId.slice(1)}`));
      const bTxt = teamB ? teamLabel(teamB) : (m.B.type === "team" ? m.B.key : (m.B.type === "winner" ? `V${m.B.matchId.slice(1)}` : `P${m.B.matchId.slice(1)}`));

      const sc = scoreForMatch(m.id);
      const st = statusEmoji(time, sc.done);

      return `
        <div class="match-card ${esc(deco.cls)}">
          <div class="match-inner">
            <div class="match-left">
              <div class="match-topline">
                <div class="when-line">
                  ${time ? `<div class="when-time">${esc(time)}</div>` : `<div class="when-time">‚Äî</div>`}
                  ${courtTxt ? `<div class="when-court">${esc(deco.emo)} ${esc(courtTxt)} ${esc(deco.emo)}</div>` : `<div class="when-court">${esc(deco.emo)} ‚Äî ${esc(deco.emo)}</div>`}
                </div>
                <div class="status-emoji" title="Statut">${esc(st)}</div>
              </div>

              <div class="teams">
                <div class="team-name">${esc(aTxt)}</div>
                <div class="vsline">VS</div>
                <div class="team-name">${esc(bTxt)}</div>
              </div>
            </div>

            <div class="match-right">
              <div class="scorebox" aria-label="Score">
                <div class="scoreline"><span class="muted-mini">A</span><span class="scoreval">${esc(sc.A)}</span></div>
                <div class="scoreline"><span class="muted-mini">B</span><span class="scoreval">${esc(sc.B)}</span></div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    tableCards.innerHTML = cards.join("") || `<div class="muted">Aucun match pour ce filtre.</div>`;
  }

  function renderAll(){
    renderChrono();
    renderTableau();
  }

  // ---- Tabs UI
  tabChrono.onclick = (e)=>{ e.preventDefault(); setActiveTab("chrono"); };
  tabTableau.onclick = (e)=>{ e.preventDefault(); setActiveTab("tableau"); };

  // ---- Filters
  selBracket.onchange = ()=>{
    refreshRounds();
    renderTableau();
  };
  selRound.onchange = ()=> renderTableau();

  // init UI
  setActiveTab("chrono");
  refreshRounds();
  selRound.value = "QF";

  // ---- Listen results (live)
  onSnapshot(RESULTS_COL, (snap)=>{
    resultsByMatch = new Map();
    snap.forEach(d=>{
      const x = d.data() || {};
      resultsByMatch.set(d.id, {
        winnerSide: x.winnerSide || null,
        score: x.score || "",
        scoreA: x.scoreA ?? null,
        scoreB: x.scoreB ?? null,
        updatedAt: x.updatedAt || null
      });
    });
    renderAll();
  });

  // ---- Listen programmation
  onSnapshot(PROG_REF, (snap)=>{
    currentProg = snap.exists() ? (snap.data() || {}) : null;

    if(!currentProg){
      statusText.textContent = "‚è≥ Programmation non disponible (pas encore g√©n√©r√©e).";
      subtitle.textContent = "";
      panelChrono.style.display = "none";
      panelTableau.style.display = "none";
      return;
    }

    statusText.textContent = "‚úÖ Programmation disponible.";
    subtitle.textContent = "üß© Tableau + üïí Chronologique (mise √† jour en direct).";

    panelChrono.style.display = "block";
    renderAll();
  }, (err)=>{
    console.error(err);
    statusText.textContent = "üî¥ Erreur de connexion √† la programmation.";
  });
</script>

</body>
</html>
