<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Repas</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260221" />
</head>
<body>

<header class="topbar no-print">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">üõ†Ô∏è Admin ‚Äî Gestion</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- ‚úÖ Bandeau identique partout : uniquement ces 2 liens -->
    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<!-- Bandeau imprimable (PDF) -->
<section class="print-header only-print">
  <div class="print-header-inner">
    <img src="../assets/img/logo-suzini.png" alt="Logo Suzini" class="ph-logo">
    <div class="ph-title">
      <div class="ph-h1">Double Mixte Challenge</div>
      <div class="ph-h2" id="printSub">Repas ‚Äî √âtape 1</div>
    </div>
    <img src="../assets/img/logo-challenge.png" alt="Logo Challenge" class="ph-logo">
  </div>
</section>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Encart ZONE (identique √† admin/index) -->
  <section class="card" id="zoneUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üéõÔ∏è Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">G√©n√©ral</option>
        <option value="etape1">√âtape 1</option>
        <option value="etape2">√âtape 2</option>
        <option value="etape3">√âtape 3</option>
        <option value="etape4">√âtape 4</option>
        <option value="etape5">√âtape 5</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- ‚úÖ Contenu de la page (affich√© apr√®s l‚Äôencart Zone) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üçΩÔ∏è Commandes repas ‚Äî r√©cap</h2>

    <p class="muted" style="margin:0;">
      Prix : <b>10‚Ç¨</b> par pack (3 arancini). ‚Äî 1 ligne par beacheur (cumul).
    </p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnPrint" style="font-weight:900; color:#111;">üñ®Ô∏è Exporter PDF</button>
      <button class="btn" id="btnRefresh" style="font-weight:900; color:#111;">üîÑ Actualiser</button>
    </div>

    <p class="muted" id="status" style="margin-top:10px;">Chargement‚Ä¶</p>
  </section>

  <section class="card" id="panelTable" style="display:none;">
    <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin:0 0 10px;">
      <span>üìã Commandes (uniquement les joueurs ayant command√©)</span>
      <span class="muted" style="font-weight:900;">
        Total g√©n√©ral : <span id="grandTotal">0</span> ‚Ç¨
      </span>
    </h2>

    <div class="table-wrap">
      <table class="orders-table" aria-label="Commandes repas">
        <thead>
          <tr>
            <th style="width:44px;">#</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th style="width:140px;">Qt√© (packs)</th>
            <th style="width:140px;">Montant</th>
            <th class="no-print" style="width:140px;">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted no-print" style="margin:10px 0 0;">
      ‚ö†Ô∏è Export PDF : clique ‚ÄúExporter PDF‚Äù, puis ‚ÄúEnregistrer en PDF‚Äù.
    </p>
  </section>

</main>

<style>
  .table-wrap{ overflow:auto; border:1px solid #eee; border-radius:14px; background:#fff; }
  .orders-table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 820px; }
  .orders-table thead th{
    text-align:left; font-size:13px; color:#444; background:#f7f7f7;
    border-bottom:1px solid #eee; padding:12px; position:sticky; top:0; z-index:1;
    white-space:nowrap;
  }
  .orders-table tbody td{ padding:12px; border-bottom:1px solid #f0f0f0; font-size:14px; vertical-align:top; }
  .orders-table tbody tr:last-child td{ border-bottom:none; }

  .btnx{
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-weight:900;
  }
  .btnx:hover{ background:#f5f5f5; }

  /* Print */
  .only-print{ display:none; }
  @media print{
    .no-print{ display:none !important; }
    .only-print{ display:block !important; }
    .container{ max-width: 100% !important; }
    body{ background:#fff !important; }
    .card{ box-shadow:none !important; border:1px solid #eee !important; }
    .table-wrap{ border:1px solid #ddd !important; }
  }

  .print-header{
    background:#1f7a3a;
    color:#fff;
    padding:18px 18px;
  }
  .print-header-inner{
    max-width: 980px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
  }
  .ph-logo{
    width:74px; height:74px; object-fit:contain;
    background:rgba(255,255,255,.10);
    border-radius:14px;
    padding:8px;
  }
  .ph-title{ text-align:center; flex:1; }
  .ph-h1{ font-size:20px; font-weight:1000; letter-spacing:.2px; }
  .ph-h2{ font-size:16px; font-weight:900; opacity:.95; margin-top:4px; }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail, ensurePersistence } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs, query, orderBy,
    doc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  await ensurePersistence();

  // ---- scope (par d√©faut etape1)
  const params = new URLSearchParams(location.search);
  const scope = params.get("scope") || "etape1";
  const stepNum = scope.replace("etape","");
  const stepLabel = `√âtape ${stepNum}`;

  // ‚úÖ Repas pour toutes les √©tapes
  const COL_ORDERS = `repas_${scope}`;

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const zoneUI = document.getElementById("zoneUI");
  const adminUI = document.getElementById("adminUI");
  const panelTable = document.getElementById("panelTable");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const grandTotalEl = document.getElementById("grandTotal");

  const PRICE = 10; // ‚Ç¨ / pack

  // ---- print title
  document.getElementById("printSub").textContent = `Repas ‚Äî ${stepLabel}`;

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  // ‚úÖ Encart Zone (menu + onglets)
  function setTabs(currentScope){
    tabsEl.innerHTML = "";

    if(currentScope === "general"){
      hintEl.textContent = "Zone G√©n√©ral : gestion des infos.";
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html"; // admin landing
      a.textContent = "üì∞ Infos";
      tabsEl.appendChild(a);
      return;
    }

    hintEl.textContent = "Zone √âtape : √©quipes / inscriptions / repas / r√©sultats.";
    const links = [
      ["üë• √âquipes", "equipes.html"],
      ["üìù Inscriptions", "inscriptions.html"],
      ["üçΩÔ∏è Repas", "repas.html"],
      ["üèÅ R√©sultats", "resultats.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(currentScope)}`;
      a.textContent = label;

      // petit ‚Äúhighlight‚Äù sur l‚Äôonglet actif
      if(url === "repas.html"){
        a.setAttribute("aria-current", "page");
      }

      tabsEl.appendChild(a);
    }
  }

  // scope select init + behavior
  scopeEl.value = scope;
  setTabs(scope);

  scopeEl.onchange = ()=>{
    const v = scopeEl.value;
    if(v === "general"){
      window.location.href = "index.html";
      return;
    }
    // rester sur la page repas mais changer de scope
    window.location.href = `repas.html?scope=${encodeURIComponent(v)}`;
  };

  async function loadOrders(){
    statusEl.textContent = "Chargement‚Ä¶";
    tbody.innerHTML = "";
    grandTotalEl.textContent = "0";

    try{
      // tri par nom/pr√©nom (si tes champs existent)
      const q = query(collection(db, COL_ORDERS), orderBy("lastName","asc"), orderBy("firstName","asc"));
      const snap = await getDocs(q);

      // ‚úÖ uniquement ceux qui ont command√©
      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        const qty = Number(x.qty || 0);
        if(!Number.isFinite(qty) || qty <= 0) return;

        const total = Number(x.total ?? (qty * PRICE));
        rows.push({
          id: d.id,
          firstName: x.firstName || "",
          lastName: x.lastName || "",
          qty,
          total: Number.isFinite(total) ? total : (qty * PRICE)
        });
      });

      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:14px;">Aucune commande pour le moment.</td></tr>`;
        statusEl.textContent = "üü¢ OK ‚Äî 0 commande";
        grandTotalEl.textContent = "0";
        return;
      }

      let grand = 0;
      tbody.innerHTML = rows.map((r,i)=>{
        grand += (r.total || 0);
        return `
          <tr>
            <td>#${i+1}</td>
            <td><b>${esc(r.lastName)}</b></td>
            <td>${esc(r.firstName)}</td>
            <td>${esc(String(r.qty))}</td>
            <td><b>${esc(String(r.total))} ‚Ç¨</b></td>
            <td class="no-print">
              <button class="btnx" data-act="edit" data-id="${esc(r.id)}">‚úèÔ∏è Corriger</button>
            </td>
          </tr>
        `;
      }).join("");

      grandTotalEl.textContent = String(grand);
      statusEl.textContent = `üü¢ OK ‚Äî ${rows.length} ligne(s)`;

    }catch(err){
      console.error(err);
      statusEl.textContent = "üî¥ Erreur : impossible de charger les commandes.";
      tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:14px;">Erreur de connexion.</td></tr>`;
      grandTotalEl.textContent = "0";
    }
  }

  async function editLine(docId){
    const typed = prompt("Nouvelle quantit√© (packs ‚Äú3 arancini‚Äù) :", "1");
    if(typed === null) return;

    const q = Number(String(typed).trim());
    if(!Number.isFinite(q) || q < 0){
      alert("Quantit√© invalide.");
      return;
    }

    const total = q * PRICE;

    await setDoc(doc(db, COL_ORDERS, docId), {
      qty: q,
      total: total,
      updatedAt: serverTimestamp()
    }, { merge:true });

    alert("‚úÖ Ligne corrig√©e.");
  }

  // Export PDF = print
  document.getElementById("btnPrint").onclick = (e)=>{
    e.preventDefault();
    window.print();
  };

  document.getElementById("btnRefresh").onclick = async (e)=>{
    e.preventDefault();
    await loadOrders();
  };

  tbody.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;

    const act = btn.dataset.act;
    const id  = btn.dataset.id;

    statusEl.textContent = "Traitement‚Ä¶";
    try{
      if(act === "edit") await editLine(id);
      await loadOrders();
    }catch(err){
      console.error(err);
      statusEl.textContent = "‚ùå Erreur";
      alert("Erreur ‚ùå (voir console)");
    }
  });

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // Guard
  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    zoneUI.style.display = "none";
    adminUI.style.display = "none";
    panelTable.style.display = "none";

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    zoneUI.style.display = "block";
    adminUI.style.display = "block";
    panelTable.style.display = "block";

    await loadOrders();
  });
</script>

</body>
</html>
