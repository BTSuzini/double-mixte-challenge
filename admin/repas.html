<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Repas ‚Äî Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260221" />

  <style>
    /* Bandeau "export PDF" (affich√© aussi √† l'√©cran, et imprim√©) */
    .pdf-banner{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      margin-bottom:14px;
      background: linear-gradient(135deg, #1f7a3a, #165b2b);
      color:#fff;
      box-shadow:0 10px 25px rgba(0,0,0,.10);
    }
    .pdf-banner .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
    }
    .pdf-banner .logo{
      width:54px;
      height:54px;
      border-radius:14px;
      background: rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .pdf-banner .logo img{
      max-width:42px;
      max-height:42px;
      display:block;
    }
    .pdf-banner .title{
      text-align:center;
      min-width:0;
    }
    .pdf-banner .title h2{
      margin:0;
      font-size:18px;
      font-weight:900;
      line-height:1.15;
    }
    .pdf-banner .title p{
      margin:6px 0 0;
      opacity:.95;
      font-weight:700;
    }

    /* Table */
    .table-wrap{
      overflow:auto;
      border:1px solid #eee;
      border-radius:14px;
      background:#fff;
    }
    table.repas{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 780px;
    }
    table.repas thead th{
      text-align:left;
      font-size:13px;
      color:#444;
      background:#f7f7f7;
      border-bottom:1px solid #eee;
      padding:12px 12px;
      position:sticky;
      top:0;
      z-index:1;
      white-space:nowrap;
    }
    table.repas tbody td{
      padding:12px 12px;
      border-bottom:1px solid #f0f0f0;
      vertical-align:top;
      font-size:14px;
    }
    table.repas tbody tr:last-child td{ border-bottom:none; }

    .muted2{ opacity:.9; }
    .num{ font-variant-numeric: tabular-nums; white-space:nowrap; }
    .team{ font-weight:900; }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #eee;
      background:#fafafa;
      color:#333;
      white-space:nowrap;
    }

    /* Print / PDF */
    @media print{
      .topbar, .footer, .no-print { display:none !important; }
      body { background:#fff !important; }
      .container{ max-width: 100% !important; }
      .card{ box-shadow:none !important; border:1px solid #eee !important; }
      .pdf-banner{ box-shadow:none !important; }
      .table-wrap{ border:1px solid #ddd !important; }
      table.repas{ min-width: 0 !important; }
      table.repas thead th{ position:static !important; }
    }
  </style>
</head>
<body>

<header class="topbar no-print">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">üõ†Ô∏è Admin ‚Äî Repas</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="index.html">Admin</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Bandeau imprimable -->
  <section class="pdf-banner">
    <div class="row">
      <div class="logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <div class="title">
        <h2>Double Mixte Challenge ‚Äî Repas</h2>
        <p>Export commandes ‚Ä¢ Offre : 3 arancini = 10‚Ç¨</p>
      </div>

      <div class="logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>
  </section>

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üì¶ R√©capitulatif des commandes</h2>

    <p class="muted" id="status" style="margin:0;">Chargement‚Ä¶</p>

    <div class="grid no-print" style="margin-top:12px;">
      <button class="btn" id="btnPrint" style="font-weight:900; color:#111;">
        üñ®Ô∏è Exporter en PDF
      </button>
      <button class="btn" id="btnRefresh" style="font-weight:900; color:#111;">
        üîÑ Actualiser
      </button>
    </div>

    <hr class="sep" />

    <section class="card" style="margin:0;">
      <h2 style="margin:0 0 8px;">üßæ Totaux</h2>
      <p class="muted" style="margin:0; line-height:1.6;">
        Total lignes : <strong><span id="lineCount">0</span></strong><br>
        Total repas : <strong><span id="totalQty">0</span></strong><br>
        Total ‚Ç¨ : <strong><span id="totalAmount">0</span> ‚Ç¨</strong>
      </p>
      <p class="muted" style="margin:10px 0 0;">
        üí° ‚Äú1 repas‚Äù = 10‚Ç¨ (offre 3 arancini). Le cumul est g√©r√© par doc unique par beacheur.
      </p>
    </section>

    <hr class="sep" />

    <h2 style="margin:0 0 10px;">üìã Liste</h2>

    <div class="table-wrap">
      <table class="repas" aria-label="Commandes repas">
        <thead>
          <tr>
            <th style="width:44px;">#</th>
            <th>√âquipe</th>
            <th>Beacheur</th>
            <th style="width:120px;">Nb repas</th>
            <th style="width:120px;">Montant</th>
            <th style="width:160px;">Cl√©</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail, ensurePersistence } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection,
    getDocs,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const PRICE_PER_REPAS = 10; // 3 arancini = 10‚Ç¨ -> "repas" = 10‚Ç¨

  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");
  const statusEl = document.getElementById("status");

  const lineCountEl = document.getElementById("lineCount");
  const totalQtyEl = document.getElementById("totalQty");
  const totalAmountEl = document.getElementById("totalAmount");

  const tbody = document.getElementById("tbody");

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function money(n){
    try{
      return (n || 0).toLocaleString("fr-FR", { maximumFractionDigits: 0 });
    }catch{
      return String(n || 0);
    }
  }

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  async function loadRepas(){
    statusEl.textContent = "Chargement‚Ä¶";
    tbody.innerHTML = "";

    // On trie par teamName puis pr√©nom (pour un PDF lisible)
    // (Firestore: multi-orderBy ok si index auto -> sinon on simplifie)
    let snap;
    try{
      const q = query(
        collection(db, "repas_etape1"),
        orderBy("teamName", "asc"),
        orderBy("playerFirstName", "asc")
      );
      snap = await getDocs(q);
    }catch(e){
      // fallback sans index composite
      const q = query(collection(db, "repas_etape1"), orderBy("updatedAt", "desc"));
      snap = await getDocs(q);
    }

    const rows = [];
    snap.forEach(d=>{
      const x = d.data() || {};
      rows.push({
        id: d.id,
        teamName: x.teamName || "",
        playerFirstName: x.playerFirstName || "",
        qty: (typeof x.qty === "number") ? x.qty : 0,
        playerKey: x.playerKey || d.id
      });
    });

    // fallback tri c√¥t√© client si besoin
    rows.sort((a,b)=>{
      const ta = (a.teamName || "").localeCompare(b.teamName || "", "fr", { sensitivity:"base" });
      if(ta !== 0) return ta;
      return (a.playerFirstName || "").localeCompare(b.playerFirstName || "", "fr", { sensitivity:"base" });
    });

    let totalQty = 0;
    let totalAmount = 0;

    tbody.innerHTML = rows.length ? rows.map((r, i)=>{
      const amount = (r.qty || 0) * PRICE_PER_REPAS;
      totalQty += (r.qty || 0);
      totalAmount += amount;

      return `
        <tr>
          <td class="num">#${i+1}</td>
          <td class="team">${esc(r.teamName)}</td>
          <td>${esc(r.playerFirstName)}</td>
          <td class="num"><span class="pill">${esc(String(r.qty || 0))}</span></td>
          <td class="num"><span class="pill">${esc(money(amount))} ‚Ç¨</span></td>
          <td class="muted2">${esc(r.playerKey || r.id)}</td>
        </tr>
      `;
    }).join("") : `
      <tr>
        <td colspan="6" class="muted" style="padding:14px;">
          Aucune commande pour le moment.
        </td>
      </tr>
    `;

    lineCountEl.textContent = String(rows.length);
    totalQtyEl.textContent = String(totalQty);
    totalAmountEl.textContent = money(totalAmount);

    statusEl.textContent = "‚úÖ OK";
  }

  // Export PDF (print)
  document.getElementById("btnPrint").onclick = (e)=>{
    e.preventDefault();
    window.print();
  };

  document.getElementById("btnRefresh").onclick = async (e)=>{
    e.preventDefault();
    await loadRepas();
  };

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // Guard
  await ensurePersistence();

  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminUI.style.display = "none";

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    adminUI.style.display = "block";
    await loadRepas();
  });
</script>

</body>
</html>
