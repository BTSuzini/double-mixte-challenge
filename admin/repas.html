<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Repas</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260221" />

  <style>
    .pdf-banner{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      margin-bottom:14px;
      background: linear-gradient(135deg, #1f7a3a, #165b2b);
      color:#fff;
      box-shadow:0 10px 25px rgba(0,0,0,.10);
    }
    .pdf-banner .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
    }
    .pdf-banner .logo{
      width:54px;
      height:54px;
      border-radius:14px;
      background: rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .pdf-banner img{
      max-width:42px;
      max-height:42px;
    }

    .table-wrap{
      overflow:auto;
      border:1px solid #eee;
      border-radius:14px;
      background:#fff;
    }
    table.repas{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 780px;
    }
    table.repas thead th{
      text-align:left;
      font-size:13px;
      background:#f7f7f7;
      border-bottom:1px solid #eee;
      padding:12px;
      position:sticky;
      top:0;
    }
    table.repas tbody td{
      padding:12px;
      border-bottom:1px solid #f0f0f0;
      font-size:14px;
    }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #eee;
      background:#fafafa;
    }

    @media print{
      .topbar, .no-print { display:none !important; }
      body{ background:#fff !important; }
      .card{ box-shadow:none !important; }
      .pdf-banner{ box-shadow:none !important; }
    }
  </style>
</head>
<body>

<header class="topbar no-print">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        üõ†Ô∏è Admin ‚Äî Repas<br>
        <span style="opacity:.95;font-weight:800;" id="pageSub">√âtape ‚Äî</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="index.html">Admin</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Bandeau export -->
  <section class="pdf-banner">
    <div class="row">
      <div class="logo">
        <img src="../assets/img/logo-suzini.png">
      </div>

      <div style="text-align:center;">
        <h2 style="margin:0;" id="pdfTitle">Double Mixte Challenge ‚Äî Repas</h2>
        <p style="margin:6px 0 0;">Offre : 3 arancini = 10‚Ç¨</p>
      </div>

      <div class="logo">
        <img src="../assets/img/logo-challenge.png">
      </div>
    </div>
  </section>

  <section class="card" id="accessDenied" style="display:none;">
    ‚õî Acc√®s refus√©
  </section>

  <section class="card" id="adminUI" style="display:none;">
    <p class="muted" id="status">Chargement‚Ä¶</p>

    <div class="grid no-print" style="margin-top:10px;">
      <button class="btn" id="btnPrint">üñ®Ô∏è Exporter PDF</button>
      <button class="btn" id="btnRefresh">üîÑ Actualiser</button>
    </div>

    <hr class="sep" />

    <h2>üßæ Totaux</h2>
    <p>
      Total lignes : <strong id="lineCount">0</strong><br>
      Total repas : <strong id="totalQty">0</strong><br>
      Total ‚Ç¨ : <strong id="totalAmount">0</strong> ‚Ç¨
    </p>

    <hr class="sep" />

    <h2>üìã Liste</h2>

    <div class="table-wrap">
      <table class="repas">
        <thead>
          <tr>
            <th>#</th>
            <th>√âquipe</th>
            <th>Beacheur</th>
            <th>Nb repas</th>
            <th>Montant</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail, ensurePersistence } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const PRICE = 10;

  // -------- Scope dynamique --------
  const params = new URLSearchParams(location.search);
  const scope = params.get("scope") || "etape1";
  const COL = `repas_${scope}`;

  const stepNum = scope.replace("etape","");
  const stepLabel = `√âtape ${stepNum}`;

  document.getElementById("pageSub").textContent = stepLabel;
  document.getElementById("pdfTitle").textContent =
    `Double Mixte Challenge ‚Äî ${stepLabel} ‚Äî Repas`;

  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const lineCountEl = document.getElementById("lineCount");
  const totalQtyEl = document.getElementById("totalQty");
  const totalAmountEl = document.getElementById("totalAmount");

  function money(n){
    return (n || 0).toLocaleString("fr-FR");
  }

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  async function loadData(){
    statusEl.textContent = "Chargement‚Ä¶";

    const snap = await getDocs(query(collection(db, COL), orderBy("teamName","asc")));

    let rows = [];
    snap.forEach(d=>{
      const x = d.data() || {};
      rows.push({
        teamName: x.teamName || "",
        playerFirstName: x.playerFirstName || "",
        qty: x.qty || 0
      });
    });

    rows.sort((a,b)=>{
      if(a.teamName !== b.teamName)
        return a.teamName.localeCompare(b.teamName);
      return a.playerFirstName.localeCompare(b.playerFirstName);
    });

    let totalQty = 0;
    let totalAmount = 0;

    tbody.innerHTML = rows.map((r,i)=>{
      const amount = r.qty * PRICE;
      totalQty += r.qty;
      totalAmount += amount;

      return `
        <tr>
          <td>#${i+1}</td>
          <td><strong>${r.teamName}</strong></td>
          <td>${r.playerFirstName}</td>
          <td><span class="pill">${r.qty}</span></td>
          <td><span class="pill">${money(amount)} ‚Ç¨</span></td>
        </tr>
      `;
    }).join("");

    lineCountEl.textContent = rows.length;
    totalQtyEl.textContent = totalQty;
    totalAmountEl.textContent = money(totalAmount);

    statusEl.textContent = "‚úÖ OK";
  }

  document.getElementById("btnPrint").onclick = ()=> window.print();
  document.getElementById("btnRefresh").onclick = loadData;

  document.getElementById("btnLogout").onclick = async ()=>{
    await logout();
    window.location.href = "../index.html";
  };

  await ensurePersistence();

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ accessDenied.style.display="block"; return; }
    const ok = await ensureAdmin();
    if(!ok){ accessDenied.style.display="block"; return; }

    adminUI.style.display="block";
    await loadData();
  });
</script>

</body>
</html>
