<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Repas</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260225-repas-admin" />
</head>
<body>

<header class="topbar no-print">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">üè† Accueil public</a>
      <a href="#" id="btnLogout">üö™ D√©connexion</a>
    </nav>
  </div>
</header>

<!-- ‚úÖ Bandeau imprimable (PDF) -->
<section class="print-header only-print">
  <div class="print-header-inner">
    <img src="../assets/img/logo-suzini.png" alt="Logo Suzini" class="ph-logo">
    <div class="ph-title">
      <div class="ph-h1">Double Mixte Challenge</div>
      <div class="ph-h2" id="printSub">Repas ‚Äî √âtape 1</div>
    </div>
    <img src="../assets/img/logo-challenge.png" alt="Logo Challenge" class="ph-logo">
  </div>
</section>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Zone (identique aux autres pages admin) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üß≠ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">üåê G√©n√©ral</option>
        <option value="etape1">üéæ √âtape 1</option>
        <option value="etape2">üéæ √âtape 2</option>
        <option value="etape3">üéæ √âtape 3</option>
        <option value="etape4">üéæ √âtape 4</option>
        <option value="etape5">üß™ √âtape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <!-- ‚úÖ on garde l'√©l√©ment pour compat, mais on n‚Äôaffiche plus de texte -->
    <p class="muted" id="hint" style="margin-top:10px; display:none;"></p>
  </section>

  <!-- Si scope = general -->
  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">‚ÑπÔ∏è Choisir une √©tape</h2>
    <p class="muted" style="margin:0;">
      S√©lectionne une <b>√âtape</b> dans ‚ÄúZone‚Äù pour g√©rer les repas.
      <br>(Le <b>G√©n√©ral</b> se g√®re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <!-- ‚úÖ Contenu Repas -->
  <section class="card" id="panelHead" style="display:none;">
    <h2 style="margin:0 0 10px;">üçΩÔ∏è Commandes repas ‚Äî r√©cap</h2>

    <p class="muted" id="priceHint" style="margin:0;">
      Prix : <b>10‚Ç¨</b> par pack. ‚Äî <b>1 ligne par beacheur</b>.
    </p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnPrint" style="font-weight:900; color:#111;">üñ®Ô∏è Exporter PDF</button>
      <button class="btn" id="btnRefresh" style="font-weight:900; color:#111;">üîÑ Actualiser</button>
    </div>

    <p class="muted" id="status" style="margin-top:10px;">‚Äî</p>
  </section>

  <section class="card" id="panelTable" style="display:none;">
    <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin:0 0 10px;">
      <span>üìã Commandes</span>
      <span class="muted" style="font-weight:900;">
        Total g√©n√©ral : <span id="grandTotal">0</span> ‚Ç¨
      </span>
    </h2>

    <div class="table-wrap">
      <table class="orders-table" aria-label="Commandes repas">
        <thead>
          <tr>
            <th style="width:44px;">#</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th style="width:160px;">Qt√©</th>
            <th style="width:140px;">Montant</th>
            <th class="no-print" style="width:140px;">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted" style="margin:10px 0 0;">
      ‚ö†Ô∏è Export PDF : clique ‚ÄúExporter PDF‚Äù, puis ‚ÄúEnregistrer en PDF‚Äù.
    </p>
  </section>

</main>

<style>
  .table-wrap{ overflow:auto; border:1px solid #eee; border-radius:14px; background:#fff; }
  .orders-table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 860px; }
  .orders-table thead th{
    text-align:left; font-size:13px; color:#444; background:#f7f7f7;
    border-bottom:1px solid #eee; padding:12px; position:sticky; top:0; z-index:1;
    white-space:nowrap;
  }
  .orders-table tbody td{ padding:12px; border-bottom:1px solid #f0f0f0; font-size:14px; vertical-align:top; }
  .orders-table tbody tr:last-child td{ border-bottom:none; }

  .btnx{
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #ddd;
    background:#fff;
    cursor:pointer;
    font-weight:900;
  }
  .btnx:hover{ background:#f5f5f5; }

  /* Print */
  .only-print{ display:none; }
  @media print{
    .no-print{ display:none !important; }
    .only-print{ display:block !important; }
    .container{ max-width: 100% !important; }
    body{ background:#fff !important; }
    .card{ box-shadow:none !important; border:1px solid #eee !important; }
    .table-wrap{ border:1px solid #ddd !important; }
  }

  .print-header{
    background:#1f7a3a;
    color:#fff;
    padding:18px 18px;
  }
  .print-header-inner{
    max-width: 980px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
  }
  .ph-logo{
    width:74px; height:74px; object-fit:contain;
    background:rgba(255,255,255,.10);
    border-radius:14px;
    padding:8px;
  }
  .ph-title{ text-align:center; flex:1; }
  .ph-h1{ font-size:20px; font-weight:1000; letter-spacing:.2px; }
  .ph-h2{ font-size:16px; font-weight:900; opacity:.95; margin-top:4px; }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs,
    doc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const LS_SCOPE_KEY = "admin_scope_last";

  // ---- scope (URL ?scope=etape1) + fallback localStorage
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope");

  function getInitialScope(){
    if(scopeFromUrl) return scopeFromUrl;
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved) return saved;
    }catch(e){}
    return "etape1";
  }

  function persistScope(scope){
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}
  }

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelHead = document.getElementById("panelHead");
  const panelTable = document.getElementById("panelTable");

  const priceHint = document.getElementById("priceHint");
  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const grandTotalEl = document.getElementById("grandTotal");
  const printSub = document.getElementById("printSub");

  const btnPrint = document.getElementById("btnPrint");
  const btnRefresh = document.getElementById("btnRefresh");

  let currentScope = getInitialScope();
  let COL_ORDERS = "";
  let PRICE = 10;

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function isFiniteNonNegInt(n){
    return Number.isFinite(n) && n >= 0 && Math.floor(n) === n;
  }

  function stepLabel(scope){
    if(!scope || scope === "general") return "G√©n√©ral";
    const n = scope.replace("etape","");
    return `√âtape ${n}`;
  }

  function ordersCollectionForScope(scope){
    // ‚úÖ ajuste ici si tu as des exceptions
    // ex: √©tape 1 = repas_etape1
    return `repas_${scope}`; // -> repas_etape1, repas_etape2, ...
  }

  function priceForScope(scope){
    // ‚úÖ au besoin: switch selon √©tape
    // ex: etape1=10, etape2=10...
    return 10;
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";
    if(hintEl) hintEl.style.display = "none";

    if(scope === "general"){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "üì∞ Aller √† Admin ‚Äî Gestion (infos)";
      tabsEl.appendChild(a);
      return;
    }

    if(scope === "etape5"){
      tabsEl.appendChild(makeDisabledBtn("üçΩÔ∏è Repas (plus tard)", "Repas non activ√© pour l‚Äô√©tape 5 (zone test)."));
    }

    const links = [
      ["üë• √âquipes",        "equipes.html"],
      ["üìù Inscriptions",   "inscriptions.html"],
      ...(scope !== "etape5" ? [["üçΩÔ∏è Repas", "repas.html"]] : []),
      ["üé≤ Tirage",         "tirage.html"],
      ["üìÖ Programmation",  "programmation.html"],
      ["üèÅ R√©sultats",      "resultats.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      if(url === "repas.html"){
        a.style.fontWeight = "900";
      }
      tabsEl.appendChild(a);
    }
  }

  function showPanelsForScope(scope){
    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelHead.style.display = "none";
      panelTable.style.display = "none";
      statusEl.textContent = "‚Äî";
      tbody.innerHTML = "";
      grandTotalEl.textContent = "0";
      if(printSub) printSub.textContent = "Repas ‚Äî G√©n√©ral";
      return;
    }

    panelNeedStep.style.display = "none";
    panelHead.style.display = "block";
    panelTable.style.display = "block";
  }

  function parseNameFallback(x){
    const lastName = (x.lastName || "").trim();
    const firstName = (x.firstName || "").trim();
    if(lastName || firstName) return { lastName, firstName };

    let raw = (x.beacheurName || x.beacheur || "").trim();
    if(!raw) return { lastName:"", firstName:"" };

    raw = raw.split("(")[0].trim();
    const parts = raw.split(/\s+/).filter(Boolean);
    if(parts.length >= 2){
      return { firstName: parts.slice(0, -1).join(" "), lastName: parts.slice(-1).join(" ") };
    }
    return { firstName: raw, lastName: "" };
  }

  async function loadOrders(){
    statusEl.textContent = "Chargement‚Ä¶";
    tbody.innerHTML = "";
    grandTotalEl.textContent = "0";

    try{
      const snap = await getDocs(collection(db, COL_ORDERS));

      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        const qty = Number(x.qty || 0);
        const total = Number(x.total ?? (qty * PRICE));

        const name = parseNameFallback(x);

        rows.push({
          id: d.id,
          lastName: (name.lastName || "").trim(),
          firstName: (name.firstName || "").trim(),
          qty: Number.isFinite(qty) ? qty : 0,
          total: Number.isFinite(total) ? total : 0
        });
      });

      const filtered = rows.filter(r => (Number(r.qty) || 0) > 0);

      filtered.sort((a,b)=>{
        const al = (a.lastName || "").toLowerCase();
        const bl = (b.lastName || "").toLowerCase();
        if(al !== bl) return al < bl ? -1 : 1;

        const af = (a.firstName || "").toLowerCase();
        const bf = (b.firstName || "").toLowerCase();
        if(af !== bf) return af < bf ? -1 : 1;

        return 0;
      });

      if(filtered.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:14px;">Aucune commande pour le moment.</td></tr>`;
        statusEl.textContent = "üü¢ OK ‚Äî 0 commande";
        grandTotalEl.textContent = "0";
        return;
      }

      let grand = 0;

      tbody.innerHTML = filtered.map((r,i)=>{
        const t = Number(r.total ?? (r.qty * PRICE)) || 0;
        grand += t;

        return `
          <tr>
            <td>#${i+1}</td>
            <td><b>${esc(r.lastName || "‚Äî")}</b></td>
            <td><b>${esc(r.firstName || "‚Äî")}</b></td>
            <td>${esc(String(r.qty))}</td>
            <td><b>${esc(String(t))} ‚Ç¨</b></td>
            <td class="no-print">
              <button class="btnx" data-act="edit" data-id="${esc(r.id)}">‚úèÔ∏è Corriger</button>
            </td>
          </tr>
        `;
      }).join("");

      grandTotalEl.textContent = String(grand);
      statusEl.textContent = `üü¢ OK ‚Äî ${filtered.length} ligne(s)`;

    }catch(err){
      console.error("LOAD_ORDERS_ERR", err?.code, err?.message, err);
      statusEl.textContent = "üî¥ Erreur : impossible de charger les commandes.";
      tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:14px;">Erreur de connexion.</td></tr>`;
      grandTotalEl.textContent = "0";
    }
  }

  async function editLine(docId){
    const typed = prompt("Nouvelle quantit√© :", "1");
    if(typed === null) return;

    const q = Number(String(typed).trim());
    if(!isFiniteNonNegInt(q)){
      alert("Quantit√© invalide (entier ‚â• 0).");
      return;
    }

    const total = q * PRICE;

    await setDoc(doc(db, COL_ORDERS, docId), {
      qty: q,
      total: total,
      updatedAt: serverTimestamp()
    }, { merge:true });

    alert("‚úÖ Ligne corrig√©e.");
  }

  function applyScope(scope){
    currentScope = (scope || "general").toLowerCase();

    scopeEl.value = currentScope;
    setTabs(currentScope);
    persistScope(currentScope);

    showPanelsForScope(currentScope);

    if(currentScope === "general") return;

    COL_ORDERS = ordersCollectionForScope(currentScope);
    PRICE = priceForScope(currentScope);

    if(priceHint){
      priceHint.innerHTML = `Prix : <b>${esc(String(PRICE))}‚Ç¨</b> par pack. ‚Äî <b>1 ligne par beacheur</b>.`;
    }
    if(printSub){
      printSub.textContent = `Repas ‚Äî ${stepLabel(currentScope)}`;
    }

    loadOrders();
  }

  // Export PDF = print
  btnPrint?.addEventListener("click", (e)=>{
    e.preventDefault();
    window.print();
  });

  btnRefresh?.addEventListener("click", async (e)=>{
    e.preventDefault();
    await loadOrders();
  });

  tbody.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;

    const act = btn.dataset.act;
    const id  = btn.dataset.id;

    statusEl.textContent = "Traitement‚Ä¶";
    try{
      if(act === "edit") await editLine(id);
      await loadOrders();
    }catch(err){
      console.error(err);
      statusEl.textContent = "‚ùå Erreur";
      alert("Erreur ‚ùå (voir console)");
    }
  });

  // logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelHead.style.display = "none";
    panelTable.style.display = "none";
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";
    applyScope(currentScope);

    scopeEl.onchange = ()=>{
      applyScope(scopeEl.value || "general");
    };
  }

  // Guard (m√™me logique que les autres pages)
  const g = await requireRole(["admin"]);
  if(!g.ok){
    showDenied();
  }else{
    showAdmin();
  }

  // robuste si session change
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
