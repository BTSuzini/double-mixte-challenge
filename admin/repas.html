<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Repas</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260221" />
</head>
<body>

<header class="topbar no-print">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title" id="pageTitle">
        Repas (admin)<br><span style="opacity:.95;font-weight:800;" id="pageSub">√âtape ‚Äî</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="#" id="tabEquipes">üë• √âquipes</a>
      <a href="#" id="tabInscriptions">üìù Inscriptions</a>
      <a href="#" id="tabRepas" aria-current="page">üçΩÔ∏è Repas</a>
      <a href="#" id="tabResultats">üèÅ R√©sultats</a>
      <a href="#" id="btnPublic">Vue publique</a>
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<!-- Bandeau imprimable (PDF) -->
<section class="print-header only-print">
  <div class="print-header-inner">
    <img src="../assets/img/logo-suzini.png" alt="Logo Suzini" class="ph-logo">
    <div class="ph-title">
      <div class="ph-h1">Double Mixte Challenge</div>
      <div class="ph-h2" id="printSub">Repas ‚Äî √âtape 1</div>
    </div>
    <img src="../assets/img/logo-challenge.png" alt="Logo Challenge" class="ph-logo">
  </div>
</section>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üçΩÔ∏è Commandes repas ‚Äî r√©cap</h2>

    <p class="muted" style="margin:0;">
      Prix : <b>10‚Ç¨</b> par pack (3 arancini). ‚Äî 1 ligne par beacheur (cumul).
    </p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnPrint" style="font-weight:900; color:#111;">üñ®Ô∏è Exporter PDF</button>
      <button class="btn" id="btnRefresh" style="font-weight:900; color:#111;">üîÑ Actualiser</button>
    </div>

    <p class="muted" id="status" style="margin-top:10px;">Chargement‚Ä¶</p>
  </section>

  <section class="card" id="panelTable" style="display:none;">
    <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin:0 0 10px;">
      <span>üìã Liste compl√®te</span>
      <span class="muted" style="font-weight:900;">
        Total g√©n√©ral : <span id="grandTotal">0</span> ‚Ç¨
      </span>
    </h2>

    <div class="table-wrap">
      <table class="orders-table" aria-label="Commandes repas">
        <thead>
          <tr>
            <th style="width:44px;">#</th>
            <th>Beacheur</th>
            <th>√âquipe</th>
            <th style="width:120px;">Qt√© (packs)</th>
            <th style="width:140px;">Montant</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="muted" style="margin:10px 0 0;">
      ‚ö†Ô∏è Export PDF : clique ‚ÄúExporter PDF‚Äù, puis ‚ÄúEnregistrer en PDF‚Äù.
    </p>
  </section>

</main>

<style>
  .table-wrap{ overflow:auto; border:1px solid #eee; border-radius:14px; background:#fff; }
  .orders-table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 760px; }
  .orders-table thead th{
    text-align:left; font-size:13px; color:#444; background:#f7f7f7;
    border-bottom:1px solid #eee; padding:12px; position:sticky; top:0; z-index:1;
    white-space:nowrap;
  }
  .orders-table tbody td{ padding:12px; border-bottom:1px solid #f0f0f0; font-size:14px; vertical-align:top; }
  .orders-table tbody tr:last-child td{ border-bottom:none; }

  /* Print */
  .only-print{ display:none; }
  @media print{
    .no-print{ display:none !important; }
    .only-print{ display:block !important; }
    .container{ max-width: 100% !important; }
    body{ background:#fff !important; }
    .card{ box-shadow:none !important; border:1px solid #eee !important; }
    .table-wrap{ border:1px solid #ddd !important; }
  }

  .print-header{
    background:#1f7a3a;
    color:#fff;
    padding:18px 18px;
  }
  .print-header-inner{
    max-width: 980px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
  }
  .ph-logo{
    width:74px; height:74px; object-fit:contain;
    background:rgba(255,255,255,.10);
    border-radius:14px;
    padding:8px;
  }
  .ph-title{ text-align:center; flex:1; }
  .ph-h1{ font-size:20px; font-weight:1000; letter-spacing:.2px; }
  .ph-h2{ font-size:16px; font-weight:900; opacity:.95; margin-top:4px; }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- scope (par d√©faut etape1)
  const params = new URLSearchParams(location.search);
  const scope = params.get("scope") || "etape1";
  const stepNum = scope.replace("etape","");
  const stepLabel = `√âtape ${stepNum}`;

  // ---- UI title
  document.getElementById("pageSub").textContent = `${stepLabel} ‚Äî Repas`;
  document.getElementById("printSub").textContent = `Repas ‚Äî ${stepLabel}`;

  // ---- nav keep scope
  document.getElementById("tabEquipes").href = `equipes.html?scope=${encodeURIComponent(scope)}`;
  document.getElementById("tabInscriptions").href = `inscriptions.html?scope=${encodeURIComponent(scope)}`;
  document.getElementById("tabRepas").href = `repas.html?scope=${encodeURIComponent(scope)}`;
  document.getElementById("tabResultats").href = `resultats.html?scope=${encodeURIComponent(scope)}`;

  // Vue publique (ici : etape1/repas.html)
  document.getElementById("btnPublic").onclick = (e)=>{
    e.preventDefault();
    if(scope === "etape1") window.location.href = "../etape1/repas.html";
    else alert("Vue publique non pr√™te pour " + stepLabel);
  };

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");
  const panelTable = document.getElementById("panelTable");

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const grandTotalEl = document.getElementById("grandTotal");

  // ---- collection commandes
  // (pour l‚Äôinstant : uniquement √©tape 1)
  const COL_ORDERS = (scope === "etape1") ? "repas_etape1" : `repas_${scope}`;

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  async function loadOrders(){
    statusEl.textContent = "Chargement‚Ä¶";
    tbody.innerHTML = "";
    grandTotalEl.textContent = "0";

    try{
      const q = query(collection(db, COL_ORDERS), orderBy("beacheurName","asc"));
      const snap = await getDocs(q);

      const rows = [];
      snap.forEach(d=>{
        const x = d.data() || {};
        rows.push({
          beacheurName: x.beacheurName || "",
          teamName: x.teamName || "",
          qty: Number.isFinite(x.qty) ? x.qty : (x.qty || 0),
          total: Number.isFinite(x.total) ? x.total : (x.total || 0)
        });
      });

      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:14px;">Aucune commande pour le moment.</td></tr>`;
        statusEl.textContent = "üü¢ OK ‚Äî 0 commande";
        grandTotalEl.textContent = "0";
        return;
      }

      let grand = 0;
      tbody.innerHTML = rows.map((r,i)=>{
        grand += (r.total || 0);
        return `
          <tr>
            <td>#${i+1}</td>
            <td><b>${esc(r.beacheurName)}</b></td>
            <td>${esc(r.teamName)}</td>
            <td>${esc(String(r.qty))}</td>
            <td><b>${esc(String(r.total))} ‚Ç¨</b></td>
          </tr>
        `;
      }).join("");

      grandTotalEl.textContent = String(grand);
      statusEl.textContent = `üü¢ OK ‚Äî ${rows.length} ligne(s)`;

    }catch(err){
      console.error(err);
      statusEl.textContent = "üî¥ Erreur : impossible de charger les commandes.";
      tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:14px;">Erreur de connexion.</td></tr>`;
      grandTotalEl.textContent = "0";
    }
  }

  // Export PDF = print
  document.getElementById("btnPrint").onclick = (e)=>{
    e.preventDefault();
    window.print();
  };

  document.getElementById("btnRefresh").onclick = async (e)=>{
    e.preventDefault();
    await loadOrders();
  };

  // logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // Guard
  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminUI.style.display = "none";
    panelTable.style.display = "none";

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    adminUI.style.display = "block";
    panelTable.style.display = "block";
    await loadOrders();
  });
</script>

</body>
</html>
