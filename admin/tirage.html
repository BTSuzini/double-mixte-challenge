<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Tirage</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260222" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        ğŸ² Tirage (admin)<br>
        <span style="opacity:.95;font-weight:800;" id="pageSub">Ã‰tape â€”</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- âœ… Bandeau identique partout -->
    <nav class="nav">
      <a href="../index.html">ğŸ  Accueil public</a>
      <a href="#" id="btnLogout">ğŸšª DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Zone (identique partout) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§­ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">ğŸŒ GÃ©nÃ©ral</option>
        <option value="etape1">ğŸ¾ Ã‰tape 1</option>
        <option value="etape2">ğŸ¾ Ã‰tape 2</option>
        <option value="etape3">ğŸ¾ Ã‰tape 3</option>
        <option value="etape4">ğŸ¾ Ã‰tape 4</option>
        <option value="etape5">ğŸ§ª Ã‰tape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- si general -->
  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">â„¹ï¸ Choisir une Ã©tape</h2>
    <p class="muted" style="margin:0;">
      SÃ©lectionne une <b>Ã‰tape</b> dans â€œZoneâ€ pour gÃ©rer le tirage.
      <br>(Le <b>GÃ©nÃ©ral</b> se gÃ¨re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <!-- CONTENU TIRAGE -->
  <section class="card" id="panelControl" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ² Tirage au sort â€” contrÃ´le admin</h2>

    <p class="muted" id="status" style="margin:0;">Chargementâ€¦</p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnLoad" style="font-weight:900; color:#111;">ğŸ”„ Charger Ã©quipes (liste principale)</button>
      <button class="btn" id="btnStart" style="font-weight:900; color:#111;">â–¶ï¸ Lancer le tirage</button>
      <button class="btn" id="btnNext" style="font-weight:900; color:#111;">ğŸ° Tirer la prochaine Ã©quipe</button>
      <button class="btn" id="btnValidate" style="font-weight:900; color:#111;">âœ… Valider le tirage</button>
      <button class="btn" id="btnReset" style="font-weight:900; color:#111; border-color:#f1b2b2;">ğŸ§¨ RÃ©initialiser</button>
    </div>

    <p class="muted" style="margin-top:10px;">
      RÃ¨gle : TS1 et TS2 = meilleures Ã©quipes (classement Ã©quipe le plus petit).<br>
      Puis 6 tirÃ©es au sort : 1Ã¨re vs TS1, 2e vs 3e, 4e vs 5e, 6e vs TS2.
    </p>
  </section>

  <section class="card" id="panelPreview" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ“Œ AperÃ§u</h2>

    <div class="grid">
      <div class="card" style="margin:0;">
        <div style="font-weight:1000;">ğŸ·ï¸ TÃªte de sÃ©rie #1</div>
        <div class="muted" id="seed1">â€”</div>
      </div>
      <div class="card" style="margin:0;">
        <div style="font-weight:1000;">ğŸ·ï¸ TÃªte de sÃ©rie #2</div>
        <div class="muted" id="seed2">â€”</div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ° Roulette (admin)</div>
      <div class="roulette-wheel" id="wheel">â€”</div>
      <div class="muted" id="wheelSub" style="margin-top:8px;">â€”</div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ“¥ Urne (6 Ã©quipes)</div>
      <div id="poolList" style="display:grid; gap:8px;"></div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ“Œ Tirages rÃ©vÃ©lÃ©s</div>
      <div id="revealedList" style="display:grid; gap:8px;"></div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ§¾ Matchs (prÃ©vision)</div>
      <div id="matchesBox" class="muted">â€”</div>
    </div>
  </section>

</main>

<style>
  .roulette-wheel{
    height:68px;
    border-radius:14px;
    border:1px solid #e6e6e6;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:1000;
    font-size:18px;
    letter-spacing:.2px;
    background:linear-gradient(180deg,#fff,#fafafa);
  }
  .pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #eee;
    background:#fafafa;
    white-space:nowrap;
  }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs, query, orderBy,
    doc, getDoc, setDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const LS_SCOPE_KEY = "admin_scope_last";

  // ---- scope (URL ?scope=...) + fallback LS
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope");

  function getInitialScope(){
    if(scopeFromUrl) return scopeFromUrl;
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved) return saved;
    }catch(e){}
    return "etape5"; // par dÃ©faut : test
  }
  function persistScope(scope){
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}
  }

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");
  const pageSub = document.getElementById("pageSub");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelControl  = document.getElementById("panelControl");
  const panelPreview  = document.getElementById("panelPreview");

  const statusEl = document.getElementById("status");
  const seed1El = document.getElementById("seed1");
  const seed2El = document.getElementById("seed2");
  const poolList = document.getElementById("poolList");
  const revealedList = document.getElementById("revealedList");
  const matchesBox = document.getElementById("matchesBox");

  const wheel = document.getElementById("wheel");
  const wheelSub = document.getElementById("wheelSub");

  const btnLoad = document.getElementById("btnLoad");
  const btnStart = document.getElementById("btnStart");
  const btnNext = document.getElementById("btnNext");
  const btnValidate = document.getElementById("btnValidate");
  const btnReset = document.getElementById("btnReset");

  // ---- state
  let currentScope = getInitialScope();
  let cachedMainTeams = []; // 8 Ã©quipes main
  let draw = null;

  function stepLabel(scope){
    if(!scope || scope === "general") return "GÃ©nÃ©ral";
    const n = scope.replace("etape","");
    return `Ã‰tape ${n}`;
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      hintEl.textContent = "ğŸŒ Zone GÃ©nÃ©ral : admin/index.html";
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "ğŸ“° Aller Ã  Admin â€” Gestion (infos)";
      tabsEl.appendChild(a);
      return;
    }

    hintEl.textContent = "ğŸ¾ Zone Ã‰tape : Ã©quipes / inscriptions / tirage / programmation / rÃ©sultats.";

    if(scope === "etape5"){
      tabsEl.appendChild(makeDisabledBtn("ğŸ½ï¸ Repas (plus tard)", "Repas non activÃ© pour lâ€™Ã©tape 5 (zone test)."));
    }

    const links = [
      ["ğŸ‘¥ Ã‰quipes",        "equipes.html"],
      ["ğŸ“ Inscriptions",   "inscriptions.html"],
      ...(scope !== "etape5" ? [["ğŸ½ï¸ Repas", "repas.html"]] : []),
      ["ğŸ² Tirage",         "tirage.html"],
      ["ğŸ“… Programmation",  "programmation.html"],
      ["ğŸ RÃ©sultats",      "resultats.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;
      if(url === "tirage.html") a.style.fontWeight = "900";
      tabsEl.appendChild(a);
    }
  }

  function showPanelsForScope(scope){
    pageSub.textContent = (scope === "general")
      ? "GÃ©nÃ©ral"
      : `${stepLabel(scope)} â€” BT250`;

    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelControl.style.display = "none";
      panelPreview.style.display = "none";
      return;
    }

    panelNeedStep.style.display = "none";
    panelControl.style.display = "block";
    panelPreview.style.display = "block";
  }

  function uiSet(msg){ statusEl.textContent = msg; }

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function toNum(v){
    if(v === null || v === undefined || v === "") return null;
    const n = typeof v === "number" ? v : Number(String(v).replace(",", ".").trim());
    return Number.isFinite(n) ? n : null;
  }

  function calcTeamRank(t){
    const a = toNum(t.p1Rank);
    const b = toNum(t.p2Rank);
    if(a === null || b === null) return Number.POSITIVE_INFINITY; // non renseignÃ© => en bas
    return a + b;
  }

  function teamLabel(t){
    if(!t) return "â€”";
    const tn = t.teamName || "Ã‰quipe";
    const p1 = t.p1FirstName || "?";
    const p2 = t.p2FirstName || "?";
    return `${tn} (${p1} / ${p2})`;
  }

  function drawDocRef(){
    return doc(db, "tirages", currentScope); // tirages/etape5
  }

  function colPublicTeams(){
    return `equipes_${currentScope}_public`; // equipes_etape5_public
  }

  async function readDraw(){
    const s = await getDoc(drawDocRef());
    draw = s.exists() ? (s.data() || {}) : null;
    return draw;
  }

  function setButtons(){
    const st = draw?.status || "idle";

    const canOperate = (currentScope !== "general");
    btnLoad.disabled = !canOperate;

    btnStart.disabled = !canOperate || !(cachedMainTeams.length === 8) || (st === "running" || st === "pending_validation" || st === "validated");
    btnNext.disabled  = !canOperate || !(st === "running") || (Number(draw?.revealed || 0) >= 6);
    btnValidate.disabled = !canOperate || !(st === "pending_validation");
    btnReset.disabled = !canOperate;
  }

  function renderPreviewFromData(ts1, ts2, pool, revealedIds){
    seed1El.textContent = ts1 ? `${teamLabel(ts1)}${Number.isFinite(ts1.teamRank) ? ` â€” rank Ã©quipe: ${ts1.teamRank}` : ""}` : "â€”";
    seed2El.textContent = ts2 ? `${teamLabel(ts2)}${Number.isFinite(ts2.teamRank) ? ` â€” rank Ã©quipe: ${ts2.teamRank}` : ""}` : "â€”";

    poolList.innerHTML = pool?.length
      ? pool.map(p=> `
        <div class="card" style="margin:0;">
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div><b>${esc(teamLabel(p))}</b></div>
            <span class="pill">urne</span>
          </div>
        </div>
      `).join("")
      : `<div class="muted">â€”</div>`;

    const shown = revealedIds || [];
    revealedList.innerHTML = shown.length
      ? shown.map((t, i)=> `
        <div class="card" style="margin:0;">
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div><b>#${i+1}</b> â€” ${esc(teamLabel(t))}</div>
            <span class="pill">tirÃ©e</span>
          </div>
        </div>
      `).join("")
      : `<div class="muted">En attenteâ€¦</div>`;

    wheel.textContent = "â€”";
    wheelSub.textContent = "â€”";
  }

  function computeMatches(seed1, seed2, picks){
    // picks = [t1..t6] dans lâ€™ordre
    const m = [];
    if(seed1 && picks[0]) m.push({ a: picks[0], b: seed1, label: "Match 1" });
    if(picks[1] && picks[2]) m.push({ a: picks[1], b: picks[2], label: "Match 2" });
    if(picks[3] && picks[4]) m.push({ a: picks[3], b: picks[4], label: "Match 3" });
    if(seed2 && picks[5]) m.push({ a: picks[5], b: seed2, label: "Match 4" });
    return m;
  }

  function renderMatches(seed1, seed2, poolById, order, revealedCount){
    const ids = order.slice(0, Math.min(revealedCount, 6));
    const picks = ids.map(id => poolById.get(id)).filter(Boolean);

    const matches = computeMatches(seed1, seed2, picks);
    if(matches.length === 0){
      matchesBox.innerHTML = "â€”";
      return;
    }
    matchesBox.innerHTML = matches.map(x => {
      return `<div style="margin-bottom:6px;"><b>${esc(x.label)}</b> : ${esc(teamLabel(x.a))} <span class="muted">vs</span> ${esc(teamLabel(x.b))}</div>`;
    }).join("");
  }

  async function loadMainTeams(){
    if(currentScope === "general"){
      alert("Choisis une Ã©tape.");
      return;
    }

    uiSet("Chargement Ã©quipesâ€¦");

    const snap = await getDocs(query(collection(db, colPublicTeams()), orderBy("createdAt","asc")));

    const rows = [];
    snap.forEach(d=>{
      const x = d.data() || {};
      const isMain = (x.list === "main") && (x.stby !== true);
      if(!isMain) return;

      const t = {
        id: d.id,
        teamName: x.teamName || "",
        p1FirstName: x.p1FirstName || "",
        p2FirstName: x.p2FirstName || "",
        p1Rank: x.p1Rank ?? null,
        p2Rank: x.p2Rank ?? null
      };
      t.teamRank = calcTeamRank(t);
      rows.push(t);
    });

    cachedMainTeams = rows;

    if(rows.length !== 8){
      uiSet(`âš ï¸ Liste principale dÃ©tectÃ©e = ${rows.length} Ã©quipe(s). Il en faut 8 (list=main, stby=false).`);
      renderPreviewFromData(null, null, rows, []);
      matchesBox.innerHTML = "â€”";
      setButtons();
      return;
    }

    rows.sort((a,b)=> a.teamRank - b.teamRank);

    const ts1 = rows[0];
    const ts2 = rows[1];
    const pool = rows.slice(2);

    uiSet("âœ… Ã‰quipes chargÃ©es. (TS1/TS2 auto + urne 6 Ã©quipes)");
    renderPreviewFromData(ts1, ts2, pool, []);
    matchesBox.innerHTML = "â€”";
    setButtons();
  }

  function randomShuffle(arr){
    const a = arr.slice();
    const rand = (n)=>{
      const u = new Uint32Array(1);
      crypto.getRandomValues(u);
      return u[0] % n;
    };
    for(let i=a.length-1;i>0;i--){
      const j = rand(i+1);
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  async function startDraw(){
    if(currentScope === "general"){
      alert("Choisis une Ã©tape.");
      return;
    }

    if(cachedMainTeams.length !== 8){
      alert("Charge dâ€™abord les Ã©quipes (8 en liste principale).");
      return;
    }

    // TS1/TS2/pool
    const rows = cachedMainTeams.slice().sort((a,b)=> calcTeamRank(a) - calcTeamRank(b));
    const ts1 = rows[0];
    const ts2 = rows[1];
    const pool = rows.slice(2);

    const order = randomShuffle(pool.map(x => x.id)); // 6 ids

    const payload = {
      scope: currentScope,
      status: "running",
      seed1: { id: ts1.id, teamName: ts1.teamName, p1FirstName: ts1.p1FirstName, p2FirstName: ts1.p2FirstName, teamRank: calcTeamRank(ts1) },
      seed2: { id: ts2.id, teamName: ts2.teamName, p1FirstName: ts2.p1FirstName, p2FirstName: ts2.p2FirstName, teamRank: calcTeamRank(ts2) },
      pool: pool.map(p => ({ id:p.id, teamName:p.teamName, p1FirstName:p.p1FirstName, p2FirstName:p.p2FirstName, teamRank: calcTeamRank(p) })),
      order,
      revealed: 0,
      revealedAtMs: [],
      createdAt: serverTimestamp(),
      validatedAt: null
    };

    await setDoc(drawDocRef(), payload, { merge:true });
    await readDraw();

    uiSet("â–¶ï¸ Tirage lancÃ©. Clique â€œTirer la prochaine Ã©quipeâ€.");
    setButtons();

    renderPreviewFromData(draw.seed1, draw.seed2, draw.pool, []);
    matchesBox.innerHTML = "â€”";
  }

  async function rouletteSpin(finalText, durationMs = 1300){
    const start = Date.now();
    wheelSub.textContent = "La roulette tourneâ€¦";
    const fake = ["ğŸŒªï¸", "ğŸ¾", "ğŸ”¥", "ğŸ€", "âš¡ï¸", "ğŸ²", "ğŸ–ï¸", "ğŸ‡®ğŸ‡¹"];

    return new Promise((resolve) => {
      const tick = () => {
        const t = Date.now() - start;
        if(t >= durationMs){
          wheel.textContent = finalText;
          wheelSub.textContent = "âœ… RÃ©vÃ©lÃ©";
          resolve();
          return;
        }
        wheel.textContent =
          fake[Math.floor(Math.random()*fake.length)] + " " +
          fake[Math.floor(Math.random()*fake.length)];
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  async function nextPick(){
    await readDraw();

    if(!draw || draw.status !== "running"){
      alert("Le tirage nâ€™est pas en cours.");
      return;
    }

    const order = draw.order || [];
    const pool = draw.pool || [];
    const poolById = new Map(pool.map(x => [x.id, x]));
    const revealed = Number(draw.revealed || 0);

    if(revealed >= 6){
      alert("Les 6 Ã©quipes ont dÃ©jÃ  Ã©tÃ© tirÃ©es.");
      return;
    }

    const id = order[revealed];
    const t = poolById.get(id);

    await rouletteSpin(teamLabel(t), 1300);

    const newRevealed = revealed + 1;
    const revealedAtMs = Array.isArray(draw.revealedAtMs) ? draw.revealedAtMs.slice() : [];
    revealedAtMs.push(Date.now());

    await updateDoc(drawDocRef(), {
      revealed: newRevealed,
      revealedAtMs
    });

    await readDraw();

    // render revealed
    const shownIds = (draw.order || []).slice(0, Math.min(draw.revealed || 0, 6));
    const shownTeams = shownIds.map(x => poolById.get(x)).filter(Boolean);

    revealedList.innerHTML = shownTeams.length
      ? shownTeams.map((tt, i)=> `
        <div class="card" style="margin:0;">
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div><b>#${i+1}</b> â€” ${esc(teamLabel(tt))}</div>
            <span class="pill">tirÃ©e</span>
          </div>
        </div>
      `).join("")
      : `<div class="muted">En attenteâ€¦</div>`;

    renderMatches(draw.seed1, draw.seed2, poolById, draw.order || [], Number(draw.revealed || 0));

    if(newRevealed >= 6){
      await updateDoc(drawDocRef(), { status: "pending_validation" });
      await readDraw();
      uiSet("â³ Tirage terminÃ© â€” clique â€œValider le tirageâ€.");
    }else{
      uiSet(`ğŸ° Tirage #${newRevealed} effectuÃ©.`);
    }

    setButtons();
  }

  async function validateDraw(){
    const ok = confirm("Valider le tirage ?\n\nLe public verra le tirage VALIDÃ‰ + date/heure, et pourra lancer le replay.");
    if(!ok) return;

    await updateDoc(drawDocRef(), {
      status: "validated",
      validatedAt: serverTimestamp()
    });

    await readDraw();
    uiSet("âœ… Tirage validÃ©.");
    setButtons();
  }

  async function resetDraw(){
    const ok1 = confirm("âš ï¸ RÃ©initialiser le tirage ?\n\nCela efface lâ€™Ã©tat du tirage pour cette Ã©tape.");
    if(!ok1) return;

    const typed = prompt('Tape exactement : RESET');
    if(typed !== "RESET"){
      alert("AnnulÃ©.");
      return;
    }

    await setDoc(drawDocRef(), {
      scope: currentScope,
      status: "idle",
      seed1: null,
      seed2: null,
      pool: [],
      order: [],
      revealed: 0,
      revealedAtMs: [],
      createdAt: serverTimestamp(),
      validatedAt: null
    }, { merge:true });

    await readDraw();
    uiSet("ğŸ§¼ Tirage rÃ©initialisÃ©.");

    cachedMainTeams = [];
    renderPreviewFromData(null, null, [], []);
    matchesBox.innerHTML = "â€”";
    setButtons();
  }

  // Buttons
  btnLoad.onclick = async (e)=>{ e.preventDefault(); await loadMainTeams(); };
  btnStart.onclick = async (e)=>{ e.preventDefault(); await startDraw(); };
  btnNext.onclick = async (e)=>{ e.preventDefault(); await nextPick(); };
  btnValidate.onclick = async (e)=>{ e.preventDefault(); await validateDraw(); };
  btnReset.onclick = async (e)=>{ e.preventDefault(); await resetDraw(); };

  // Logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelControl.style.display = "none";
    panelPreview.style.display = "none";
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    scopeEl.value = currentScope;
    persistScope(currentScope);

    setTabs(currentScope);
    showPanelsForScope(currentScope);

    scopeEl.onchange = async ()=>{
      currentScope = scopeEl.value || "general";
      persistScope(currentScope);

      setTabs(currentScope);
      showPanelsForScope(currentScope);

      // reset UI state on scope change
      cachedMainTeams = [];
      draw = null;
      uiSet("âœ… Admin prÃªt. 1) Charger Ã©quipes, 2) Lancer, 3) Tirer x6, 4) Valider.");
      renderPreviewFromData(null, null, [], []);
      matchesBox.innerHTML = "â€”";
      setButtons();

      if(currentScope !== "general"){
        await readDraw();
        setButtons();
        // si dÃ©jÃ  un tirage existant
        if(draw?.seed1 || draw?.seed2){
          const poolById = new Map((draw.pool || []).map(x => [x.id, x]));
          const shownIds = (draw.order || []).slice(0, Math.min(draw.revealed || 0, 6));
          const shownTeams = shownIds.map(id => poolById.get(id)).filter(Boolean);
          renderPreviewFromData(draw.seed1, draw.seed2, draw.pool || [], shownTeams);
          renderMatches(draw.seed1, draw.seed2, poolById, draw.order || [], Number(draw.revealed || 0));
        }
      }
    };
  }

  // Guard admin (comme tes autres pages)
  const g = await requireRole(["admin"]);
  if(!g.ok){
    showDenied();
  }else{
    showAdmin();
    if(currentScope !== "general"){
      await readDraw();
      setButtons();
      uiSet("âœ… Admin prÃªt. 1) Charger Ã©quipes, 2) Lancer, 3) Tirer x6, 4) Valider.");
    }else{
      uiSet("Choisis une Ã©tape.");
      setButtons();
    }
  }

  // robuste si session change
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
