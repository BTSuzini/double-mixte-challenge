<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Tirage</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260225-admin-tirage" />

  <style>
    /* âœ… Onglet actif noir/blanc (tabs Zone) */
    .btn.is-active{
      background:#111 !important;
      border-color:#111 !important;
      color:#fff !important;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }

    .roulette-wheel{
      height:68px;
      border-radius:14px;
      border:1px solid #e6e6e6;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size:18px;
      letter-spacing:.2px;
      background:linear-gradient(180deg,#fff,#fafafa);
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #eee;
      background:#fafafa;
      white-space:nowrap;
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">ğŸ  Accueil public</a>
      <a href="#" id="btnLogout">ğŸšª DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Zone (identique partout) -->
  <section class="card" id="adminZone" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§­ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">ğŸŒ GÃ©nÃ©ral</option>
        <option value="etape1">ğŸ¾ Ã‰tape 1</option>
        <option value="etape2">ğŸ¾ Ã‰tape 2</option>
        <option value="etape3">ğŸ¾ Ã‰tape 3</option>
        <option value="etape4">ğŸ¾ Ã‰tape 4</option>
        <option value="etape5">ğŸ§ª Ã‰tape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <!-- âœ… pas de texte sous les onglets -->
    <p class="muted" id="hint" style="margin-top:10px; display:none;"></p>
  </section>

  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">â„¹ï¸ Choisir une Ã©tape</h2>
    <p class="muted" style="margin:0;">
      SÃ©lectionne une <b>Ã‰tape</b> dans â€œZoneâ€ pour gÃ©rer le tirage.
      <br>(Le <b>GÃ©nÃ©ral</b> se gÃ¨re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <!-- âœ… UI Tirage -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ² Tirage au sort â€” contrÃ´le admin</h2>

    <p class="muted" id="status" style="margin:0;">Chargementâ€¦</p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnLoad" style="font-weight:900; color:#111;">ğŸ”„ Charger Ã©quipes (liste principale)</button>
      <button class="btn" id="btnStart" style="font-weight:900; color:#111;">â–¶ï¸ Lancer le tirage</button>
      <button class="btn" id="btnNext" style="font-weight:900; color:#111;">ğŸ° Tirer la prochaine Ã©quipe</button>
      <button class="btn" id="btnValidate" style="font-weight:900; color:#111;">âœ… Valider le tirage</button>
      <button class="btn" id="btnReset" style="font-weight:900; color:#111; border-color:#f1b2b2;">ğŸ§¨ RÃ©initialiser</button>
      <a class="btn" id="btnPublic" href="#" style="font-weight:900; color:#111; text-align:center;">ğŸ‘€ Vue publique</a>
    </div>

    <p class="muted" style="margin-top:10px;">
      RÃ¨gle : TS1 et TS2 = meilleures Ã©quipes (classement Ã©quipe le plus petit).<br>
      Puis 6 tirÃ©es au sort : 1Ã¨re vs TS1, 2e vs 3e, 4e vs 5e, 6e vs TS2.
    </p>
  </section>

  <section class="card" id="panel" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ“Œ AperÃ§u</h2>

    <div class="grid">
      <div class="card" style="margin:0;">
        <div style="font-weight:1000;">ğŸ·ï¸ TÃªte de sÃ©rie #1</div>
        <div class="muted" id="seed1">â€”</div>
      </div>
      <div class="card" style="margin:0;">
        <div style="font-weight:1000;">ğŸ·ï¸ TÃªte de sÃ©rie #2</div>
        <div class="muted" id="seed2">â€”</div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ° Roulette (admin)</div>
      <div class="roulette-wheel" id="wheel">â€”</div>
      <div class="muted" id="wheelSub" style="margin-top:8px;">â€”</div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ“¥ Urne (Ã©quipes restantes)</div>
      <div id="poolList" style="display:grid; gap:8px;"></div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:1000; margin-bottom:8px;">ğŸ“Œ Tirages rÃ©vÃ©lÃ©s</div>
      <div id="revealedList" style="display:grid; gap:8px;"></div>
    </div>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs, query, orderBy,
    doc, getDoc, setDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const LS_SCOPE_KEY = "admin_scope_last";

  // ---- scope (URL ?scope=etape1) + fallback localStorage
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope");

  function getInitialScope(){
    if(scopeFromUrl) return scopeFromUrl;
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved) return saved;
    }catch(e){}
    return "etape1";
  }
  function persistScope(scope){
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}
  }

  // ---- DOM Zone
  const accessDenied = document.getElementById("accessDenied");
  const adminZone = document.getElementById("adminZone");
  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const adminUI = document.getElementById("adminUI");
  const panel = document.getElementById("panel");

  // ---- DOM Tirage
  const statusEl = document.getElementById("status");
  const seed1El = document.getElementById("seed1");
  const seed2El = document.getElementById("seed2");
  const poolList = document.getElementById("poolList");
  const revealedList = document.getElementById("revealedList");
  const wheel = document.getElementById("wheel");
  const wheelSub = document.getElementById("wheelSub");

  const btnLoad = document.getElementById("btnLoad");
  const btnStart = document.getElementById("btnStart");
  const btnNext = document.getElementById("btnNext");
  const btnValidate = document.getElementById("btnValidate");
  const btnReset = document.getElementById("btnReset");
  const btnPublic = document.getElementById("btnPublic");

  // ---- state
  let currentScope = getInitialScope();

  // data
  let cachedMainTeams = [];
  let draw = null;

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "ğŸ“° Aller Ã  Admin â€” GÃ©nÃ©ral";
      tabsEl.appendChild(a);
      return;
    }

    if(scope === "etape5"){
      tabsEl.appendChild(makeDisabledBtn("ğŸ½ï¸ Repas (plus tard)", "Repas non activÃ© pour lâ€™Ã©tape 5 (zone test)."));
    }

    const links = [
      ["ğŸ‘¥ Ã‰quipes",        "equipes.html"],
      ["ğŸ“ Inscriptions",   "inscriptions.html"],
      ...(scope !== "etape5" ? [["ğŸ½ï¸ Repas", "repas.html"]] : []),
      ["ğŸ² Tirage",         "tirage.html"],
      ["ğŸ“… Programmation",  "programmation.html"],
      ["ğŸ RÃ©sultats",      "resultats.html"],
      ["ğŸ† Classement",     "classement.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      if(url === "tirage.html"){
        a.classList.add("is-active"); // âœ… onglet actif noir/blanc
      }
      tabsEl.appendChild(a);
    }
  }

  function showPanelsForScope(scope){
    if(scope === "general"){
      panelNeedStep.style.display = "block";
      adminUI.style.display = "none";
      panel.style.display = "none";
      statusEl.textContent = "â€”";
      return;
    }

    panelNeedStep.style.display = "none";
    adminUI.style.display = "block";
    panel.style.display = "block";
  }

  function uiSet(msg){ statusEl.textContent = msg; }

  // ---- Firestore refs (dynamiques selon scope)
  function COL_PUBLIC(scope){ return `equipes_${scope}_public`; }
  function DRAW_REF(scope){ return doc(db, "tirages", scope); }

  function toNum(v){
    if(v === null || v === undefined || v === "") return null;
    const n = typeof v === "number" ? v : Number(String(v).replace(",", ".").trim());
    return Number.isFinite(n) ? n : null;
  }

  function teamRank(t){
    const a = toNum(t.p1Rank);
    const b = toNum(t.p2Rank);
    if(a === null || b === null) return Number.POSITIVE_INFINITY;
    return a + b;
  }

  function teamLabel(t){
    if(!t) return "â€”";
    return `${t.teamName || "Ã‰quipe"} (${t.p1FirstName || "?"} / ${t.p2FirstName || "?"})`;
  }

  async function readDraw(){
    if(currentScope === "general"){ draw = null; return null; }
    const s = await getDoc(DRAW_REF(currentScope));
    draw = s.exists() ? (s.data() || {}) : null;
    return draw;
  }

  function drawHasUrn(d){
    return !!(d && d.seed1 && d.seed2 && Array.isArray(d.pool) && d.pool.length === 6);
  }

  function setButtons(){
    if(currentScope === "general"){
      btnLoad.disabled = true;
      btnStart.disabled = true;
      btnNext.disabled = true;
      btnValidate.disabled = true;
      btnReset.disabled = true;
      return;
    }

    const st = draw?.status || "idle";
    const okUrn = (cachedMainTeams.length >= 8) || drawHasUrn(draw);

    btnLoad.disabled = false;
    btnStart.disabled = !okUrn || (st === "running" || st === "pending_validation" || st === "validated");
    btnNext.disabled = !(st === "running") || ((draw?.revealed || 0) >= 6);
    btnValidate.disabled = !(st === "pending_validation");
    btnReset.disabled = false;
  }

  function randomShuffle(arr){
    const a = arr.slice();
    const rand = (n)=>{
      const u = new Uint32Array(1);
      crypto.getRandomValues(u);
      return u[0] % n;
    };
    for(let i=a.length-1;i>0;i--){
      const j = rand(i+1);
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function pickTeamsFromDraw(d){
    const order = d?.order || [];
    const pool = d?.pool || [];
    const poolById = new Map(pool.map(x => [x.id, x]));
    const revealed = Number(d?.revealed || 0);

    const revealedIds = order.slice(0, revealed);
    const revealedTeams = revealedIds.map(id => poolById.get(id)).filter(Boolean);

    const remainingIds = (order.length ? order.slice(revealed) : pool.map(x => x.id));
    const remainingTeams = remainingIds.map(id => poolById.get(id)).filter(Boolean);

    return { revealedTeams, remainingTeams };
  }

  function renderPreview(ts1, ts2, poolRemaining, revealedTeams=[]){
    seed1El.textContent = ts1 ? teamLabel(ts1) : "â€”";
    seed2El.textContent = ts2 ? teamLabel(ts2) : "â€”";

    poolList.innerHTML = poolRemaining.length
      ? poolRemaining.map(p=> `<div class="card" style="margin:0;">
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div><b>${esc(teamLabel(p))}</b></div>
            <span class="pill">urne</span>
          </div>
        </div>`).join("")
      : `<div class="muted">â€”</div>`;

    revealedList.innerHTML = revealedTeams.length
      ? revealedTeams.map((t,i)=> `<div class="card" style="margin:0;">
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div><b>#${i+1}</b> â€” ${esc(teamLabel(t))}</div>
            <span class="pill">tirÃ©e</span>
          </div>
        </div>`).join("")
      : `<div class="muted">En attenteâ€¦</div>`;

    wheel.textContent = "â€”";
    wheelSub.textContent = "â€”";
  }

  async function loadMainTeams(){
    if(currentScope === "general"){ alert("Choisis une Ã©tape."); return; }

    uiSet("Chargement Ã©quipesâ€¦");

    await readDraw();
    if(draw && (draw.status === "running" || draw.status === "pending_validation" || draw.status === "validated")){
      const ok = confirm("Un tirage existe dÃ©jÃ  (statut: " + draw.status + ").\n\nRecharger remet lâ€™urne en mode â€œidleâ€ et reset revealed.\nContinuer ?");
      if(!ok){ uiSet("AnnulÃ©."); return; }
    }

    const snap = await getDocs(query(collection(db, COL_PUBLIC(currentScope)), orderBy("createdAt","asc")));

    const rows = [];
    snap.forEach(d=>{
      const x = d.data() || {};
      const isMain = (x.list === "main") && (x.stby !== true);
      if(!isMain) return;

      const t = {
        id: d.id,
        teamName: x.teamName || "",
        p1FirstName: x.p1FirstName || "",
        p2FirstName: x.p2FirstName || "",
        p1Rank: x.p1Rank ?? null,
        p2Rank: x.p2Rank ?? null
      };
      t.teamRank = teamRank(t);
      rows.push(t);
    });

    cachedMainTeams = rows.sort((a,b)=> a.teamRank - b.teamRank);

    if(cachedMainTeams.length !== 8){
      uiSet(`âš ï¸ Liste principale dÃ©tectÃ©e = ${cachedMainTeams.length} Ã©quipe(s). Il en faut 8 (list=main, stby=false).`);
      renderPreview(null, null, cachedMainTeams.slice(0, 6), []);
      setButtons();
      return;
    }

    const ts1 = cachedMainTeams[0];
    const ts2 = cachedMainTeams[1];
    const pool = cachedMainTeams.slice(2);

    await setDoc(DRAW_REF(currentScope), {
      scope: currentScope,
      status: "idle",
      seed1: { id: ts1.id, teamName: ts1.teamName, p1FirstName: ts1.p1FirstName, p2FirstName: ts1.p2FirstName, teamRank: ts1.teamRank },
      seed2: { id: ts2.id, teamName: ts2.teamName, p1FirstName: ts2.p1FirstName, p2FirstName: ts2.p2FirstName, teamRank: ts2.teamRank },
      pool: pool.map(p => ({ id:p.id, teamName:p.teamName, p1FirstName:p.p1FirstName, p2FirstName:p.p2FirstName, teamRank:p.teamRank })),
      order: [],
      revealed: 0,
      revealedAtMs: [],
      createdAt: serverTimestamp(),
      validatedAt: null
    }, { merge:true });

    await readDraw();
    setButtons();

    uiSet("âœ… Ã‰quipes chargÃ©es (urne publiÃ©e). Tu peux lancer le tirage.");
    renderPreview(draw.seed1, draw.seed2, draw.pool || [], []);
  }

  async function startDraw(){
    if(currentScope === "general"){ alert("Choisis une Ã©tape."); return; }

    await readDraw();

    const ts1 = cachedMainTeams[0] || draw?.seed1;
    const ts2 = cachedMainTeams[1] || draw?.seed2;

    const poolArr = (cachedMainTeams.length >= 8)
      ? cachedMainTeams.slice(2).map(p => ({ id:p.id, teamName:p.teamName, p1FirstName:p.p1FirstName, p2FirstName:p.p2FirstName, teamRank:p.teamRank }))
      : (draw?.pool || []);

    if(!ts1 || !ts2 || !Array.isArray(poolArr) || poolArr.length !== 6){
      alert("Urne non prÃªte. Clique dâ€™abord â€œCharger Ã©quipes (liste principale)â€.");
      return;
    }

    const order = randomShuffle(poolArr.map(x => x.id));

    await setDoc(DRAW_REF(currentScope), {
      scope: currentScope,
      status: "running",
      seed1: ts1,
      seed2: ts2,
      pool: poolArr,
      order,
      revealed: 0,
      revealedAtMs: [],
      createdAt: serverTimestamp(),
      validatedAt: null
    }, { merge:true });

    await readDraw();
    uiSet("â–¶ï¸ Tirage lancÃ©. Clique â€œTirer la prochaine Ã©quipeâ€.");
    setButtons();

    const { revealedTeams, remainingTeams } = pickTeamsFromDraw(draw);
    renderPreview(draw.seed1, draw.seed2, remainingTeams, revealedTeams);
  }

  async function rouletteSpin(finalText, durationMs = 1300){
    const start = Date.now();
    wheelSub.textContent = "La roulette tourneâ€¦";
    const fake = ["ğŸŒªï¸","ğŸ¾","ğŸ”¥","ğŸ€","âš¡ï¸","ğŸ²","ğŸ–ï¸"];

    return new Promise((resolve) => {
      const tick = () => {
        const t = Date.now() - start;
        if(t >= durationMs){
          wheel.textContent = finalText;
          wheelSub.textContent = "âœ… RÃ©vÃ©lÃ©";
          resolve("done");
          return;
        }
        wheel.textContent = fake[Math.floor(Math.random()*fake.length)] + " " + fake[Math.floor(Math.random()*fake.length)];
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  async function nextPick(){
    if(currentScope === "general"){ alert("Choisis une Ã©tape."); return; }

    await readDraw();

    if(!draw || draw.status !== "running"){
      alert("Le tirage nâ€™est pas en cours.");
      return;
    }

    const order = draw.order || [];
    const pool = draw.pool || [];
    const poolById = new Map(pool.map(x => [x.id, x]));
    const revealed = Number(draw.revealed || 0);

    if(revealed >= 6){
      alert("Les 6 Ã©quipes ont dÃ©jÃ  Ã©tÃ© tirÃ©es.");
      return;
    }

    const id = order[revealed];
    const t = poolById.get(id);

    await rouletteSpin(teamLabel(t), 1300);

    const newRevealed = revealed + 1;
    const arr = Array.isArray(draw.revealedAtMs) ? draw.revealedAtMs.slice() : [];
    arr.push(Date.now());

    await updateDoc(DRAW_REF(currentScope), {
      revealed: newRevealed,
      revealedAtMs: arr
    });

    await readDraw();

    const { revealedTeams, remainingTeams } = pickTeamsFromDraw(draw);
    renderPreview(draw.seed1 || null, draw.seed2 || null, remainingTeams, revealedTeams);

    if(newRevealed >= 6){
      await updateDoc(DRAW_REF(currentScope), { status: "pending_validation" });
      await readDraw();
      uiSet("ğŸ Tirage fini â€” en attente de validation.");
    } else {
      uiSet(`ğŸ° Tirage #${newRevealed} effectuÃ©.`);
    }

    setButtons();
  }

  async function validateDraw(){
    if(currentScope === "general"){ alert("Choisis une Ã©tape."); return; }

    const ok = confirm("Valider le tirage ?\n\nLe public verra le tirage VALIDÃ‰ + date/heure.");
    if(!ok) return;

    await updateDoc(DRAW_REF(currentScope), {
      status: "validated",
      validatedAt: serverTimestamp()
    });

    await readDraw();
    uiSet("âœ… Tirage validÃ©.");
    setButtons();
  }

  async function resetDraw(){
    if(currentScope === "general"){ alert("Choisis une Ã©tape."); return; }

    const ok1 = confirm("âš ï¸ RÃ©initialiser le tirage ?\n\nCela efface lâ€™Ã©tat du tirage pour cette Ã©tape.");
    if(!ok1) return;

    const typed = prompt('Tape exactement : RESET');
    if(typed !== "RESET"){ alert("AnnulÃ©."); return; }

    await setDoc(DRAW_REF(currentScope), {
      scope: currentScope,
      status: "idle",
      seed1: null,
      seed2: null,
      pool: [],
      order: [],
      revealed: 0,
      revealedAtMs: [],
      createdAt: serverTimestamp(),
      validatedAt: null
    }, { merge: true });

    await readDraw();
    cachedMainTeams = [];
    uiSet("ğŸ§¼ Tirage rÃ©initialisÃ©.");
    renderPreview(null, null, [], []);
    setButtons();
  }

  // Buttons
  btnLoad.onclick = async (e)=>{ e.preventDefault(); await loadMainTeams(); };
  btnStart.onclick = async (e)=>{ e.preventDefault(); await startDraw(); };
  btnNext.onclick = async (e)=>{ e.preventDefault(); await nextPick(); };
  btnValidate.onclick = async (e)=>{ e.preventDefault(); await validateDraw(); };
  btnReset.onclick = async (e)=>{ e.preventDefault(); await resetDraw(); };

  // Public view
  btnPublic.onclick = (e)=>{
    e.preventDefault();
    if(currentScope === "general"){ alert("Choisis une Ã©tape."); return; }
    window.location.href = `../${currentScope}/tirage.html`;
  };

  // Logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  function showDenied(){
    accessDenied.style.display = "block";
    adminZone.style.display = "none";
    panelNeedStep.style.display = "none";
    adminUI.style.display = "none";
    panel.style.display = "none";
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminZone.style.display = "block";

    scopeEl.value = currentScope;
    setTabs(currentScope);
    showPanelsForScope(currentScope);
    persistScope(currentScope);

    scopeEl.onchange = async ()=>{
      currentScope = scopeEl.value || "general";
      setTabs(currentScope);
      showPanelsForScope(currentScope);
      persistScope(currentScope);

      cachedMainTeams = [];
      draw = null;

      if(currentScope !== "general"){
        await readDraw();
        setButtons();
        uiSet("âœ… Admin prÃªt. 1) Charger Ã©quipes, 2) Lancer, 3) Tirer x6, 4) Valider.");
        if(draw){
          const { revealedTeams, remainingTeams } = pickTeamsFromDraw(draw);
          renderPreview(draw.seed1 || null, draw.seed2 || null, remainingTeams, revealedTeams);
          if(draw.status === "pending_validation") uiSet("ğŸ Tirage fini â€” en attente de validation.");
          if(draw.status === "validated") uiSet("âœ… Tirage validÃ©.");
          if(draw.status === "idle" && !drawHasUrn(draw)) uiSet("â„¹ï¸ Urne non prÃªte. Clique â€œCharger Ã©quipes (liste principale)â€.");
        }else{
          renderPreview(null, null, [], []);
          uiSet("â„¹ï¸ Urne non prÃªte. Clique â€œCharger Ã©quipes (liste principale)â€.");
        }
      }else{
        renderPreview(null, null, [], []);
        statusEl.textContent = "â€”";
        setButtons();
      }
    };
  }

  // Guard
  const g = await requireRole(["admin"]);
  if(!g.ok){ showDenied(); }
  else { showAdmin(); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }

    // init content for non-general
    if(currentScope !== "general"){
      await readDraw();
      setButtons();
      uiSet("âœ… Admin prÃªt. 1) Charger Ã©quipes, 2) Lancer, 3) Tirer x6, 4) Valider.");
      if(draw){
        const { revealedTeams, remainingTeams } = pickTeamsFromDraw(draw);
        renderPreview(draw.seed1 || null, draw.seed2 || null, remainingTeams, revealedTeams);
        if(draw.status === "pending_validation") uiSet("ğŸ Tirage fini â€” en attente de validation.");
        if(draw.status === "validated") uiSet("âœ… Tirage validÃ©.");
        if(draw.status === "idle" && !drawHasUrn(draw)) uiSet("â„¹ï¸ Urne non prÃªte. Clique â€œCharger Ã©quipes (liste principale)â€.");
      }else{
        renderPreview(null, null, [], []);
        uiSet("â„¹ï¸ Urne non prÃªte. Clique â€œCharger Ã©quipes (liste principale)â€.");
      }
    }else{
      setButtons();
      statusEl.textContent = "â€”";
    }
  });
</script>

</body>
</html>
