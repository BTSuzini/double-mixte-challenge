<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Infos</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <!-- ‚úÖ m√™me bandeau que le r√®glement (centre = image) -->
      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>


      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil</a>
      <a href="index.html">Admin</a>
      <a href="infos.html" aria-current="page">Infos</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="notAllowed" style="display:none;">
    <h2 style="margin:0 0 8px 0;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">
      Cette page est r√©serv√©e aux administrateurs.
    </p>
  </section>

  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px 0;">üì£ Publier une info</h2>

    <form id="infoForm" class="form" autocomplete="off">
      <div class="field">
        <label for="title">Titre *</label>
        <input id="title" name="title" type="text" required maxlength="80" placeholder="Ex : Inscriptions ouvertes ‚úÖ">
      </div>

      <div class="field">
        <label for="text">Texte *</label>
        <textarea id="text" name="text" rows="5" required maxlength="2000"
          placeholder="Ton message ici (emojis ok üòÑ)"></textarea>
      </div>

      <button id="publishBtn" class="btn" type="submit" style="font-weight:800; color:#111;">
        ‚úÖ Publier
      </button>

      <p id="status" class="muted" role="status" aria-live="polite"></p>
    </form>

    <hr class="sep" />

    <h2 style="margin:0 0 10px 0;">üì∞ Infos publi√©es</h2>
    <p class="muted" id="count" style="margin:0;">Chargement‚Ä¶</p>

    <div id="list" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc,
    collection, addDoc, deleteDoc,
    serverTimestamp,
    query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ Ta config
  const firebaseConfig = {
    apiKey: "AIzaSyDAW66BD1V2Kr2w6ksM1_8bHGugeG6_cUI",
    authDomain: "suzini-double-mixte-challenge.firebaseapp.com",
    projectId: "suzini-double-mixte-challenge",
    storageBucket: "suzini-double-mixte-challenge.firebasestorage.app",
    messagingSenderId: "148641893645",
    appId: "1:148641893645:web:d73cb1727a7b96af3ff444"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const COL_INFOS = "infos";

  const notAllowed = document.getElementById("notAllowed");
  const adminUI = document.getElementById("adminUI");

  const form = document.getElementById("infoForm");
  const publishBtn = document.getElementById("publishBtn");
  const statusEl = document.getElementById("status");

  const countEl = document.getElementById("count");
  const listEl = document.getElementById("list");

  const btnLogout = document.getElementById("btnLogout");

  function escapeHTML(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", { year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit" });
    } catch { return "‚Äî"; }
  }

  async function getRoleByEmail(email){
    const s = await getDoc(doc(db, "roles", email));
    if(!s.exists()) return null;
    return s.data().role || null;
  }

  btnLogout?.addEventListener("click", async (e)=>{
    e.preventDefault();
    await signOut(auth);
    alert("D√©connect√© ‚úÖ");
    window.location.href = "../index.html";
  });

  // üîê Garde-fou admin + d√©marrage listeners
  let unsubscribeInfos = null;

  onAuthStateChanged(auth, async (user) => {
    adminUI.style.display = "none";
    notAllowed.style.display = "none";

    if(unsubscribeInfos){
      unsubscribeInfos();
      unsubscribeInfos = null;
    }

    if(!user){
      notAllowed.style.display = "block";
      return;
    }

    const role = await getRoleByEmail(user.email);
    if(role !== "admin"){
      notAllowed.style.display = "block";
      return;
    }

    adminUI.style.display = "block";

    // üîÑ Live list
    const q = query(collection(db, COL_INFOS), orderBy("createdAt", "desc"));
    unsubscribeInfos = onSnapshot(q, (snap) => {
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      countEl.textContent = `üìå ${docs.length} info${docs.length > 1 ? "s" : ""}`;
      listEl.innerHTML = "";

      if(docs.length === 0){
        listEl.innerHTML = `<p class="muted" style="margin:0;">Aucune info publi√©e.</p>`;
        return;
      }

      for(const it of docs){
        const title = escapeHTML(it.title);
        const text = escapeHTML(it.text).replaceAll("\n","<br>");
        const date = fmtDate(it.createdAt);

        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.style.margin = "0";

        wrap.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
            <div style="min-width:0;">
              <div style="font-weight:900;">${title}</div>
              <div class="muted" style="margin:6px 0 0;">üóìÔ∏è ${date}</div>
              <div style="margin-top:8px; line-height:1.45;">${text}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; flex:0 0 auto;">
              <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">
                üóëÔ∏è Supprimer
              </button>
            </div>
          </div>
        `;

        listEl.appendChild(wrap);
      }

      // Bind delete buttons
      listEl.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          const ok = confirm("Supprimer cette info ?\n\n‚ö†Ô∏è Action irr√©versible.");
          if(!ok) return;

          try{
            await deleteDoc(doc(db, COL_INFOS, id));
            alert("Info supprim√©e ‚úÖ");
          } catch(e){
            console.error(e);
            alert("Erreur suppression ‚ùå");
          }
        });
      });
    }, (err) => {
      console.error(err);
      countEl.textContent = "‚ùå Impossible de charger les infos.";
    });
  });

  // ‚ûï Publish
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    statusEl.textContent = "Publication en cours‚Ä¶";

    try{
      const title = (form.title.value || "").trim();
      const text = (form.text.value || "").trim();

      if(!title || !text) throw new Error("Titre et texte obligatoires.");

      await addDoc(collection(db, COL_INFOS), {
        title,
        text,
        createdAt: serverTimestamp()
      });

      form.reset();
      statusEl.textContent = "‚úÖ Info publi√©e !";
    } catch(err){
      console.error(err);
      statusEl.textContent = "‚ùå Erreur : " + (err?.message || "publication impossible.");
    } finally{
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });
</script>

</body>
</html>
