<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî √âquipes</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        üë• √âquipes (admin)<br>
        <span style="opacity:.95;font-weight:800;" id="pageSub">√âtape ‚Äî</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- ‚úÖ Bandeau identique partout -->
    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Encart Zone (√† recopier dans toutes les pages admin) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üéõÔ∏è Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">G√©n√©ral</option>
        <option value="etape1">√âtape 1</option>
        <option value="etape2">√âtape 2</option>
        <option value="etape3">√âtape 3</option>
        <option value="etape4">√âtape 4</option>
        <option value="etape5">√âtape 5</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- =========================
       CONTENU PAGE (apr√®s Zone)
       => liste √©quipes admin
  ========================== -->

  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">‚ÑπÔ∏è Choisir une √©tape</h2>
    <p class="muted" style="margin:0;">
      S√©lectionne une <b>√âtape</b> dans ‚ÄúZone‚Äù pour g√©rer les √©quipes.
      (Le G√©n√©ral se g√®re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <section class="card" id="panelTeams" style="display:none;">
    <h2>üìå R√©sum√©</h2>
    <p class="muted">
      Total: <strong id="total">0</strong> ‚Äî
      Principale: <strong id="main">0</strong> ‚Äî
      Attente: <strong id="wait">0</strong> ‚Äî
      STBY: <strong id="stby">0</strong>
    </p>
    <p class="muted" id="status">Chargement‚Ä¶</p>
  </section>

  <section class="card" id="panelTeamsTable" style="display:none;">
    <h2>üóÇÔ∏è Liste admin</h2>

    <div class="table-wrap">
      <table class="teams-table">
        <thead>
          <tr>
            <th style="width:44px;">#</th>
            <th>√âquipe</th>
            <th>Joueuse</th>
            <th>Joueur</th>
            <th style="width:110px;">BT Joueuse</th>
            <th style="width:110px;">BT Joueur</th>
            <th>T√©l. Joueuse</th>
            <th>T√©l. Joueur</th>
            <th>Licence Joueuse</th>
            <th>Licence Joueur</th>
            <th style="width:260px;">Actions</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </section>

</main>

<style>
  .table-wrap{ overflow:auto; border:1px solid #eee; border-radius:14px; background:#fff; }
  .teams-table{ width:100%; border-collapse:separate; border-spacing:0; min-width:1350px; }
  .teams-table thead th{
    text-align:left; font-size:13px; color:#444; background:#f7f7f7;
    border-bottom:1px solid #eee; padding:12px; position:sticky; top:0; z-index:1;
    white-space:nowrap;
  }
  .teams-table tbody td{ padding:12px; border-bottom:1px solid #f0f0f0; font-size:14px; vertical-align:top; }
  .teams-table tbody tr:last-child td{ border-bottom:none; }

  .pill{
    display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px;
    border:1px solid #eee; background:#fafafa; white-space:nowrap;
  }
  .pill.rank{ border-color:#d9e6ff; background:#f3f7ff; font-weight:900; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .btnx{ padding:8px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:700; }
  .btnx:hover{ background:#f5f5f5; }
  .danger{ border-color:#f1b2b2; }
  .danger:hover{ background:#ffecec; }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs, doc, setDoc, updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- scope (URL ?scope=etape1)
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope") || "etape1";

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const pageSub = document.getElementById("pageSub");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelTeams = document.getElementById("panelTeams");
  const panelTeamsTable = document.getElementById("panelTeamsTable");

  const body = document.getElementById("body");
  const statusEl = document.getElementById("status");

  const totalEl = document.getElementById("total");
  const mainEl  = document.getElementById("main");
  const waitEl  = document.getElementById("wait");
  const stbyEl  = document.getElementById("stby");

  // ---- state
  let currentScope = scopeFromUrl;

  // collections (dynamiques selon scope)
  let COL_PRIVATE = `inscriptions_${currentScope}_private`;
  let COL_PUBLIC  = `equipes_${currentScope}_public`;

  function stepLabel(scope){
    if(!scope || scope === "general") return "G√©n√©ral";
    const n = scope.replace("etape","");
    return `√âtape ${n}`;
  }

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // Accepte "12", "12.5", "12,5"
  function toNum(v){
    if(v === null || v === undefined || v === "") return null;
    const n = typeof v === "number" ? v : Number(String(v).replace(",", ".").trim());
    return Number.isFinite(n) ? n : null;
  }

  function fmtRank(v){
    const n = toNum(v);
    return n === null ? "‚Äî" : String(n);
  }

  function teamRank(p1, p2){
    const a = toNum(p1), b = toNum(p2);
    if(a === null || b === null) return null;
    return a + b;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      hintEl.textContent = "Zone G√©n√©ral : se g√®re depuis admin/index.html (infos).";
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "üì∞ Aller aux infos (G√©n√©ral)";
      tabsEl.appendChild(a);
      return;
    }

    hintEl.textContent = "Zone √âtape : √©quipes / inscriptions / r√©sultats.";

    const links = [
      ["üë• √âquipes", "equipes.html"],
      ["üìù Inscriptions", "inscriptions.html"],
      ["üèÅ R√©sultats", "resultats.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      // simple highlight de l'onglet courant
      if(url === "equipes.html"){
        a.style.fontWeight = "900";
      }

      tabsEl.appendChild(a);
    }
  }

  function showPanelsForScope(scope){
    pageSub.textContent = scope === "general" ? "G√©n√©ral" : `${stepLabel(scope)} ‚Äî BT250`;

    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelTeams.style.display = "none";
      panelTeamsTable.style.display = "none";
      return;
    }

    panelNeedStep.style.display = "none";
    panelTeams.style.display = "block";
    panelTeamsTable.style.display = "block";

    // update collections
    COL_PRIVATE = `inscriptions_${scope}_private`;
    COL_PUBLIC  = `equipes_${scope}_public`;
  }

  // ‚ö° perf: 1 lecture priv√©e + 1 lecture publique, puis merge en m√©moire
  async function fetchAll(){
    statusEl.textContent = "Chargement‚Ä¶";

    const [privSnap, pubSnap] = await Promise.all([
      getDocs(collection(db, COL_PRIVATE)),
      getDocs(collection(db, COL_PUBLIC)),
    ]);

    const pubById = new Map();
    pubSnap.forEach(d=>{
      pubById.set(d.id, d.data() || {});
    });

    const rows = [];
    privSnap.forEach(d=>{
      const data = d.data() || {};
      const pub = pubById.get(d.id) || {};

      rows.push({
        id: d.id,
        createdAtMs: data.createdAt?.toMillis ? data.createdAt.toMillis() : 0,
        ...data,

        list: pub.list || null,
        stby: pub.stby === true,

        // ‚úÖ classements (stock√©s c√¥t√© public)
        p1Rank: pub.p1Rank ?? null,
        p2Rank: pub.p2Rank ?? null
      });
    });

    rows.sort((a,b)=> (a.createdAtMs||0) - (b.createdAtMs||0));
    return rows;
  }

  async function setPublicPatch(id, patch){
    await setDoc(
      doc(db, COL_PUBLIC, id),
      { ...patch, updatedAt: serverTimestamp() },
      { merge:true }
    );
  }

  async function moveList(id, to){
    await setPublicPatch(id, { list: to });
  }

  async function toggleStby(id, current){
    await setPublicPatch(id, { stby: !current });
  }

  async function removeTeam(id){
    const ok = confirm("Supprimer cette √©quipe ?\n\n‚ö†Ô∏è Action irr√©versible.");
    if(!ok) return;
    await deleteDoc(doc(db, COL_PRIVATE, id));
    await deleteDoc(doc(db, COL_PUBLIC, id));
  }

  async function editTeam(row){
    const teamName = prompt("Nom √©quipe :", row.teamName || "");
    if(teamName === null) return;

    const p1FirstName = prompt("Pr√©nom Joueuse :", row.p1FirstName || "");
    if(p1FirstName === null) return;

    const p1LastName = prompt("Nom Joueuse :", row.p1LastName || "");
    if(p1LastName === null) return;

    const p1Phone = prompt("T√©l√©phone Joueuse :", row.p1Phone || "");
    if(p1Phone === null) return;

    const p1Licence = prompt("Licence Joueuse :", row.p1Licence || "");
    if(p1Licence === null) return;

    const p2FirstName = prompt("Pr√©nom Joueur :", row.p2FirstName || "");
    if(p2FirstName === null) return;

    const p2LastName = prompt("Nom Joueur :", row.p2LastName || "");
    if(p2LastName === null) return;

    const p2Phone = prompt("T√©l√©phone Joueur :", row.p2Phone || "");
    if(p2Phone === null) return;

    const p2Licence = prompt("Licence Joueur :", row.p2Licence || "");
    if(p2Licence === null) return;

    // priv√©
    await updateDoc(doc(db, COL_PRIVATE, row.id), {
      teamName,
      p1FirstName, p1LastName, p1Phone, p1Licence,
      p2FirstName, p2LastName, p2Phone, p2Licence
    });

    // public (sans toucher aux ranks)
    await setDoc(doc(db, COL_PUBLIC, row.id), {
      teamName,
      p1FirstName,
      p2FirstName
    }, { merge:true });
  }

  async function editRanks(row){
    const cur1 = fmtRank(row.p1Rank);
    const cur2 = fmtRank(row.p2Rank);

    const p1 = prompt("Classement BT Joueuse (nombre) :", cur1 === "‚Äî" ? "" : cur1);
    if(p1 === null) return;

    const p2 = prompt("Classement BT Joueur (nombre) :", cur2 === "‚Äî" ? "" : cur2);
    if(p2 === null) return;

    const p1t = p1.trim();
    const p2t = p2.trim();

    const p1n = (p1t === "") ? null : toNum(p1t);
    const p2n = (p2t === "") ? null : toNum(p2t);

    if(p1t !== "" && p1n === null) { alert("Classement Joueuse invalide."); return; }
    if(p2t !== "" && p2n === null) { alert("Classement Joueur invalide."); return; }

    await setPublicPatch(row.id, { p1Rank: p1n, p2Rank: p2n });
  }

  function render(rows){
    const total = rows.length;
    const main  = rows.filter(r => r.list === "main" && !r.stby).length;
    const wait  = rows.filter(r => r.list === "wait" && !r.stby).length;
    const stby  = rows.filter(r => r.stby).length;

    totalEl.textContent = total;
    mainEl.textContent  = main;
    waitEl.textContent  = wait;
    stbyEl.textContent  = stby;

    body.innerHTML = rows.map((r, idx) => {
      const tr = teamRank(r.p1Rank, r.p2Rank);

      return `
        <tr>
          <td>#${idx+1}</td>
          <td>
            <strong>${esc(r.teamName)}</strong><br>
            <span class="pill">list: ${esc(r.list || "auto")}</span>
            ${r.stby ? '<span class="pill">STBY</span>' : ''}
            ${tr !== null ? `<span class="pill rank">üè∑Ô∏è √âquipe: ${esc(String(tr))}</span>` : ''}
          </td>

          <td>${esc(r.p1FirstName)} ${esc(r.p1LastName)}</td>
          <td>${esc(r.p2FirstName)} ${esc(r.p2LastName)}</td>

          <td><span class="pill rank">${esc(fmtRank(r.p1Rank))}</span></td>
          <td><span class="pill rank">${esc(fmtRank(r.p2Rank))}</span></td>

          <td>${esc(r.p1Phone)}</td>
          <td>${esc(r.p2Phone)}</td>
          <td>${esc(r.p1Licence)}</td>
          <td>${esc(r.p2Licence)}</td>

          <td>
            <div class="actions">
              <button class="btnx" data-act="edit" data-id="${esc(r.id)}">‚úèÔ∏è Modifier</button>
              <button class="btnx" data-act="ranks" data-id="${esc(r.id)}">üè∑Ô∏è Classements</button>
              <button class="btnx" data-act="main" data-id="${esc(r.id)}">‚¨ÜÔ∏è Principale</button>
              <button class="btnx" data-act="wait" data-id="${esc(r.id)}">‚¨áÔ∏è Attente</button>
              <button class="btnx" data-act="stby" data-id="${esc(r.id)}">${r.stby ? "‚úÖ Activer" : "‚è∏Ô∏è STBY"}</button>
              <button class="btnx danger" data-act="del" data-id="${esc(r.id)}">üóëÔ∏è Supprimer</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function refresh(){
    if(currentScope === "general"){
      statusEl.textContent = "‚Äî";
      body.innerHTML = "";
      totalEl.textContent = "0";
      mainEl.textContent = "0";
      waitEl.textContent = "0";
      stbyEl.textContent = "0";
      return;
    }

    const rows = await fetchAll();
    render(rows);
    statusEl.textContent = "‚úÖ OK";
  }

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelTeams.style.display = "none";
    panelTeamsTable.style.display = "none";
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    scopeEl.value = currentScope;
    setTabs(currentScope);
    showPanelsForScope(currentScope);

    scopeEl.onchange = async ()=>{
      currentScope = scopeEl.value || "general";
      setTabs(currentScope);
      showPanelsForScope(currentScope);
      await refresh();
    };
  }

  // Guard (avec persistance via session.js)
  const g = await requireRole(["admin"]);
  if(!g.ok){
    showDenied();
  }else{
    showAdmin();
    await refresh();
  }

  // robuste si session change
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });

  // Actions table
  body.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;

    if(currentScope === "general"){
      alert("Choisis une √©tape.");
      return;
    }

    const act = btn.dataset.act;
    const id  = btn.dataset.id;

    statusEl.textContent = "Traitement‚Ä¶";

    try{
      const rows = await fetchAll();
      const row = rows.find(x => x.id === id);
      if(!row) { statusEl.textContent = "‚ùå Introuvable"; return; }

      if(act === "edit")  await editTeam(row);
      if(act === "ranks") await editRanks(row);
      if(act === "main")  await moveList(id, "main");
      if(act === "wait")  await moveList(id, "wait");
      if(act === "stby")  await toggleStby(id, row.stby);
      if(act === "del")   await removeTeam(id);

      await refresh();
    }catch(err){
      console.error(err);
      statusEl.textContent = "‚ùå Erreur";
    }
  });

  // Logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };
</script>

</body>
</html>
