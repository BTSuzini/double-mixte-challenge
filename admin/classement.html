<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Classement</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260225-classement-admin" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">üè† Accueil public</a>
      <a href="#" id="btnLogout">üö™ D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Zone (m√™me partout) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üß≠ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">üåê G√©n√©ral</option>
        <option value="etape1">üéæ √âtape 1</option>
        <option value="etape2">üéæ √âtape 2</option>
        <option value="etape3">üéæ √âtape 3</option>
        <option value="etape4">üéæ √âtape 4</option>
        <option value="etape5">üß™ √âtape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px; display:none;"></p>
  </section>

  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">‚ÑπÔ∏è Choisir une √©tape</h2>
    <p class="muted" style="margin:0;">
      S√©lectionne une <b>√âtape</b> dans ‚ÄúZone‚Äù pour consulter/valider le classement.
    </p>
  </section>

  <section class="card" id="panelRank" style="display:none;">
    <h2 style="margin:0 0 10px;">üèÜ Classement final</h2>
    <p class="muted" id="statusText" style="margin:0;">Chargement‚Ä¶</p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnValidate" style="font-weight:900; color:#111;" disabled>
        ‚úÖ Valider le classement
      </button>
    </div>

    <div id="validatedBox" class="muted" style="margin-top:10px; display:none;"></div>

    <hr class="sep" style="margin-top:14px;" />

    <h3 style="margin:0 0 8px;">üë• Classement des √©quipes</h3>
    <div id="teamList"></div>

    <hr class="sep" style="margin-top:14px;" />

    <h3 style="margin:0 0 8px;">üßç Classement des joueurs</h3>
    <div id="playerList"></div>

    <p class="muted" style="margin-top:12px;">
      Le classement est calcul√© √† partir des matchs :
      <b>M9</b> (7e/8e), <b>M10</b> (5e/6e), <b>M11</b> (3e/4e), <b>M12</b> (Finale).
    </p>
  </section>

</main>

<style>
  /* ‚úÖ Bonus : onglet courant (tabs) en NOIR avec √©criture BLANCHE */
  .btn.is-active{
    background:#111 !important;
    border-color:#111 !important;
    color:#fff !important;
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
  }

  .list{ display:flex; flex-direction:column; gap:10px; }

  .rank-card{
    border-radius:16px;
    border:2px solid rgba(0,0,0,.06);
    padding:12px;
    background:#fff;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
  }

  .rk{
    width:42px; height:42px; border-radius:14px;
    border:1px solid rgba(0,0,0,.10);
    display:flex; align-items:center; justify-content:center;
    font-weight:1000; font-size:16px; flex:0 0 auto;
  }

  .rmain{ min-width:0; flex:1 1 auto; }
  .rtitle{
    font-weight:1000; line-height:1.15; margin:0;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .rsub{ margin-top:6px; font-size:12px; opacity:.8; line-height:1.35; }

  .tag{
    border:1px solid rgba(0,0,0,.12);
    border-radius:999px;
    padding:5px 9px;
    font-size:11px;
    font-weight:1000;
    white-space:nowrap;
    opacity:.9;
    flex:0 0 auto;
  }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, onSnapshot, collection,
    setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const LS_SCOPE_KEY = "admin_scope_last";

  // ---- scope (URL ?scope=etape1) + fallback localStorage
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope");

  function getInitialScope(){
    if(scopeFromUrl) return scopeFromUrl;
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved) return saved;
    }catch(e){}
    return "etape1";
  }

  function persistScope(scope){
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}
  }

  // ---- DOM
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelRank     = document.getElementById("panelRank");

  const statusText    = document.getElementById("statusText");
  const btnValidate   = document.getElementById("btnValidate");
  const validatedBox  = document.getElementById("validatedBox");

  const teamList      = document.getElementById("teamList");
  const playerList    = document.getElementById("playerList");

  // ---- state
  let currentScope = getInitialScope();
  let currentProg = null;
  let resultsByMatch = new Map();
  let currentClassementDoc = null;

  let unsubProg = null;
  let unsubRes  = null;
  let unsubCls  = null;

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", { year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit" });
    }catch{ return "‚Äî"; }
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "üì∞ Aller √† Admin ‚Äî Gestion (infos)";
      tabsEl.appendChild(a);
      return;
    }

    // m√™me liste que les autres pages admin
    if(scope === "etape5"){
      tabsEl.appendChild(makeDisabledBtn("üçΩÔ∏è Repas (plus tard)", "Repas non activ√© pour l‚Äô√©tape 5 (zone test)."));
    }

    const links = [
      ["üë• √âquipes",        "equipes.html"],
      ["üìù Inscriptions",   "inscriptions.html"],
      ...(scope !== "etape5" ? [["üçΩÔ∏è Repas", "repas.html"]] : []),
      ["üé≤ Tirage",         "tirage.html"],
      ["üìÖ Programmation",  "programmation.html"],
      ["üèÅ R√©sultats",      "resultats.html"],
      ["üèÜ Classement",     "classement.html"],
      ["RAZ",     "raz.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      // ‚úÖ bouton courant noir/blanc
      if(url === "classement.html"){
        a.classList.add("is-active");
        a.style.fontWeight = "1000";
      }
      tabsEl.appendChild(a);
    }
  }

  function stopListeners(){
    if(unsubProg){ unsubProg(); unsubProg = null; }
    if(unsubRes){ unsubRes(); unsubRes = null; }
    if(unsubCls){ unsubCls(); unsubCls = null; }
  }

  // ---- Firestore refs (inchang√©s)
  function progRef(scope){ return doc(db, "programmations", scope); }
  function resultsCol(scope){ return collection(db, `resultats_${scope}`); }
  function classementRef(scope){ return doc(db, "classements", scope); }

  function teamParts(t){
    if(!t) return { teamName:"‚Äî", p1:"‚Äî", p2:"‚Äî" };
    const teamName = t.teamName || "√âquipe";
    const p1 = `${t.p1LastName || ""} ${t.p1FirstName || ""}`.trim() || "‚Äî";
    const p2 = `${t.p2LastName || ""} ${t.p2FirstName || ""}`.trim() || "‚Äî";
    return { teamName, p1, p2 };
  }

  function resolveTeamRef(ref){
    if(!currentProg) return null;
    const teams = currentProg.teams || {};
    const matches = currentProg.matches || {};
    if(!ref) return null;

    if(ref.type === "team"){
      return teams[ref.key] || null;
    }

    if(ref.type === "winner" || ref.type === "loser"){
      const mid = ref.matchId;
      const m = matches[mid];
      if(!m) return null;

      const res = resultsByMatch.get(mid);
      if(!res || (res.winnerSide !== "A" && res.winnerSide !== "B")) return null;

      const teamA = resolveTeamRef(m.A);
      const teamB = resolveTeamRef(m.B);

      const winner = (res.winnerSide === "A") ? teamA : teamB;
      const loser  = (res.winnerSide === "A") ? teamB : teamA;

      return ref.type === "winner" ? winner : loser;
    }

    return null;
  }

  function getWinnerTeam(matchId){
    const m = currentProg?.matches?.[matchId];
    if(!m) return null;

    const res = resultsByMatch.get(matchId);
    if(!res || (res.winnerSide !== "A" && res.winnerSide !== "B")) return null;

    const teamA = resolveTeamRef(m.A);
    const teamB = resolveTeamRef(m.B);
    if(!teamA || !teamB) return null;

    return (res.winnerSide === "A") ? teamA : teamB;
  }

  function getLoserTeam(matchId){
    const m = currentProg?.matches?.[matchId];
    if(!m) return null;

    const res = resultsByMatch.get(matchId);
    if(!res || (res.winnerSide !== "A" && res.winnerSide !== "B")) return null;

    const teamA = resolveTeamRef(m.A);
    const teamB = resolveTeamRef(m.B);
    if(!teamA || !teamB) return null;

    return (res.winnerSide === "A") ? teamB : teamA;
  }

  function buildFinalRanking(){
    const needed = ["M9","M10","M11","M12"];
    const missing = [];

    for(const mid of needed){
      const r = resultsByMatch.get(mid);
      if(!r || (r.winnerSide !== "A" && r.winnerSide !== "B")){
        missing.push(mid);
      }
    }

    const positions = [
      { pos: 1, from: () => getWinnerTeam("M12"), label:"ü•á 1er" },
      { pos: 2, from: () => getLoserTeam("M12"),  label:"ü•à 2e"  },
      { pos: 3, from: () => getWinnerTeam("M11"), label:"ü•â 3e"  },
      { pos: 4, from: () => getLoserTeam("M11"),  label:"4e"     },
      { pos: 5, from: () => getWinnerTeam("M10"), label:"5e"     },
      { pos: 6, from: () => getLoserTeam("M10"),  label:"6e"     },
      { pos: 7, from: () => getWinnerTeam("M9"),  label:"7e"     },
      { pos: 8, from: () => getLoserTeam("M9"),   label:"8e"     },
    ];

    const resolved = positions.map(x => ({ ...x, team: x.from() }));
    const unresolved = resolved.filter(x => !x.team).map(x => x.pos);
    const complete = (missing.length === 0 && unresolved.length === 0);

    return { complete, missing, unresolved, resolved };
  }

  function render(){
    if(!currentProg){
      statusText.textContent = "‚è≥ Programmation non disponible (g√©n√®re-la d‚Äôabord).";
      btnValidate.disabled = true;
      teamList.innerHTML = "";
      playerList.innerHTML = "";
      validatedBox.style.display = "none";
      return;
    }

    if(currentClassementDoc?.validatedAt){
      validatedBox.style.display = "block";
      validatedBox.innerHTML =
        `‚úÖ Classement valid√© le <b>${esc(fmtDate(currentClassementDoc.validatedAt))}</b> par <b>${esc(currentClassementDoc.validatedBy || "‚Äî")}</b>.`;
    }else{
      validatedBox.style.display = "none";
      validatedBox.innerHTML = "";
    }

    const { complete, missing, unresolved, resolved } = buildFinalRanking();

    if(!complete){
      let msg = "‚è≥ Classement incomplet.";
      if(missing.length) msg += ` Match(s) manquant(s) : ${missing.join(", ")}.`;
      if(unresolved.length) msg += ` √âquipe(s) non r√©solue(s) aux positions : ${unresolved.join(", ")}.`;
      statusText.textContent = msg;
    }else{
      statusText.textContent = "‚úÖ Classement complet (pr√™t √† valider).";
    }

    btnValidate.disabled = !(complete && !currentClassementDoc?.validatedAt);

    const teamCards = resolved.map(x=>{
      const t = teamParts(x.team);
      return `
        <div class="rank-card">
          <div class="rk">${esc(String(x.pos))}</div>
          <div class="rmain">
            <div class="rtitle">${esc(t.teamName)}</div>
            <div class="rsub muted">${esc(t.p1)}<br>${esc(t.p2)}</div>
          </div>
          <div class="tag">${esc(x.label)}</div>
        </div>
      `;
    });

    teamList.innerHTML = teamCards.length ? `<div class="list">${teamCards.join("")}</div>` : `<p class="muted">‚Äî</p>`;

    const players = [];
    for(const x of resolved){
      const t = teamParts(x.team);
      players.push({ pos:x.pos, name:t.p1, team:t.teamName });
      players.push({ pos:x.pos, name:t.p2, team:t.teamName });
    }

    const playerCards = players.map(p=>`
      <div class="rank-card">
        <div class="rk">${esc(String(p.pos))}</div>
        <div class="rmain">
          <div class="rtitle">${esc(p.name)}</div>
          <div class="rsub muted">${esc(p.team)}</div>
        </div>
        <div class="tag">Position ${esc(String(p.pos))}</div>
      </div>
    `);

    playerList.innerHTML = playerCards.length ? `<div class="list">${playerCards.join("")}</div>` : `<p class="muted">‚Äî</p>`;
  }

  function startProgListener(scope){
    if(unsubProg){ unsubProg(); unsubProg = null; }
    unsubProg = onSnapshot(progRef(scope), (snap)=>{
      currentProg = snap.exists() ? (snap.data() || {}) : null;
      render();
    }, (err)=>{
      console.error(err);
      statusText.textContent = "üî¥ Erreur programmation.";
    });
  }

  function startResultsListener(scope){
    if(unsubRes){ unsubRes(); unsubRes = null; }
    unsubRes = onSnapshot(resultsCol(scope), (snap)=>{
      resultsByMatch = new Map();
      snap.forEach(d => resultsByMatch.set(d.id, d.data() || {}));
      render();
    }, (err)=>{
      console.error(err);
      statusText.textContent = "üî¥ Erreur r√©sultats.";
    });
  }

  function startClassementListener(scope){
    if(unsubCls){ unsubCls(); unsubCls = null; }
    unsubCls = onSnapshot(classementRef(scope), (snap)=>{
      currentClassementDoc = snap.exists() ? (snap.data() || {}) : null;
      render();
    }, (err)=>{
      console.error(err);
      statusText.textContent = "üî¥ Erreur lecture classement.";
    });
  }

  async function validateClassement(){
    const { complete, resolved } = buildFinalRanking();
    if(!complete){
      alert("Classement incomplet ‚ùå");
      return;
    }

    const userEmail = auth.currentUser?.email || null;

    const positions = resolved.map(x=>{
      const t = x.team;
      return {
        pos: x.pos,
        teamName: t?.teamName || null,
        p1FirstName: t?.p1FirstName || null,
        p1LastName:  t?.p1LastName  || null,
        p2FirstName: t?.p2FirstName || null,
        p2LastName:  t?.p2LastName  || null,
      };
    });

    const players = [];
    for(const p of positions){
      players.push({ pos:p.pos, lastName:p.p1LastName, firstName:p.p1FirstName, teamName:p.teamName });
      players.push({ pos:p.pos, lastName:p.p2LastName, firstName:p.p2FirstName, teamName:p.teamName });
    }

    const payload = {
      scope: currentScope,
      computedAt: serverTimestamp(),
      computedFrom: { matches: ["M9","M10","M11","M12"] },
      positions,
      players,
      validatedAt: serverTimestamp(),
      validatedBy: userEmail
    };

    await setDoc(classementRef(currentScope), payload, { merge:true });
  }

  function showPanelsForScope(scope){
    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelRank.style.display = "none";
      stopListeners();
      return;
    }

    panelNeedStep.style.display = "none";
    panelRank.style.display = "block";

    startProgListener(scope);
    startResultsListener(scope);
    startClassementListener(scope);
  }

  function applyScope(scope){
    currentScope = (scope || "general").toLowerCase();

    scopeEl.value = currentScope;
    setTabs(currentScope);
    persistScope(currentScope);
    showPanelsForScope(currentScope);

    // reset UI text
    statusText.textContent = "Chargement‚Ä¶";
    btnValidate.disabled = true;
    validatedBox.style.display = "none";
    teamList.innerHTML = "";
    playerList.innerHTML = "";
  }

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelRank.style.display = "none";
    stopListeners();
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    applyScope(currentScope);

    scopeEl.onchange = ()=>{
      applyScope(scopeEl.value || "general");
    };
  }

  // Events
  btnValidate.onclick = async (e)=>{
    e.preventDefault();
    if(btnValidate.disabled) return;

    const ok = confirm("Valider le classement final ?\n\n‚ö†Ô∏è Action enregistr√©e en base.");
    if(!ok) return;

    btnValidate.disabled = true;
    try{
      await validateClassement();
      alert("‚úÖ Classement valid√© !");
    }catch(err){
      console.error(err);
      alert("Erreur Firestore ‚ùå");
    }finally{
      render();
    }
  };

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // Guard
  const g = await requireRole(["admin"]);
  if(!g.ok){
    showDenied();
  }else{
    showAdmin();
  }

  // robuste si session change
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
