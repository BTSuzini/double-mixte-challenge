<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” RÃ©sultats</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">
        ğŸ RÃ©sultats (admin)<br>
        <span style="opacity:.95;font-weight:800;" id="pageSub">Ã‰tape â€”</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- âœ… Bandeau identique partout -->
    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Encart Zone (mÃªme partout) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ›ï¸ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">GÃ©nÃ©ral</option>
        <option value="etape1">Ã‰tape 1</option>
        <option value="etape2">Ã‰tape 2</option>
        <option value="etape3">Ã‰tape 3</option>
        <option value="etape4">Ã‰tape 4</option>
        <option value="etape5">Ã‰tape 5</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- =========================
       CONTENU PAGE (aprÃ¨s Zone)
  ========================== -->

  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">â„¹ï¸ Choisir une Ã©tape</h2>
    <p class="muted" style="margin:0;">
      SÃ©lectionne une <b>Ã‰tape</b> dans â€œZoneâ€ pour gÃ©rer les rÃ©sultats.
      (Le GÃ©nÃ©ral se gÃ¨re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <section class="card" id="panelResults" style="display:none;">
    <h2>ğŸ RÃ©sultats</h2>
    <p class="muted">Ã€ venir.</p>
  </section>

</main>

<script type="module">
  import { auth } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // ---- scope (URL ?scope=etape1)
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope") || "etape1";

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const pageSub = document.getElementById("pageSub");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelResults  = document.getElementById("panelResults");

  // ---- state
  let currentScope = scopeFromUrl;

  function stepLabel(scope){
    if(!scope || scope === "general") return "GÃ©nÃ©ral";
    const n = scope.replace("etape","");
    return `Ã‰tape ${n}`;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      hintEl.textContent = "Zone GÃ©nÃ©ral : se gÃ¨re depuis admin/index.html (infos).";
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "ğŸ“° Aller aux infos (GÃ©nÃ©ral)";
      tabsEl.appendChild(a);
      return;
    }

    hintEl.textContent = "Zone Ã‰tape : Ã©quipes / inscriptions / rÃ©sultats.";

    const links = [
      ["ğŸ‘¥ Ã‰quipes", "equipes.html"],
      ["ğŸ“ Inscriptions", "inscriptions.html"],
      ["ğŸ RÃ©sultats", "resultats.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      // highlight onglet courant
      if(url === "resultats.html"){
        a.style.fontWeight = "900";
      }

      tabsEl.appendChild(a);
    }
  }

  function showPanelsForScope(scope){
    pageSub.textContent = scope === "general" ? "GÃ©nÃ©ral" : `${stepLabel(scope)} â€” BT250`;

    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelResults.style.display = "none";
      return;
    }

    panelNeedStep.style.display = "none";
    panelResults.style.display = "block";
  }

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelResults.style.display = "none";
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    scopeEl.value = currentScope;
    setTabs(currentScope);
    showPanelsForScope(currentScope);

    scopeEl.onchange = ()=>{
      currentScope = scopeEl.value || "general";
      setTabs(currentScope);
      showPanelsForScope(currentScope);
    };
  }

  // Guard (persistance gÃ©rÃ©e via session.js)
  const g = await requireRole(["admin"]);
  if(!g.ok){
    showDenied();
  }else{
    showAdmin();
  }

  // robuste si session change
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });

  // Logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };
</script>

</body>
</html>
