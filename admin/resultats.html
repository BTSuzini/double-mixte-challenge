<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî R√©sultats</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260225-admin-resultats" />

  <style>
    /* ‚úÖ pas de scroll horizontal */
    html, body{ max-width:100%; overflow-x:hidden; }

    /* ‚úÖ Onglet actif = gris clair (tabs Zone) */
    .btn.is-active{
      background:#f1f1f1 !important;
      border-color:#d7d7d7 !important;
      color:#111 !important;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }

    .match-list{ display:flex; flex-direction:column; gap:14px; }

    .match-card{
      border-radius:18px;
      border:2px solid rgba(0,0,0,.06);
      padding:14px;
      background:#fff;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .match-card.courtA{ background:#FFF6D6; border-color:rgba(255, 196, 0, .35); }
    .match-card.courtB{ background:#FFE6EA; border-color:rgba(255, 0, 60, .25); }

    .match-head{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex-wrap:wrap; /* ‚úÖ √©vite les d√©bordements */
    }
    .m-slot{
      font-size:12px;
      font-weight:900;
      opacity:.7;
      white-space:nowrap;
    }
    .m-time{
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
      letter-spacing:.2px;
    }
    .m-court{
      font-size:13px;
      font-weight:400;
      font-style:italic;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:1;
    }

    /* ‚úÖ 2 lignes (√©quipe A / √©quipe B), cases en face */
    .score-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns: minmax(0,1fr) 48px 48px 48px;
      gap:8px 8px;
      align-items:center;
      max-width:100%;
    }

    .team{
      min-width:0;
    }
    .team-title{
      font-size:15px;
      font-weight:1000;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .team-sub{
      margin-top:2px;
      font-size:13px;
      font-weight:800;
      opacity:.85;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sc{
      width:48px;
      height:38px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fff;
      font-weight:1000;
      text-align:center;
      outline:none;
      font-variant-numeric: tabular-nums;
      padding:0;
    }

    .hdr{
      font-size:11px;
      font-weight:1000;
      opacity:.6;
      text-align:center;
      white-space:nowrap;
    }

    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .mini{ font-size:12px; font-weight:900; opacity:.75; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fafafa;
      font-weight:1000;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      display:inline-block;
      background:#bbb;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .dot.red{ background:#e74c3c; }
    .dot.orange{ background:#f39c12; }
    .dot.green{ background:#2ecc71; }

    @media (max-width: 380px){
      .team-title{ font-size:14px; }
      .team-sub{ font-size:12px; }
      .score-grid{ grid-template-columns: minmax(0,1fr) 42px 42px 42px; }
      .sc{ width:42px; height:36px; }
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">üè† Accueil public</a>
      <a href="#" id="btnLogout">üö™ D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Zone -->
  <section class="card" id="adminZone" style="display:none;">
    <h2 style="margin:0 0 10px;">üß≠ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">üåê G√©n√©ral</option>
        <option value="etape1">üéæ √âtape 1</option>
        <option value="etape2">üéæ √âtape 2</option>
        <option value="etape3">üéæ √âtape 3</option>
        <option value="etape4">üéæ √âtape 4</option>
        <option value="etape5">üß™ √âtape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
  </section>

  <!-- ‚úÖ dessous Zone : panneaux -->
  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">‚ÑπÔ∏è Choisir une √©tape</h2>
    <p class="muted" style="margin:0;">
      S√©lectionne une <b>√âtape</b> dans ‚ÄúZone‚Äù pour saisir les r√©sultats.
      <br>(Le <b>G√©n√©ral</b> se g√®re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <section class="card" id="panelResults" style="display:none;">
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; justify-content:space-between;">
      <div>
        <h2 style="margin:0 0 6px;">üèÅ R√©sultats</h2>
        <p class="muted" id="statusText" style="margin:0;">Chargement‚Ä¶</p>
      </div>

      <a class="btn" id="btnOpenPublic" href="#" style="font-weight:900; color:#111; text-align:center;">
        üëÄ Ouvrir la page R√©sultats (public)
      </a>
    </div>

    <div id="adminList" style="margin-top:12px;"></div>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, getDoc, setDoc, onSnapshot, serverTimestamp, collection } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const LS_SCOPE_KEY = "admin_scope_last";

  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope");

  function getInitialScope(){
    if(scopeFromUrl) return scopeFromUrl;
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved) return saved;
    }catch(e){}
    return "etape1";
  }
  function persistScope(scope){
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}
  }

  // DOM
  const accessDenied = document.getElementById("accessDenied");
  const adminZone = document.getElementById("adminZone");
  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelResults = document.getElementById("panelResults");

  const statusText = document.getElementById("statusText");
  const adminList  = document.getElementById("adminList");
  const btnOpenPublic = document.getElementById("btnOpenPublic");

  // state
  let currentScope = getInitialScope();
  let unsubProg = null;
  let unsubRes  = null;

  let currentProg = null;
  let resultsByMatch = new Map(); // matchId -> result doc

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "üì∞ Aller √† Admin ‚Äî G√©n√©ral";
      tabsEl.appendChild(a);
      return;
    }

    if(scope === "etape5"){
      tabsEl.appendChild(makeDisabledBtn("üçΩÔ∏è Repas (plus tard)", "Repas non activ√© pour l‚Äô√©tape 5 (zone test)."));
    }

    const links = [
      ["üë• √âquipes",        "equipes.html"],
      ["üìù Inscriptions",   "inscriptions.html"],
      ...(scope !== "etape5" ? [["üçΩÔ∏è Repas", "repas.html"]] : []),
      ["üé≤ Tirage",         "tirage.html"],
      ["üìÖ Programmation",  "programmation.html"],
      ["üèÅ R√©sultats",      "resultats.html"],
      ["üèÜ Classement",     "classement.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;
      if(url === "resultats.html") a.classList.add("is-active"); // ‚úÖ gris clair
      tabsEl.appendChild(a);
    }
  }

  function stopListeners(){
    if(unsubProg){ unsubProg(); unsubProg = null; }
    if(unsubRes){ unsubRes(); unsubRes = null; }
    currentProg = null;
    resultsByMatch = new Map();
  }

  // refs
  function progRef(scope){ return doc(db, "programmations", scope); }
  function resultsCol(scope){ return collection(db, `resultats_${scope}`); }

  function courtLabel(prog, courtKey){
    const name = prog?.courts?.[courtKey] || courtKey || "‚Äî";
    const emo = (courtKey === "A") ? "üêù" : (courtKey === "B" ? "üå∂Ô∏è" : "üéæ");
    return `${emo} ${name} ${emo}`;
  }
  function courtClass(courtKey){
    return (courtKey === "A") ? "courtA" : (courtKey === "B" ? "courtB" : "");
  }

  function normalizeScheduleEntry(entry, slotObj){
    if(typeof entry === "number"){
      const slot = Number(entry);
      const court = slotObj?.court || (slot % 2 === 1 ? "A" : "B");
      return { slot, court };
    }
    if(entry && typeof entry === "object"){
      const slot = Number(entry.slot);
      const court = entry.court || slotObj?.court || (slot % 2 === 1 ? "A" : "B");
      return { slot, court };
    }
    const fallbackSlot = Number(slotObj?.slot || 1);
    return { slot: fallbackSlot, court: slotObj?.court || "A" };
  }

  function teamPartsFromTeam(t){
    if(!t) return { title:"‚Äî", sub:"" };
    return {
      title: t.teamName || "√âquipe",
      sub: `${t.p1FirstName || "?"} / ${t.p2FirstName || "?"}`
    };
  }

  function teamRefParts(prog, ref){
    if(!ref) return { title:"‚Äî", sub:"" };

    if(ref.type === "team"){
      const t = prog?.teams?.[ref.key] || null;
      return t ? teamPartsFromTeam(t) : { title: ref.key, sub:"" };
    }
    if(ref.type === "winner") return { title: `V${ref.matchId.slice(1)}`, sub:"" };
    if(ref.type === "loser")  return { title: `P${ref.matchId.slice(1)}`, sub:"" };

    return { title:"‚Äî", sub:"" };
  }

  function readCardScores(card){
    const get = (k)=>{
      const el = card.querySelector(`input[data-k="${k}"]`);
      return el ? (el.value || "").trim() : "";
    };
    return {
      s1A: get("s1A"), s2A: get("s2A"), s3A: get("s3A"),
      s1B: get("s1B"), s2B: get("s2B"), s3B: get("s3B"),
    };
  }

  function sanitize(v){
    const s = String(v ?? "").trim();
    return s === "" ? null : s;
  }

  function winnerFromScores(x){
    // x are strings or null
    const sets = [
      [x.s1A, x.s1B],
      [x.s2A, x.s2B],
      [x.s3A, x.s3B],
    ];

    let a=0,b=0;
    for(const [A,B] of sets){
      const nA = (A === null) ? null : Number(A);
      const nB = (B === null) ? null : Number(B);
      if(!Number.isFinite(nA) || !Number.isFinite(nB)) continue;
      if(nA === nB) continue;
      if(nA > nB) a++; else b++;
    }
    if(a >= 2 && a > b) return "A";
    if(b >= 2 && b > a) return "B";
    return null;
  }

  function statusBadge(stored){
    const w = stored?.winnerSide;
    const any = ["s1A","s1B","s2A","s2B","s3A","s3B"].some(k => stored?.[k] !== null && stored?.[k] !== undefined && String(stored?.[k]).trim() !== "");
    if(w === "A" || w === "B") return { label:"Valid√©", dot:"green" };
    if(any) return { label:"En cours", dot:"orange" };
    return { label:"Non saisi", dot:"red" };
  }

  function render(){
    if(currentScope === "general"){
      statusText.textContent = "Choisis une √©tape.";
      adminList.innerHTML = "";
      return;
    }

    btnOpenPublic.href = `../${currentScope}/resultats.html`;

    if(!currentProg){
      statusText.textContent = "‚ÑπÔ∏è Programmation introuvable. G√©n√®re-la d‚Äôabord dans ‚ÄúProgrammation‚Äù.";
      adminList.innerHTML = "";
      return;
    }

    const matches = currentProg.matches || {};
    const slots = Array.isArray(currentProg.slots) ? currentProg.slots : [];
    const schedule = currentProg.schedule || {};

    // slot -> matchId
    const slotToMatch = new Map();
    for(const [mid, entry] of Object.entries(schedule)){
      const slotNum = (typeof entry === "number") ? Number(entry) : Number(entry?.slot);
      const sObj = slots.find(x => Number(x.slot) === slotNum) || null;
      const norm = normalizeScheduleEntry(entry, sObj);
      if(!slotToMatch.has(norm.slot)){
        slotToMatch.set(norm.slot, mid);
      }
    }

    const cards = [];
    let done = 0, total = 0;

    for(const s of slots){
      const mid = slotToMatch.get(Number(s.slot));
      const m = mid ? matches[mid] : null;
      if(!m) continue;

      total++;

      const a = teamRefParts(currentProg, m.A);
      const b = teamRefParts(currentProg, m.B);

      const entry = schedule[mid];
      const norm = normalizeScheduleEntry(entry, s);
      const courtKey = norm.court;

      const stored = resultsByMatch.get(mid) || {};
      const badge = statusBadge(stored);
      if(badge.dot === "green") done++;

      cards.push(`
        <div class="match-card ${esc(courtClass(courtKey))}" data-mid="${esc(mid)}">
          <div class="match-head">
            <div class="m-slot">#${esc(s.slot)} ¬∑ ${esc(mid)}</div>
            <div class="m-time">${esc(s.time || "‚Äî")}</div>
            <div class="m-court">${esc(courtLabel(currentProg, courtKey))}</div>
            <div class="pill"><span class="dot ${esc(badge.dot)}"></span>${esc(badge.label)}</div>
          </div>

          <div class="score-grid" aria-label="Saisie scores">
            <div class="hdr"></div>
            <div class="hdr">S1</div>
            <div class="hdr">S2</div>
            <div class="hdr">S3</div>

            <!-- ‚úÖ √âquipe A (ligne 1) -->
            <div class="team">
              <div class="team-title">${esc(a.title)}</div>
              ${a.sub ? `<div class="team-sub">${esc(a.sub)}</div>` : ``}
            </div>
            <input class="sc" inputmode="numeric" pattern="[0-9]*" maxlength="2" data-k="s1A" value="${esc(stored.s1A ?? "")}">
            <input class="sc" inputmode="numeric" pattern="[0-9]*" maxlength="2" data-k="s2A" value="${esc(stored.s2A ?? "")}">
            <input class="sc" inputmode="numeric" pattern="[0-9]*" maxlength="2" data-k="s3A" value="${esc(stored.s3A ?? "")}">

            <!-- ‚úÖ √âquipe B (ligne 2) -->
            <div class="team">
              <div class="team-title">${esc(b.title)}</div>
              ${b.sub ? `<div class="team-sub">${esc(b.sub)}</div>` : ``}
            </div>
            <input class="sc" inputmode="numeric" pattern="[0-9]*" maxlength="2" data-k="s1B" value="${esc(stored.s1B ?? "")}">
            <input class="sc" inputmode="numeric" pattern="[0-9]*" maxlength="2" data-k="s2B" value="${esc(stored.s2B ?? "")}">
            <input class="sc" inputmode="numeric" pattern="[0-9]*" maxlength="2" data-k="s3B" value="${esc(stored.s3B ?? "")}">
          </div>

          <div class="actions">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" data-act="save" style="font-weight:900; color:#111;">üíæ Enregistrer</button>
              <button class="btn" data-act="clear" style="font-weight:900; color:#111; border-color:#f1b2b2;">üßΩ Effacer</button>
            </div>
            <div class="mini muted">winnerSide: <b data-winner>${esc(stored.winnerSide || "‚Äî")}</b></div>
          </div>
        </div>
      `);
    }

    statusText.textContent = `üü¢ En direct ‚Äî ${done}/${total} match(s) valid√©(s)`;
    adminList.innerHTML = cards.length
      ? `<div class="match-list">${cards.join("")}</div>`
      : `<p class="muted">Aucun match.</p>`;
  }

  async function saveMatch(mid, card){
    const raw = readCardScores(card);
    const data = {
      s1A: sanitize(raw.s1A), s2A: sanitize(raw.s2A), s3A: sanitize(raw.s3A),
      s1B: sanitize(raw.s1B), s2B: sanitize(raw.s2B), s3B: sanitize(raw.s3B),
    };
    data.winnerSide = winnerFromScores(data); // "A" | "B" | null

    await setDoc(doc(resultsCol(currentScope), mid), {
      ...data,
      updatedAt: serverTimestamp(),
      updatedBy: auth.currentUser?.email || null
    }, { merge:true });
  }

  async function clearMatch(mid){
    await setDoc(doc(resultsCol(currentScope), mid), {
      s1A:null,s2A:null,s3A:null,
      s1B:null,s2B:null,s3B:null,
      winnerSide:null,
      updatedAt: serverTimestamp(),
      updatedBy: auth.currentUser?.email || null
    }, { merge:true });
  }

  function updateWinnerPreview(card){
    const raw = readCardScores(card);
    const data = {
      s1A: sanitize(raw.s1A), s2A: sanitize(raw.s2A), s3A: sanitize(raw.s3A),
      s1B: sanitize(raw.s1B), s2B: sanitize(raw.s2B), s3B: sanitize(raw.s3B),
    };
    const w = winnerFromScores(data);
    const el = card.querySelector("[data-winner]");
    if(el) el.textContent = w || "‚Äî";
  }

  adminList.addEventListener("input", (e)=>{
    const card = e.target.closest(".match-card");
    if(card) updateWinnerPreview(card);
  });

  adminList.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;

    const card = btn.closest(".match-card");
    const mid = card?.dataset?.mid;
    if(!mid) return;

    const act = btn.dataset.act;

    btn.disabled = true;
    try{
      if(act === "save"){
        await saveMatch(mid, card);
      }
      if(act === "clear"){
        const ok = confirm("Effacer ce r√©sultat ?\n\n‚ö†Ô∏è Les scores seront remis √† vide.");
        if(!ok) return;
        await clearMatch(mid);
      }
    }catch(err){
      console.error(err);
      alert("‚ùå Erreur Firestore (droits / rules ?).");
    }finally{
      btn.disabled = false;
    }
  });

  // listeners
  function startProgListener(scope){
    if(unsubProg){ unsubProg(); unsubProg = null; }
    unsubProg = onSnapshot(progRef(scope), (snap)=>{
      currentProg = snap.exists() ? (snap.data() || {}) : null;
      render();
    }, (err)=>{
      console.error(err);
      currentProg = null;
      render();
    });
  }

  function startResultsListener(scope){
    if(unsubRes){ unsubRes(); unsubRes = null; }
    unsubRes = onSnapshot(resultsCol(scope), (snap)=>{
      resultsByMatch = new Map();
      snap.forEach(d => resultsByMatch.set(d.id, d.data() || {}));
      render();
    }, (err)=> console.error(err));
  }

  function showPanelsForScope(scope){
    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelResults.style.display = "none";
      stopListeners();
      return;
    }

    panelNeedStep.style.display = "none";
    panelResults.style.display = "block";
    startProgListener(scope);
    startResultsListener(scope);
  }

  // logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  function showDenied(){
    accessDenied.style.display = "block";
    adminZone.style.display = "none";
    panelNeedStep.style.display = "none";
    panelResults.style.display = "none";
    stopListeners();
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminZone.style.display = "block";

    scopeEl.value = currentScope;
    setTabs(currentScope);
    showPanelsForScope(currentScope);
    persistScope(currentScope);

    scopeEl.onchange = ()=>{
      currentScope = scopeEl.value || "general";
      setTabs(currentScope);
      showPanelsForScope(currentScope);
      persistScope(currentScope);
    };
  }

  // Guard
  const g = await requireRole(["admin"]);
  if(!g.ok){ showDenied(); } else { showAdmin(); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
