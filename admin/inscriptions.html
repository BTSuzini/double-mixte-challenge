<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Inscriptions</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260222" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <!-- âœ… mÃªme bandeau que le rÃ¨glement (centre = image) -->
      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>


      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- âœ… Bandeau identique partout -->
    <nav class="nav">
      <a href="../index.html">ğŸ  Accueil public</a>
      <a href="#" id="btnLogout">ğŸšª DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Encart Zone (identique partout) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§­ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">ğŸŒ GÃ©nÃ©ral</option>
        <option value="etape1">ğŸ¾ Ã‰tape 1</option>
        <option value="etape2">ğŸ¾ Ã‰tape 2</option>
        <option value="etape3">ğŸ¾ Ã‰tape 3</option>
        <option value="etape4">ğŸ¾ Ã‰tape 4</option>
        <option value="etape5">ğŸ§ª Ã‰tape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- =========================
       CONTENU PAGE (aprÃ¨s Zone)
       => Statut + RAZ
  ========================== -->

  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">â„¹ï¸ Choisir une Ã©tape</h2>
    <p class="muted" style="margin:0;">
      SÃ©lectionne une <b>Ã‰tape</b> dans â€œZoneâ€ pour gÃ©rer le statut des inscriptions et faire une RAZ.
      <br>(Le <b>GÃ©nÃ©ral</b> se gÃ¨re depuis <b>admin/index.html</b>.)
    </p>
  </section>

  <section class="card" id="panelInscriptions" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ›ï¸ Statut des inscriptions</h2>

    <p class="muted" id="currentState" style="margin:0;">Chargementâ€¦</p>
    <p class="muted" id="statusMsg" style="margin-top:8px;"></p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnNotOpen" style="font-weight:800; color:#111;">ğŸ’¤ Pas encore ouvertes</button>
      <button class="btn" id="btnOpen" style="font-weight:800; color:#111;">âœ… Ouvrir</button>
      <button class="btn" id="btnSuspend" style="font-weight:800; color:#111;">â¸ï¸ Suspendre</button>
      <button class="btn" id="btnClose" style="font-weight:800; color:#111;">ğŸ”’ ClÃ´turer</button>
    </div>

    <p class="muted" style="margin-top:12px;">
      âš ï¸ Le public voit lâ€™Ã©tat (ouvertes / suspendues / clÃ´turÃ©es / pas encore ouvertes).<br>
      Les rÃ¨gles Firestore bloquent aussi lâ€™Ã©criture si ce nâ€™est pas â€œopenâ€.
    </p>
  </section>

  <section class="card" id="panelRAZ" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§¹ Maintenance</h2>

    <p class="muted" style="margin:0;">
      Cette action supprime <b>toutes</b> les inscriptions de lâ€™Ã©tape (privÃ© + public) et remet le statut Ã 
      <b>Pas encore ouvertes</b>.<br>
      âš ï¸ <b>IrrÃ©versible</b>.
    </p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnRAZ" style="font-weight:900; color:#111; border-color:#f1b2b2;">
        ğŸ§¨ RAZ â€” Supprimer toutes les inscriptions de lâ€™Ã©tape
      </button>
    </div>

    <p class="muted" id="razStatus" style="margin-top:10px;"></p>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, setDoc, onSnapshot, serverTimestamp,
    collection, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const LS_SCOPE_KEY = "admin_scope_last";

  // ---- scope (URL ?scope=etape1) + fallback localStorage
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope");

  function getInitialScope(){
    if(scopeFromUrl) return scopeFromUrl;
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved) return saved;
    }catch(e){}
    return "etape1";
  }

  function persistScope(scope){
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}
  }

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const pageSub = document.getElementById("pageSub");

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelInscriptions = document.getElementById("panelInscriptions");
  const panelRAZ = document.getElementById("panelRAZ");

  const currentStateEl = document.getElementById("currentState");
  const statusMsgEl = document.getElementById("statusMsg");

  const btnNotOpen = document.getElementById("btnNotOpen");
  const btnOpen = document.getElementById("btnOpen");
  const btnSuspend = document.getElementById("btnSuspend");
  const btnClose = document.getElementById("btnClose");

  const btnRAZ = document.getElementById("btnRAZ");
  const razStatus = document.getElementById("razStatus");

  // ---- state
  let currentScope = getInitialScope();
  let currentState = null;
  let unsubGate = null;

  function stepLabel(scope){
    if(!scope || scope === "general") return "GÃ©nÃ©ral";
    const n = scope.replace("etape","");
    return `Ã‰tape ${n}`;
  }

  // Compat : certains Ã©crans utilisaient paused, d'autres suspended
  function normalizeState(state){
    if(state === "paused") return "suspended";
    return state || "not_open";
  }

  function labelFor(stateRaw){
    const state = normalizeState(stateRaw);
    switch(state){
      case "not_open": return "ğŸ’¤ Pas encore ouvertes";
      case "open": return "âœ… Ouvertes";
      case "suspended": return "â¸ï¸ Suspendues";
      case "closed": return "ğŸ”’ ClÃ´turÃ©es";
      default: return "â€”";
    }
  }

  function publicMessage(stateRaw){
    const state = normalizeState(stateRaw);
    switch(state){
      case "not_open": return "Le public voit : â€œLes inscriptions ne sont pas encore ouvertes.â€";
      case "open": return "Le public voit : â€œInscriptions ouvertes âœ…â€ (formulaire actif).";
      case "suspended": return "Le public voit : â€œInscriptions suspendues â¸ï¸â€ (formulaire bloquÃ©).";
      case "closed": return "Le public voit : â€œInscriptions clÃ´turÃ©es ğŸ”’â€ (formulaire bloquÃ©).";
      default: return "";
    }
  }

  function setButtonsDisabled(disabled){
    [btnNotOpen, btnOpen, btnSuspend, btnClose, btnRAZ].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle("disabled", disabled);
    });
  }

  function stopGateListener(){
    if(unsubGate){
      unsubGate();
      unsubGate = null;
    }
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      hintEl.textContent = "ğŸŒ Zone GÃ©nÃ©ral : gestion des infos dans admin/index.html.";
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "ğŸ“° Aller Ã  Admin â€” Gestion (infos)";
      tabsEl.appendChild(a);
      return;
    }

    hintEl.textContent = "ğŸ¾ Zone Ã‰tape : Ã©quipes / inscriptions / tirage / programmation / rÃ©sultats.";

    if(scope === "etape5"){
      tabsEl.appendChild(makeDisabledBtn("ğŸ½ï¸ Repas (plus tard)", "Repas non activÃ© pour lâ€™Ã©tape 5 (zone test)."));
    }

    const links = [
      ["ğŸ‘¥ Ã‰quipes",        "equipes.html"],
      ["ğŸ“ Inscriptions",   "inscriptions.html"],
      ...(scope !== "etape5" ? [["ğŸ½ï¸ Repas", "repas.html"]] : []),
      ["ğŸ² Tirage",         "tirage.html"],
      ["ğŸ“… Programmation",  "programmation.html"],
      ["ğŸ RÃ©sultats",      "resultats.html"],
    ];

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      if(url === "inscriptions.html"){
        a.style.fontWeight = "900";
      }
      tabsEl.appendChild(a);
    }
  }

  function showPanelsForScope(scope){
    pageSub.textContent = (scope === "general")
      ? "GÃ©nÃ©ral"
      : `${stepLabel(scope)} â€” BT250`;

    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelInscriptions.style.display = "none";
      panelRAZ.style.display = "none";
      stopGateListener();
      return;
    }

    panelNeedStep.style.display = "none";
    panelInscriptions.style.display = "block";
    panelRAZ.style.display = "block";

    stopGateListener();

    const cfgRef = doc(db, "config", scope); // ex: config/etape5
    unsubGate = onSnapshot(cfgRef, (snap)=>{
      const raw = snap.exists() ? (snap.data().inscriptionsState || "not_open") : "not_open";
      const state = normalizeState(raw);

      currentState = state;
      currentStateEl.innerHTML = `Statut actuel : <strong>${labelFor(state)}</strong>`;
      statusMsgEl.textContent = publicMessage(state);

      btnSuspend.textContent = (state === "suspended") ? "â–¶ï¸ RÃ©activer" : "â¸ï¸ Suspendre";
    }, (err)=>{
      console.error(err);
      currentStateEl.textContent = "âŒ Impossible de lire le statut.";
      statusMsgEl.textContent = "";
    });
  }

  async function setState(nextRaw){
    if(currentScope === "general"){
      alert("Choisis une Ã©tape.");
      return;
    }

    const next = normalizeState(nextRaw);

    if(next === "closed"){
      const ok = confirm("ClÃ´turer les inscriptions ?\n\nLe public verra â€œclÃ´turÃ©esâ€ et ne pourra plus sâ€™inscrire.");
      if(!ok) return;
    }
    if(next === "not_open"){
      const ok = confirm("Mettre â€œpas encore ouvertesâ€ ?\n\nLe public verra que ce nâ€™est pas ouvert, formulaire bloquÃ©.");
      if(!ok) return;
    }

    const cfgRef = doc(db, "config", currentScope);

    setButtonsDisabled(true);
    statusMsgEl.textContent = "Mise Ã  jourâ€¦";

    try{
      // merge:true => crÃ©e le doc si absent
      await setDoc(cfgRef, {
        inscriptionsState: next,
        updatedAt: serverTimestamp()
      }, { merge:true });

      statusMsgEl.textContent = "âœ… Statut mis Ã  jour.";
    }catch(e){
      console.error(e);
      statusMsgEl.textContent = "âŒ Erreur : impossible de mettre Ã  jour.";
    }finally{
      setButtonsDisabled(false);
    }
  }

  // actions
  btnNotOpen.onclick = ()=> setState("not_open");
  btnOpen.onclick = ()=> setState("open");

  btnSuspend.onclick = ()=>{
    if(currentState === "suspended") setState("open");
    else setState("suspended");
  };

  btnClose.onclick = ()=> setState("closed");

  // ---- RAZ helper: delete a collection in batches
  async function deleteCollectionInBatches(colName, batchSize=450){
    let deleted = 0;

    while(true){
      const snap = await getDocs(collection(db, colName));
      if(snap.empty) break;

      const docs = snap.docs.slice(0, batchSize);
      const batch = writeBatch(db);
      docs.forEach(d => batch.delete(d.ref));
      await batch.commit();

      deleted += docs.length;
      if(docs.length < batchSize) break;
    }

    return deleted;
  }

  async function doRAZ(){
    if(currentScope === "general"){
      alert("Choisis une Ã©tape.");
      return;
    }

    const stepLbl = stepLabel(currentScope);

    const ok1 = confirm(
      "âš ï¸ RAZ INSCRIPTIONS\n\nCette action supprime TOUTES les inscriptions (privÃ© + public) pour " + stepLbl + ".\n\nContinuer ?"
    );
    if(!ok1) return;

    const typed = prompt('Tape exactement : RAZ\n\n(pour confirmer la suppression complÃ¨te)');
    if(typed !== "RAZ"){
      alert("AnnulÃ©.");
      return;
    }

    const COL_PRIVATE = `inscriptions_${currentScope}_private`;
    const COL_PUBLIC  = `equipes_${currentScope}_public`;
    const cfgRef = doc(db, "config", currentScope);

    setButtonsDisabled(true);
    razStatus.textContent = "Suppression en coursâ€¦";

    try{
      await setDoc(cfgRef, { inscriptionsState: "not_open", updatedAt: serverTimestamp() }, { merge:true });

      const delPublic  = await deleteCollectionInBatches(COL_PUBLIC);
      const delPrivate = await deleteCollectionInBatches(COL_PRIVATE);

      razStatus.textContent = `âœ… RAZ OK â€” supprimÃ©s : public=${delPublic}, privÃ©=${delPrivate}. Statut remis Ã  â€œPas encore ouvertesâ€.`;
      alert(`RAZ terminÃ© âœ…\n\nSupprimÃ©s :\n- Public: ${delPublic}\n- PrivÃ©: ${delPrivate}\n\nStatut : pas encore ouvertes`);
    }catch(e){
      console.error(e);
      razStatus.textContent = "âŒ Erreur pendant le RAZ. Voir console.";
      alert("Erreur pendant le RAZ âŒ\n\nOuvre la console pour le dÃ©tail.");
    }finally{
      setButtonsDisabled(false);
    }
  }

  btnRAZ.onclick = doRAZ;

  // logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelInscriptions.style.display = "none";
    panelRAZ.style.display = "none";
    stopGateListener();
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    scopeEl.value = currentScope;
    setTabs(currentScope);
    showPanelsForScope(currentScope);
    persistScope(currentScope);

    scopeEl.onchange = ()=>{
      currentScope = scopeEl.value || "general";
      setTabs(currentScope);
      showPanelsForScope(currentScope);
      persistScope(currentScope);
    };
  }

  // guard
  const g = await requireRole(["admin"]);
  if(!g.ok){
    showDenied();
  }else{
    showAdmin();
  }

  // robuste si session change
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
