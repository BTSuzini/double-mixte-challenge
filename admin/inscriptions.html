<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Inscriptions</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title" id="pageTitle">
        Inscriptions (admin)<br><span style="opacity:.95;font-weight:800;" id="pageSub">Ã‰tape â€”</span>
      </h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="#" id="tabEquipes">ğŸ‘¥ Ã‰quipes</a>
      <a href="#" id="tabInscriptions" aria-current="page">ğŸ“ Inscriptions</a>
      <a href="#" id="tabResultats">ğŸ RÃ©sultats</a>
      <a href="#" id="btnPublic">Vue publique</a>
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ›ï¸ Statut des inscriptions</h2>

    <p class="muted" id="currentState" style="margin:0;">Chargementâ€¦</p>
    <p class="muted" id="statusMsg" style="margin-top:8px;"></p>

    <div class="grid" style="margin-top:12px;">
      <button class="btn" id="btnNotOpen" style="font-weight:800; color:#111;">ğŸ’¤ Pas encore ouvertes</button>
      <button class="btn" id="btnOpen" style="font-weight:800; color:#111;">âœ… Ouvrir</button>
      <button class="btn" id="btnPause" style="font-weight:800; color:#111;">â¸ï¸ Suspendre</button>
      <button class="btn" id="btnClose" style="font-weight:800; color:#111;">ğŸ”’ ClÃ´turer</button>
    </div>

    <p class="muted" style="margin-top:12px;">
      âš ï¸ Le public voit lâ€™Ã©tat en direct (ouvertes / suspendues / clÃ´turÃ©es / pas encore ouvertes).<br>
      Les rules Firestore bloquent aussi lâ€™Ã©criture tant que ce nâ€™est pas â€œopenâ€.
    </p>
  </section>

</main>

<style>
  /* Simple feedback visuel sur l'Ã©tat courant */
  .btn.active{
    border-color:#cfcfcf !important;
    background:#fff !important;
    box-shadow: 0 6px 14px rgba(0,0,0,.06);
  }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- scope
  const params = new URLSearchParams(location.search);
  const scope = params.get("scope") || "etape1"; // default etape1
  const stepNum = scope.replace("etape","");
  const stepLabel = `Ã‰tape ${stepNum}`;

  // ---- UI title
  document.getElementById("pageSub").textContent = `${stepLabel} â€” BT250`; // tu ajusteras par Ã©tape plus tard

  // ---- nav keep scope
  document.getElementById("tabEquipes").href = `equipes.html?scope=${encodeURIComponent(scope)}`;
  document.getElementById("tabInscriptions").href = `inscriptions.html?scope=${encodeURIComponent(scope)}`;
  document.getElementById("tabResultats").href = `resultats.html?scope=${encodeURIComponent(scope)}`;

  // Vue publique
  document.getElementById("btnPublic").onclick = (e)=>{
    e.preventDefault();
    if(scope === "etape1") window.location.href = "../etape1/inscriptions.html";
    else alert("Vue publique non encore prÃªte pour " + stepLabel);
  };

  // ---- dom
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const currentStateEl = document.getElementById("currentState");
  const statusMsgEl = document.getElementById("statusMsg");

  const btnNotOpen = document.getElementById("btnNotOpen");
  const btnOpen = document.getElementById("btnOpen");
  const btnPause = document.getElementById("btnPause");
  const btnClose = document.getElementById("btnClose");

  // ---- config doc
  const cfgRef = doc(db, "config", scope); // ex: config/etape1

  // ğŸ”‘ Ã©tats utilisÃ©s partout
  // - rules: open | paused | closed
  // - "pas encore ouvertes": on stocke "not_open" (et cÃ´tÃ© public c'est traitÃ© comme non-open => formulaire bloquÃ©)
  function normalizeState(state){
    // compat ancienne valeur "suspended"
    if(state === "suspended") return "paused";
    return state || "not_open";
  }

  function labelFor(state){
    switch(state){
      case "not_open": return "ğŸ’¤ Pas encore ouvertes";
      case "open": return "âœ… Ouvertes";
      case "paused": return "â¸ï¸ Suspendues";
      case "closed": return "ğŸ”’ ClÃ´turÃ©es";
      default: return "â€”";
    }
  }

  function publicMessage(state){
    switch(state){
      case "not_open": return "Le public voit : â€œLes inscriptions ne sont pas encore ouvertes.â€";
      case "open": return "Le public voit : â€œInscriptions ouvertes âœ…â€ (formulaire actif).";
      case "paused": return "Le public voit : â€œInscriptions temporairement suspendues â¸ï¸â€ (formulaire bloquÃ©).";
      case "closed": return "Le public voit : â€œInscriptions clÃ´turÃ©es ğŸ”’â€ (formulaire bloquÃ©).";
      default: return "";
    }
  }

  let currentState = "not_open";

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const r = await getRoleByEmail(u.email);
    return r === "admin";
  }

  function setButtonsDisabled(disabled){
    [btnNotOpen, btnOpen, btnPause, btnClose].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle("disabled", disabled);
    });
  }

  function setActiveButton(state){
    [btnNotOpen, btnOpen, btnPause, btnClose].forEach(b=> b.classList.remove("active"));

    if(state === "not_open") btnNotOpen.classList.add("active");
    else if(state === "open") btnOpen.classList.add("active");
    else if(state === "paused") btnPause.classList.add("active");
    else if(state === "closed") btnClose.classList.add("active");

    // libellÃ© du bouton pause = suspendre / rÃ©activer
    btnPause.textContent = (state === "paused") ? "â–¶ï¸ RÃ©activer" : "â¸ï¸ Suspendre";
  }

  async function setState(next){
    const target = normalizeState(next);

    // confirmations utiles (pas trop intrusives)
    if(target === "closed"){
      const ok = confirm("ClÃ´turer les inscriptions ?\n\nLe public verra â€œclÃ´turÃ©esâ€ et ne pourra plus sâ€™inscrire.");
      if(!ok) return;
    }
    if(target === "not_open"){
      const ok = confirm("Mettre â€œpas encore ouvertesâ€ ?\n\nLe public verra que ce nâ€™est pas ouvert, formulaire bloquÃ©.");
      if(!ok) return;
    }

    setButtonsDisabled(true);
    statusMsgEl.textContent = "Mise Ã  jourâ€¦";

    try{
      await setDoc(cfgRef, {
        inscriptionsState: target,
        updatedAt: serverTimestamp()
      }, { merge:true });

      statusMsgEl.textContent = "âœ… Statut mis Ã  jour.";
    }catch(e){
      console.error(e);
      statusMsgEl.textContent = "âŒ Erreur : impossible de mettre Ã  jour.";
    }finally{
      setButtonsDisabled(false);
    }
  }

  // actions
  btnNotOpen.onclick = ()=> setState("not_open");
  btnOpen.onclick = ()=> setState("open");

  btnPause.onclick = ()=>{
    // toggle suspend/resume depending on current state
    if(currentState === "paused") setState("open");
    else setState("paused");
  };

  btnClose.onclick = ()=> setState("closed");

  // logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // guard + live state
  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminUI.style.display = "none";

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const ok = await ensureAdmin();
    if(!ok){
      accessDenied.style.display = "block";
      return;
    }

    adminUI.style.display = "block";

    // live update
    onSnapshot(cfgRef, (snap)=>{
      const state = normalizeState(snap.exists() ? (snap.data().inscriptionsState || "not_open") : "not_open");
      currentState = state;

      currentStateEl.innerHTML = `Statut actuel : <strong>${labelFor(state)}</strong>`;
      statusMsgEl.textContent = publicMessage(state);
      setActiveButton(state);
    }, (err)=>{
      console.error(err);
      currentStateEl.textContent = "âŒ Impossible de lire le statut.";
      statusMsgEl.textContent = "";
    });
  });
</script>

</body>
</html>
