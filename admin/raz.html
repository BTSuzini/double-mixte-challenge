<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” RAZ</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260222" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <!-- âœ… mÃªme bandeau que le rÃ¨glement (centre = image) -->
      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-rouge.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Encart Zone (mÃªme partout) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ›ï¸ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">GÃ©nÃ©ral</option>
        <option value="etape1">Ã‰tape 1</option>
        <option value="etape2">Ã‰tape 2</option>
        <option value="etape3">Ã‰tape 3</option>
        <option value="etape4">Ã‰tape 4</option>
        <option value="etape5">Ã‰tape 5</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <section class="card" id="panelNeedStep" style="display:none;">
    <h2 style="margin:0 0 8px;">â„¹ï¸ Choisir une Ã©tape</h2>
    <p class="muted" style="margin:0;">
      SÃ©lectionne une <b>Ã‰tape</b> dans â€œZoneâ€ pour utiliser la RAZ.
    </p>
  </section>

  <section class="card" id="panelRaz" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§¨ RÃ©initialisation</h2>
    <p class="muted" id="statusText" style="margin:0;">Chargementâ€¦</p>

    <div class="warn" style="margin-top:12px;">
      âš ï¸ Attention : ces actions suppriment des donnÃ©es Firestore et sont <b>irrÃ©versibles</b>.
      <br>Une confirmation â€œdoubleâ€ est demandÃ©e (popup + saisie dâ€™un mot).
    </div>

    <div class="grid" style="margin-top:14px;">
      <button class="btn" id="btnRazAll" style="font-weight:900; color:#111;">ğŸ”¥ RAZ TOUT LE TOURNOI</button>
      <button class="btn" id="btnRazInscriptions" style="font-weight:900; color:#111;">ğŸ“ RAZ Inscriptions</button>
      <button class="btn" id="btnRazResults" style="font-weight:900; color:#111;">ğŸ RAZ RÃ©sultats</button>
      <button class="btn" id="btnRazProg" style="font-weight:900; color:#111;">ğŸ“… RAZ Programmation</button>
      <button class="btn" id="btnRazDraw" style="font-weight:900; color:#111;">ğŸ² RAZ Tirage</button>
      <button class="btn" id="btnRazClassement" style="font-weight:900; color:#111;">ğŸ† RAZ Classement</button>
      <button class="btn" id="btnRazVerification" style="font-weight:900; color:#111;">ğŸ” RAZ VÃ©rification</button>
    </div>

    <hr class="sep" style="margin-top:16px;" />

    <h3 style="margin:0 0 8px;">ğŸ“¦ Ã‰tat (aperÃ§u)</h3>
    <div id="stateBox" class="muted">â€”</div>

    <p class="muted" style="margin-top:12px;">
      Notes :
      <br>â€¢ â€œRÃ©sultatsâ€ correspond Ã  la collection <b>resultats_${scope}</b>.
      <br>â€¢ â€œProgrammationâ€ correspond au document <b>programmations/{scope}</b>.
      <br>â€¢ â€œTirageâ€ correspond au document <b>tirages/{scope}</b>.
      <br>â€¢ â€œClassementâ€ correspond au document <b>classements/{scope}</b>.
    </p>
  </section>

</main>

<style>
  .warn{
    border:1px solid rgba(176,0,32,.25);
    background:rgba(176,0,32,.06);
    padding:10px 12px;
    border-radius:14px;
    font-weight:900;
  }
  .mini{
    font-size:12px;
    opacity:.82;
    line-height:1.45;
  }
  .kv{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:8px 12px;
    margin-top:10px;
  }
  .k{ font-weight:900; }
  .v{ text-align:right; font-variant-numeric: tabular-nums; }

  /* âœ… Onglet actif dans la Zone */
  #tabs .btn.is-active{
    background:#111;
    color:#fff !important;
    border-color:#111;
    box-shadow: 0 10px 18px rgba(0,0,0,.16);
  }
</style>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc, deleteDoc,
    collection, getDocs,
    query, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- scope (URL ?scope=etape5)
  const params = new URLSearchParams(location.search);
  const scopeFromUrl = params.get("scope") || "etape5";

  // ---- DOM
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");
  const pageSub = document.getElementById("pageSub"); // peut Ãªtre null selon la page

  const panelNeedStep = document.getElementById("panelNeedStep");
  const panelRaz = document.getElementById("panelRaz");

  const statusText = document.getElementById("statusText");
  const stateBox = document.getElementById("stateBox");

  const btnRazAll = document.getElementById("btnRazAll");
  const btnRazInscriptions = document.getElementById("btnRazInscriptions");
  const btnRazResults = document.getElementById("btnRazResults");
  const btnRazProg = document.getElementById("btnRazProg");
  const btnRazDraw = document.getElementById("btnRazDraw");
  const btnRazClassement = document.getElementById("btnRazClassement");
  const btnRazVerification = document.getElementById("btnRazVerification");

  // ---- state
  let currentScope = scopeFromUrl;

  function stepLabel(scope){
    if(!scope || scope === "general") return "GÃ©nÃ©ral";
    return `Ã‰tape ${scope.replace("etape","")}`;
  }

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      hintEl.textContent = "Zone GÃ©nÃ©ral : pas de RAZ ici (choisis une Ã©tape).";
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "index.html";
      a.textContent = "ğŸ“° Aller aux infos (GÃ©nÃ©ral)";
      tabsEl.appendChild(a);
      return;
    }

    hintEl.textContent = "Zone Ã‰tape : Ã©quipes / inscriptions / vÃ©rification / tirage / programmation / rÃ©sultats / classement / RAZ.";

    const links = [
      ["ğŸ‘¥ Ã‰quipes",        "equipes.html"],
      ["ğŸ“ Inscriptions",   "inscriptions.html"],
      ["ğŸ” VÃ©rification",   "verification.html"],
      ["ğŸ² Tirage",         "tirage.html"],
      ["ğŸ“… Programmation",  "programmation.html"],
      ["ğŸ RÃ©sultats",      "resultats.html"],
      ["ğŸ† Classement",     "classement.html"],
      ["ğŸ§¨ RAZ",            "raz.html"],
    ];

    if(scope !== "etape5"){
      links.splice(4, 0, ["ğŸ½ï¸ Repas", "repas.html"]);
    }else{
      const fake = document.createElement("a");
      fake.className = "btn disabled";
      fake.href = "#";
      fake.setAttribute("aria-disabled","true");
      fake.textContent = "ğŸ½ï¸ Repas (plus tard)";
      fake.onclick = (e)=>{ e.preventDefault(); alert("Repas non activÃ© pour lâ€™Ã©tape 5 (zone test)."); };
      tabsEl.appendChild(fake);
    }

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;

      // âœ… Onglet actif (couleur)
      if(url === "raz.html"){
        a.classList.add("is-active");
        a.style.fontWeight = "900";
      }

      tabsEl.appendChild(a);
    }
  }

  // ---- Firestore refs (CONVENTIONS)
  // âš ï¸ Adapte ces noms si tes collections/docs ont un autre nom exact.
  function inscriptionsCol(scope){ return collection(db, `inscriptions_${scope}`); }
  function resultsCol(scope){ return collection(db, `resultats_${scope}`); }
  function verificationCol(scope){ return collection(db, `verifications_${scope}`); } // futur fichier admin/verification
  function progDoc(scope){ return doc(db, "programmations", scope); }
  function drawDoc(scope){ return doc(db, "tirages", scope); }
  function classementDoc(scope){ return doc(db, "classements", scope); }

  async function countSome(colRef){
    const snap = await getDocs(query(colRef, limit(50)));
    return snap.size;
  }

  async function existsDoc(ref){
    const s = await getDoc(ref);
    return s.exists();
  }

  async function refreshState(){
    if(currentScope === "general"){
      stateBox.innerHTML = "â€”";
      return;
    }
    statusText.textContent = "ğŸ” Lecture Ã©tatâ€¦";

    try{
      const [insN, resN, verN, hasProg, hasDraw, hasCls] = await Promise.all([
        countSome(inscriptionsCol(currentScope)).catch(()=> null),
        countSome(resultsCol(currentScope)).catch(()=> null),
        countSome(verificationCol(currentScope)).catch(()=> null),
        existsDoc(progDoc(currentScope)).catch(()=> false),
        existsDoc(drawDoc(currentScope)).catch(()=> false),
        existsDoc(classementDoc(currentScope)).catch(()=> false),
      ]);

      stateBox.innerHTML = `
        <div class="kv">
          <div class="k">ğŸ“ Inscriptions</div><div class="v">${insN === null ? "?" : esc(String(insN))}${insN === 50 ? "+" : ""}</div>
          <div class="k">ğŸ RÃ©sultats</div><div class="v">${resN === null ? "?" : esc(String(resN))}${resN === 50 ? "+" : ""}</div>
          <div class="k">ğŸ” VÃ©rification</div><div class="v">${verN === null ? "?" : esc(String(verN))}${verN === 50 ? "+" : ""}</div>
          <div class="k">ğŸ“… Programmation</div><div class="v">${hasProg ? "âœ…" : "â€”"}</div>
          <div class="k">ğŸ² Tirage</div><div class="v">${hasDraw ? "âœ…" : "â€”"}</div>
          <div class="k">ğŸ† Classement</div><div class="v">${hasCls ? "âœ…" : "â€”"}</div>
        </div>
        <div class="mini muted" style="margin-top:10px;">
          Astuce : les nombres affichÃ©s sont un aperÃ§u (lecture max 50 docs).
        </div>
      `;

      statusText.textContent = "âœ… PrÃªt.";
    }catch(err){
      console.error(err);
      statusText.textContent = "âŒ Erreur lecture Ã©tat.";
      stateBox.innerHTML = `<div class="muted">Erreur.</div>`;
    }
  }

  async function deleteAllDocsInCollection(colRef){
    const snap = await getDocs(colRef);
    const tasks = [];
    snap.forEach(d => tasks.push(deleteDoc(d.ref)));
    await Promise.all(tasks);
    return snap.size;
  }

  async function doubleConfirm(actionLabel){
    const ok = confirm(`${actionLabel}\n\nâš ï¸ Action irrÃ©versible.\n\nContinuer ?`);
    if(!ok) return false;
    const word = prompt(`Pour confirmer, tape : RAZ`);
    if(word === null) return false;
    if((word || "").trim().toUpperCase() !== "RAZ"){
      alert("Confirmation refusÃ©e (mot incorrect).");
      return false;
    }
    return true;
  }

  async function runRaz(which){
    if(currentScope === "general"){
      alert("Choisis une Ã©tape.");
      return;
    }

    const labelMap = {
      all: "ğŸ”¥ RAZ TOUT LE TOURNOI",
      inscriptions: "ğŸ“ RAZ Inscriptions",
      results: "ğŸ RAZ RÃ©sultats",
      programmation: "ğŸ“… RAZ Programmation",
      tirage: "ğŸ² RAZ Tirage",
      classement: "ğŸ† RAZ Classement",
      verification: "ğŸ” RAZ VÃ©rification",
    };

    const ok = await doubleConfirm(labelMap[which] || "RAZ");
    if(!ok) return;

    for(const b of [btnRazAll,btnRazInscriptions,btnRazResults,btnRazProg,btnRazDraw,btnRazClassement,btnRazVerification]){
      b.disabled = true;
    }
    statusText.textContent = "ğŸ§¨ RÃ©initialisation en coursâ€¦";

    try{
      const logs = [];

      const doInscriptions = async ()=>{
        const n = await deleteAllDocsInCollection(inscriptionsCol(currentScope));
        logs.push(`ğŸ“ Inscriptions supprimÃ©es : ${n}`);
      };

      const doResults = async ()=>{
        const n = await deleteAllDocsInCollection(resultsCol(currentScope));
        logs.push(`ğŸ RÃ©sultats supprimÃ©s : ${n}`);
      };

      const doVerification = async ()=>{
        const n = await deleteAllDocsInCollection(verificationCol(currentScope));
        logs.push(`ğŸ” VÃ©rification supprimÃ©e : ${n}`);
      };

      const doProg = async ()=>{
        await deleteDoc(progDoc(currentScope));
        logs.push("ğŸ“… Programmation supprimÃ©e : OK");
      };

      const doDraw = async ()=>{
        await deleteDoc(drawDoc(currentScope));
        logs.push("ğŸ² Tirage supprimÃ© : OK");
      };

      const doClassement = async ()=>{
        await deleteDoc(classementDoc(currentScope));
        logs.push("ğŸ† Classement supprimÃ© : OK");
      };

      if(which === "all"){
        await doResults().catch(()=> logs.push("ğŸ RÃ©sultats : (dÃ©jÃ  vide ou erreur)"));
        await doClassement().catch(()=> logs.push("ğŸ† Classement : (dÃ©jÃ  vide ou erreur)"));
        await doProg().catch(()=> logs.push("ğŸ“… Programmation : (dÃ©jÃ  vide ou erreur)"));
        await doDraw().catch(()=> logs.push("ğŸ² Tirage : (dÃ©jÃ  vide ou erreur)"));
        await doInscriptions().catch(()=> logs.push("ğŸ“ Inscriptions : (dÃ©jÃ  vide ou erreur)"));
        await doVerification().catch(()=> logs.push("ğŸ” VÃ©rification : (dÃ©jÃ  vide ou erreur)"));
      }else{
        if(which === "inscriptions") await doInscriptions();
        if(which === "results") await doResults();
        if(which === "verification") await doVerification();
        if(which === "programmation") await doProg();
        if(which === "tirage") await doDraw();
        if(which === "classement") await doClassement();
      }

      statusText.textContent = "âœ… RAZ terminÃ©e.";
      alert("âœ… TerminÃ©\n\n" + logs.join("\n"));
      await refreshState();
    }catch(err){
      console.error(err);
      statusText.textContent = "âŒ Erreur RAZ.";
      alert("Erreur âŒ\n\n" + (err?.message || "Impossible."));
    }finally{
      for(const b of [btnRazAll,btnRazInscriptions,btnRazResults,btnRazProg,btnRazDraw,btnRazClassement,btnRazVerification]){
        b.disabled = false;
      }
    }
  }

  function showPanelsForScope(scope){
    // âœ… FIX: pageSub peut Ãªtre null => on Ã©vite le crash
    if(pageSub){
      pageSub.textContent = scope === "general" ? "GÃ©nÃ©ral" : `${stepLabel(scope)} â€” BT250`;
    }

    if(scope === "general"){
      panelNeedStep.style.display = "block";
      panelRaz.style.display = "none";
      return;
    }

    panelNeedStep.style.display = "none";
    panelRaz.style.display = "block";
    refreshState();
  }

  function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelNeedStep.style.display = "none";
    panelRaz.style.display = "none";
  }

  function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    scopeEl.value = currentScope;
    setTabs(currentScope);
    showPanelsForScope(currentScope);

    scopeEl.onchange = ()=>{
      currentScope = scopeEl.value || "general";
      setTabs(currentScope);
      showPanelsForScope(currentScope);
    };
  }

  // ---- events
  btnRazAll.onclick = (e)=>{ e.preventDefault(); runRaz("all"); };
  btnRazInscriptions.onclick = (e)=>{ e.preventDefault(); runRaz("inscriptions"); };
  btnRazResults.onclick = (e)=>{ e.preventDefault(); runRaz("results"); };
  btnRazProg.onclick = (e)=>{ e.preventDefault(); runRaz("programmation"); };
  btnRazDraw.onclick = (e)=>{ e.preventDefault(); runRaz("tirage"); };
  btnRazClassement.onclick = (e)=>{ e.preventDefault(); runRaz("classement"); };
  btnRazVerification.onclick = (e)=>{ e.preventDefault(); runRaz("verification"); };

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // Guard
  const g = await requireRole(["admin"]);
  if(!g.ok){ showDenied(); }
  else { showAdmin(); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
