<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260222" />

  <style>
    /* =========================
       Sous-onglets G√©n√©ral (Infos / Paiements)
    ========================== */
    .subtabs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .subtab{
      appearance:none;
      border:1px solid #ddd;
      background:#fafafa;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      text-align:center;
      white-space:nowrap;
    }
    .subtab[aria-selected="true"]{
      background:#fff;
      border-color:#cfcfcf;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }

    /* =========================
       √âtapes : scroll horizontal (pills)
    ========================== */
    .stepbar-wrap{
      margin-top:10px;
    }
    .stepbar{
      display:flex;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:6px 2px 2px;
      scroll-snap-type:x mandatory;
    }
    .stepbar::-webkit-scrollbar{ display:none; }
    .step-pill{
      flex: 0 0 auto;
      scroll-snap-align:start;
      border:1px solid #ddd;
      background:#fafafa;
      color:#111;
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .step-pill[aria-selected="true"]{
      background:#fff;
      border-color:#cfcfcf;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    .step-pill[aria-disabled="true"]{
      opacity:.55;
      cursor:not-allowed;
    }

    /* =========================
       Paiements UI (list)
    ========================== */
    .admin-top{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .admin-top h2{ margin:0; }
    .admin-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      align-items:center;
      justify-content:space-between;
    }
    .search{
      flex: 1 1 260px;
      min-width: 220px;
    }
    .search input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid #ddd;
      background:#fff;
      font-weight:800;
      outline:none;
    }

    .stats{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      font-weight:900;
      white-space:nowrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fafafa;
      font-weight:900;
      white-space:nowrap;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
      background:#bbb;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .dot.red{ background:#e74c3c; }
    .dot.orange{ background:#f39c12; }
    .dot.green{ background:#2ecc71; }

    .pay-list{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .pay-card{
      border:1px solid #eee;
      border-radius:16px;
      background:#fff;
      padding:12px 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .pay-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .pay-team{
      font-weight:950;
      font-size:16px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .players{
      display:grid;
      gap:8px;
    }
    .player-row{
      border:1px solid #f0f0f0;
      background:#fbfbfb;
      border-radius:12px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .player-name{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      flex: 0 0 auto;
      white-space:nowrap;
    }
    .toggle button{
      appearance:none;
      border:1px solid #ddd;
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:950;
      cursor:pointer;
    }
    .toggle button.paid{
      border-color:#bfe9c8;
      background:#ecfff0;
    }
    .toggle button.unpaid{
      border-color:#ffd0cb;
      background:#fff0ef;
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:4px;
    }
    .meta small{ opacity:.75; }

    @media (max-width:420px){
      .pay-team{ font-size:15px; }
      .toggle button{ padding:7px 9px; font-size:13px; }
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">üõ†Ô∏è Admin ‚Äî Gestion</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">üè† Accueil public</a>
      <a href="#" id="btnLogout">üö™ D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <!-- ‚úÖ Encart Zone -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üß≠ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">üåê G√©n√©ral</option>
        <option value="etape1">üéæ √âtape 1</option>
        <option value="etape2">üéæ √âtape 2</option>
        <option value="etape3">üéæ √âtape 3</option>
        <option value="etape4">üéæ √âtape 4</option>
        <option value="etape5">üß™ √âtape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- Zone: G√©n√©ral -->
  <section class="card" id="panelGeneral" style="display:none;">

    <h2 style="margin:0 0 6px;">üåê G√©n√©ral</h2>
    <p class="muted" style="margin:0;">
      Sous-onglets : gestion des infos + suivi des paiements.
    </p>

    <div class="subtabs" role="tablist" aria-label="G√©n√©ral">
      <button class="subtab" id="tabGenInfos" type="button" aria-selected="true">üì∞ Infos</button>
      <button class="subtab" id="tabGenPay" type="button" aria-selected="false">‚úÖ Paiements</button>
    </div>

    <!-- ======================
          ONGLET INFOS
    ======================= -->
    <div id="panelGenInfos" style="margin-top:12px;">
      <h2 style="margin:0 0 10px;">üì∞ Infos (admin)</h2>

      <form id="infoForm" class="form" autocomplete="off">
        <div class="field">
          <label for="infoTitle">Titre *</label>
          <input id="infoTitle" name="infoTitle" required maxlength="80" placeholder="Ex : Inscriptions ouvertes ‚úÖ">
        </div>

        <div class="field">
          <label for="infoText">Texte *</label>
          <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
            placeholder="Texte (emojis ok üòÑ)"></textarea>
        </div>

        <button class="btn" id="publishBtn" type="submit" style="font-weight:800; color:#111;">‚úÖ Publier</button>
        <p class="muted" id="adminStatus" role="status" aria-live="polite" style="margin:8px 0 0;"></p>
      </form>

      <hr class="sep" />

      <p class="muted" id="infosCount" style="margin:0;">Chargement‚Ä¶</p>
      <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
    </div>

    <!-- ======================
          ONGLET PAIEMENTS
    ======================= -->
    <div id="panelGenPay" style="display:none; margin-top:12px;">

      <div class="admin-top">
        <div>
          <h2>‚úÖ Paiements ‚Äî Challenge</h2>
          <p class="muted" style="margin:6px 0 0;">
            Cliquez sur ‚ÄúPay√© / Non pay√©‚Äù pour chaque joueur. (Enregistr√© en direct)
          </p>
        </div>
        <div class="admin-actions">
          <span class="pill" id="authState">Connexion‚Ä¶</span>
        </div>
      </div>

      <!-- √âtapes (scroll) -->
      <div class="stepbar-wrap" aria-label="Choix √©tape">
        <div class="stepbar" id="stepbar">
          <button class="step-pill" id="step_e1" type="button" aria-selected="true">üéæ √âtape 1</button>
          <button class="step-pill" id="step_e2" type="button" aria-selected="false" aria-disabled="true" title="Bient√¥t">üéæ √âtape 2 (bient√¥t)</button>
          <button class="step-pill" id="step_e3" type="button" aria-selected="false" aria-disabled="true" title="Bient√¥t">üéæ √âtape 3 (bient√¥t)</button>
          <button class="step-pill" id="step_e4" type="button" aria-selected="false" aria-disabled="true" title="Bient√¥t">üéæ √âtape 4 (bient√¥t)</button>
          <button class="step-pill" id="step_e5" type="button" aria-selected="false" aria-disabled="true" title="Bient√¥t">üß™ √âtape 5 (bient√¥t)</button>
        </div>
        <p class="muted" style="margin:8px 0 0;">
          √âtape active : <b id="stepLabel">√âtape 1</b>
        </p>
      </div>

      <div class="filters">
        <div class="search">
          <input id="q" type="search" placeholder="Rechercher √©quipe / pr√©nom‚Ä¶" autocomplete="off">
        </div>

        <div class="stats">
          <span class="badge"><span class="dot red"></span><span id="c0">0</span> non pay√©</span>
          <span class="badge"><span class="dot orange"></span><span id="c1">0</span> partiel</span>
          <span class="badge"><span class="dot green"></span><span id="c2">0</span> pay√©</span>
        </div>
      </div>

      <p class="muted" id="statusPay" style="margin:10px 0 0;">Chargement‚Ä¶</p>

      <div class="pay-list" id="listPay" aria-label="Liste paiements"></div>
    </div>

  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, addDoc, deleteDoc, updateDoc,
    serverTimestamp,
    query, orderBy, onSnapshot,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // =========================================
  // CONFIG
  // =========================================
  const COL_INFOS = "infos";

  // Challenge ‚Äî √âtape 1
  const COL_TEAMS_E1_PUBLIC = "equipes_etape1_public";

  // Challenge ‚Äî Paiements (toutes √©tapes)
  // docId = "e1_<teamDocId>"
  // fields = { p1Paid:boolean, p2Paid:boolean, updatedAt }
  const COL_PAYMENTS = "paiements_challenge";

  // =========================================
  // DOM
  // =========================================
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const panelGeneral = document.getElementById("panelGeneral");

  // Sous-onglets g√©n√©ral
  const tabGenInfos = document.getElementById("tabGenInfos");
  const tabGenPay   = document.getElementById("tabGenPay");
  const panelGenInfos = document.getElementById("panelGenInfos");
  const panelGenPay   = document.getElementById("panelGenPay");

  // Infos
  const infoForm = document.getElementById("infoForm");
  const publishBtn = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");
  const infosCount = document.getElementById("infosCount");
  const infosList = document.getElementById("infosList");

  let unsubscribeInfos = null;

  // Paiements
  const authState = document.getElementById("authState");
  const stepLabel = document.getElementById("stepLabel");
  const qInput = document.getElementById("q");
  const statusPay = document.getElementById("statusPay");
  const listPay = document.getElementById("listPay");

  const c0 = document.getElementById("c0");
  const c1 = document.getElementById("c1");
  const c2 = document.getElementById("c2");

  const step_e1 = document.getElementById("step_e1");

  // =========================================
  // LocalStorage keys
  // =========================================
  const LS_SCOPE_KEY = "admin_scope_last";
  const LS_GENERAL_TAB = "admin_general_tab"; // infos | pay
  const LS_PAY_STEP = "admin_pay_step"; // e1

  // =========================================
  // Helpers
  // =========================================
  function esc(str){
    return (str || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", {
        year:"numeric", month:"long", day:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
    }catch{ return "‚Äî"; }
  }

  function fmtUpdated(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{
      return "‚Äî";
    }
  }

  function dotClass(paidCount){
    if(paidCount >= 2) return "green";
    if(paidCount === 1) return "orange";
    return "red";
  }
  function label(paidCount){
    return paidCount >= 2 ? "Pay√©" : paidCount === 1 ? "Partiel" : "Non pay√©";
  }

  function stopInfos(){
    if(unsubscribeInfos){
      unsubscribeInfos();
      unsubscribeInfos = null;
    }
  }

  function startInfos(){
    if(unsubscribeInfos) return;

    infosCount.textContent = "Chargement‚Ä¶";
    infosList.innerHTML = "";

    const q = query(collection(db, COL_INFOS), orderBy("createdAt","desc"));
    unsubscribeInfos = onSnapshot(q, async (snap)=>{
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      infosCount.textContent = `üìå ${items.length} info${items.length>1?"s":""}`;
      infosList.innerHTML = "";

      if(items.length === 0){
        infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info publi√©e.</p>`;
        return;
      }

      for(const it of items){
        const title = esc(it.title);
        const text = esc(it.text).replaceAll("\n","<br>");
        const date = fmtDate(it.createdAt);

        const card = document.createElement("div");
        card.className = "card";
        card.style.margin = "0";
        card.innerHTML = `
          <div style="display:flex; gap:12px; justify-content:space-between; align-items:flex-start;">
            <div style="min-width:0;">
              <div style="font-weight:900;">${title}</div>
              <div class="muted" style="margin-top:6px;">üóìÔ∏è ${date}</div>
              <div style="margin-top:8px; line-height:1.45;">${text}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; flex:0 0 auto;">
              <button class="btn" data-edit="${it.id}" style="font-weight:800; color:#111;">‚úèÔ∏è Modifier</button>
              <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">üóëÔ∏è Supprimer</button>
            </div>
          </div>
        `;
        infosList.appendChild(card);
      }

      infosList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.del;
          const ok = confirm("Supprimer cette info ?\n\n‚ö†Ô∏è Action irr√©versible.");
          if(!ok) return;
          await deleteDoc(doc(db, COL_INFOS, id));
        };
      });

      infosList.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.edit;
          const ref = doc(db, COL_INFOS, id);
          const s = await getDoc(ref);
          if(!s.exists()) return;
          const cur = s.data();

          const newTitle = prompt("Modifier le titre :", cur.title || "");
          if(newTitle === null) return;
          const newText = prompt("Modifier le texte :", cur.text || "");
          if(newText === null) return;

          await updateDoc(ref, { title: newTitle.trim(), text: newText.trim() });
        };
      });
    }, (err)=>{
      console.error(err);
      infosCount.textContent = "‚ùå Impossible de charger les infos.";
    });
  }

  // =========================================
  // G√©n√©ral ‚Äî Sous-onglets
  // =========================================
  function showGeneralTab(which){
    const isInfos = which === "infos";
    tabGenInfos.setAttribute("aria-selected", isInfos ? "true" : "false");
    tabGenPay.setAttribute("aria-selected", isInfos ? "false" : "true");

    panelGenInfos.style.display = isInfos ? "block" : "none";
    panelGenPay.style.display   = isInfos ? "none" : "block";

    try{ localStorage.setItem(LS_GENERAL_TAB, which); }catch(e){}

    if(isInfos){
      startInfos();
    }else{
      stopInfos();
      // Paiements: on render d√®s qu'on a les snapshots
      renderPay();
    }
  }

  tabGenInfos.addEventListener("click", ()=> showGeneralTab("infos"));
  tabGenPay.addEventListener("click", ()=> showGeneralTab("pay"));

  // =========================================
  // Zone Tabs (scope)
  // =========================================
  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";
    panelGeneral.style.display = "none";
    stopInfos();

    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}

    if(scope === "general"){
      hintEl.textContent = "üåê Zone G√©n√©ral : infos + paiements.";
      panelGeneral.style.display = "block";

      // petit ‚Äúonglet‚Äù zone (UI)
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "#";
      a.textContent = "üåê G√©n√©ral";
      a.onclick = (e)=>{ e.preventDefault(); };
      tabsEl.appendChild(a);

      // restore sous-onglet
      let t = "infos";
      try{
        const saved = localStorage.getItem(LS_GENERAL_TAB);
        if(saved === "pay" || saved === "infos") t = saved;
      }catch(e){}
      showGeneralTab(t);
      return;
    }

    // Zone √âtape
    hintEl.textContent = "üéæ Zone √âtape : √©quipes / inscriptions / tirage / programmation / r√©sultats / v√©rification / classement / RAZ.";

    const links = [
      ["üë• √âquipes",        "equipes.html"],
      ["üìù Inscriptions",   "inscriptions.html"],
      ["üîé V√©rification",   "verification.html"],
      ["üé≤ Tirage",         "tirage.html"],
      ["üìÖ Programmation",  "programmation.html"],
      ["üèÅ R√©sultats",      "resultats.html"],
      ["üèÜ Classement",     "classement.html"],
      ["üß® RAZ",            "raz.html"],
    ];

    if(scope !== "etape5"){
      links.splice(3, 0, ["üçΩÔ∏è Repas", "repas.html"]);
    }else{
      tabsEl.appendChild(
        makeDisabledBtn("üçΩÔ∏è Repas (plus tard)", "Repas non activ√© pour l‚Äô√©tape 5 (zone test).")
      );
    }

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;
      tabsEl.appendChild(a);
    }
  }

  // =========================================
  // Publish infos
  // =========================================
  infoForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publication‚Ä¶";
    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text  = (infoForm.infoText.value || "").trim();
      if(!title || !text) throw new Error("Titre et texte obligatoires.");

      await addDoc(collection(db, COL_INFOS), { title, text, createdAt: serverTimestamp() });
      infoForm.reset();
      adminStatus.textContent = "‚úÖ Publi√© !";
    }catch(err){
      console.error(err);
      adminStatus.textContent = "‚ùå Erreur : " + (err?.message || "Impossible de publier.");
    }finally{
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });

  // =========================================
  // Logout
  // =========================================
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  // =========================================
  // Guard
  // =========================================
  async function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelGeneral.style.display = "none";
    stopInfos();
  }

  async function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved && [...scopeEl.options].some(o => o.value === saved)){
        scopeEl.value = saved;
      }
    }catch(e){}

    setTabs(scopeEl.value);
    scopeEl.onchange = ()=> setTabs(scopeEl.value);
  }

  // =========================================
  // Paiements (Challenge) ‚Äî DATA
  // =========================================
  let payStep = "e1"; // uniquement e1 pour l‚Äôinstant
  let queryText = "";

  let snapTeams = null;
  let snapPay = null;

  // snapshots handles
  let unsubTeams = null;
  let unsubPay = null;

  function setPayStep(next){
    if(next !== "e1") return; // pour l‚Äôinstant
    payStep = next;

    // UI
    step_e1.setAttribute("aria-selected", payStep === "e1" ? "true" : "false");
    stepLabel.textContent = "√âtape 1";

    try{ localStorage.setItem(LS_PAY_STEP, payStep); }catch(e){}

    // (re)subscribe
    subscribePay();
  }

  step_e1.addEventListener("click", ()=> setPayStep("e1"));

  qInput.addEventListener("input", ()=>{
    queryText = (qInput.value || "").trim().toLowerCase();
    renderPay();
  });

  function buildRows(){
    if(!snapTeams || !snapPay) return null;

    const payMap = new Map();
    snapPay.forEach(d=>{
      const x = d.data() || {};
      payMap.set(d.id, {
        p1Paid: x.p1Paid === true,
        p2Paid: x.p2Paid === true,
        updatedAt: x.updatedAt || null
      });
    });

    const rows = [];
    snapTeams.forEach(d=>{
      const x = d.data() || {};
      const teamName = (x.teamName || "").trim();
      if(!teamName) return;

      const p1 = (x.p1FirstName || "").trim();
      const p2 = (x.p2FirstName || "").trim();

      const payId = `${payStep}_${d.id}`; // ex: e1_<teamDocId>
      const pay = payMap.get(payId) || { p1Paid:false, p2Paid:false, updatedAt:null };
      const paidCount = (pay.p1Paid?1:0) + (pay.p2Paid?1:0);

      rows.push({
        teamDocId: d.id,
        payId,
        teamName,
        p1, p2,
        p1Paid: pay.p1Paid,
        p2Paid: pay.p2Paid,
        paidCount,
        updatedAt: pay.updatedAt
      });
    });

    return rows;
  }

  function matches(r){
    if(!queryText) return true;
    const hay = `${r.teamName} ${r.p1} ${r.p2}`.toLowerCase();
    return hay.includes(queryText);
  }

  async function setPaid(payId, who, paid){
    const ref = doc(db, COL_PAYMENTS, payId);
    const payload = { updatedAt: serverTimestamp() };
    payload[who === "p1" ? "p1Paid" : "p2Paid"] = paid;
    await setDoc(ref, payload, { merge: true });
  }

  function renderPay(){
    // si pas visible, inutile de bosser
    if(panelGenPay.style.display === "none") return;

    const rows = buildRows();
    if(!rows){
      statusPay.textContent = "Chargement‚Ä¶";
      return;
    }

    const filtered = rows.filter(matches);

    // stats
    let n0=0, n1=0, n2=0;
    for(const r of filtered){
      if(r.paidCount === 0) n0++;
      else if(r.paidCount === 1) n1++;
      else n2++;
    }
    c0.textContent = String(n0);
    c1.textContent = String(n1);
    c2.textContent = String(n2);

    // tri
    filtered.sort((a,b)=>{
      if(a.paidCount !== b.paidCount) return a.paidCount - b.paidCount;
      return (a.teamName||"").localeCompare((b.teamName||""), "fr");
    });

    statusPay.textContent = `üü¢ En direct ‚Äî ${filtered.length} √©quipe(s)`;

    if(filtered.length === 0){
      listPay.innerHTML = `<p class="muted" style="margin:0;">Aucun r√©sultat.</p>`;
      return;
    }

    listPay.innerHTML = filtered.map(r=>{
      const dot = dotClass(r.paidCount);
      const lab = label(r.paidCount);
      const p1Name = r.p1 || "‚Äî";
      const p2Name = r.p2 || "‚Äî";
      const meta = `Derni√®re mise √† jour : ${esc(fmtUpdated(r.updatedAt))}`;

      return `
        <div class="pay-card" data-payid="${esc(r.payId)}">
          <div class="pay-head">
            <div class="pay-team">${esc(r.teamName)}</div>
            <div class="badge" title="${esc(lab)}">
              <span class="dot ${dot}"></span>
              ${esc(lab)}
            </div>
          </div>

          <div class="players">
            <div class="player-row">
              <div class="player-name">${esc(p1Name)}</div>
              <div class="toggle">
                <button class="${r.p1Paid ? "paid" : "unpaid"}" data-who="p1" data-next="${r.p1Paid ? "0" : "1"}">
                  ${r.p1Paid ? "‚úÖ Pay√©" : "‚ùå Non pay√©"}
                </button>
              </div>
            </div>

            <div class="player-row">
              <div class="player-name">${esc(p2Name)}</div>
              <div class="toggle">
                <button class="${r.p2Paid ? "paid" : "unpaid"}" data-who="p2" data-next="${r.p2Paid ? "0" : "1"}">
                  ${r.p2Paid ? "‚úÖ Pay√©" : "‚ùå Non pay√©"}
                </button>
              </div>
            </div>
          </div>

          <div class="meta">
            <small class="muted">√âtape ${esc(payStep.toUpperCase())} ‚Ä¢ id: ${esc(r.teamDocId)}</small>
            <small class="muted">${meta}</small>
          </div>
        </div>
      `;
    }).join("");

    // bind toggles
    listPay.querySelectorAll("button[data-who]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const card = btn.closest(".pay-card");
        const payId = card?.dataset?.payid;
        const who = btn.dataset.who;
        const next = btn.dataset.next === "1";

        btn.disabled = true;
        try{
          await setPaid(payId, who, next);
        }catch(e){
          console.error(e);
          alert("‚ùå Erreur : impossible d‚Äôenregistrer.");
        }finally{
          btn.disabled = false;
        }
      });
    });
  }

  function unsubscribePay(){
    if(unsubTeams){ unsubTeams(); unsubTeams=null; }
    if(unsubPay){ unsubPay(); unsubPay=null; }
    snapTeams = null;
    snapPay = null;
  }

  function subscribePay(){
    unsubscribePay();

    // Teams snapshot (selon √©tape)
    const teamsCol = (payStep === "e1") ? COL_TEAMS_E1_PUBLIC : COL_TEAMS_E1_PUBLIC;

    const qTeams = query(collection(db, teamsCol), orderBy("createdAt","asc"));
    const qPay   = query(collection(db, COL_PAYMENTS), orderBy("updatedAt","desc"));

    unsubTeams = onSnapshot(qTeams, (s)=>{ snapTeams = s; renderPay(); }, (e)=>{ console.error(e); statusPay.textContent="üî¥ Erreur √©quipes"; });
    unsubPay   = onSnapshot(qPay,   (s)=>{ snapPay = s; renderPay(); }, (e)=>{ console.error(e); statusPay.textContent="üî¥ Erreur paiements"; });
  }

  // =========================================
  // INIT
  // =========================================
  const g = await requireRole(["admin"]);
  if(!g.ok){ await showDenied(); }
  else { await showAdmin(); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ await showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ await showDenied(); return; }
  });

  // Affichage ‚Äúconnect√©‚Äù
  onAuthStateChanged(auth, (user)=>{
    authState.textContent = user ? ("üü¢ Admin : " + user.email) : "Non connect√©";
  });

  // Restore √©tape (paiements)
  try{
    const savedStep = localStorage.getItem(LS_PAY_STEP);
    if(savedStep === "e1") payStep = "e1";
  }catch(e){}
  setPayStep(payStep);

  // Subscriptions paiements : seulement si onglet Paiements visible.
  // (Sinon on les lancera au moment d‚Äôouvrir l‚Äôonglet)
  // Ici, on laisse setPayStep() pr√©parer, et showGeneralTab("pay") fera render.
  subscribePay();
</script>

</body>
</html>
