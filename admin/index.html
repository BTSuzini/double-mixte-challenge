<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">Mode Admin<br><span style="opacity:.95;font-weight:800;">Ã‰tape 1</span></h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">Accueil public</a>
      <a href="equipes.html">Ã‰quipes (admin)</a>
      <a href="#" id="btnLogout">DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card">
    <h2>ğŸ”§ Inscriptions â€” contrÃ´le</h2>

    <p class="muted">Ã‰tat actuel : <strong><span id="stateLabel">â€¦</span></strong></p>

    <div class="grid">
      <button class="btn" id="btnNotOpen" style="font-weight:800;">â³ Pas encore ouvertes</button>
      <button class="btn" id="btnOpen" style="font-weight:800;">âœ… Ouvrir</button>
      <button class="btn" id="btnPause" style="font-weight:800;">â¸ï¸ Suspendre</button>
      <button class="btn" id="btnClose" style="font-weight:800;">ğŸ”’ ClÃ´turer</button>
    </div>

    <p class="muted" style="margin-top:10px;">
      â„¹ï¸ â€œPas encore ouvertesâ€ et â€œSuspendreâ€ bloquent le formulaire public (champs dÃ©sactivÃ©s).
      â€œClÃ´turerâ€ affiche inscriptions clÃ´turÃ©es (sans mention de rÃ©ouverture possible).
    </p>

    <p id="status" class="muted" style="margin-top:10px;"></p>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, getRoleByEmail } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const stateLabel = document.getElementById("stateLabel");
  const statusEl = document.getElementById("status");

  function label(state){
    if(state === "open") return "OUVERTES âœ…";
    if(state === "paused") return "SUSPENDUES â¸ï¸";
    if(state === "closed") return "CLÃ”TURÃ‰ES ğŸ”’";
    return "PAS ENCORE OUVERTES â³";
  }

  async function ensureAdmin(){
    const u = auth.currentUser;
    if(!u) return false;
    const role = await getRoleByEmail(u.email);
    return role === "admin";
  }

  async function loadState(){
    const snap = await getDoc(doc(db,"config","etape1"));
    const state = snap.exists() ? (snap.data().inscriptionsState || "not_open") : "not_open";
    stateLabel.textContent = label(state);
    return state;
  }

  async function setState(state){
    statusEl.textContent = "Enregistrementâ€¦";
    await setDoc(doc(db,"config","etape1"), {
      inscriptionsState: state,
      updatedAt: serverTimestamp()
    }, { merge:true });
    await loadState();
    statusEl.textContent = "âœ… OK";
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      window.location.href = "../index.html";
      return;
    }
    const ok = await ensureAdmin();
    if(!ok){
      alert("AccÃ¨s refusÃ© (admin uniquement).");
      window.location.href = "../index.html";
      return;
    }
    await loadState();
    statusEl.textContent = "";
  });

  document.getElementById("btnNotOpen").onclick = ()=> setState("not_open");
  document.getElementById("btnOpen").onclick    = ()=> setState("open");
  document.getElementById("btnPause").onclick   = ()=> setState("paused");
  document.getElementById("btnClose").onclick   = ()=> setState("closed");

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };
</script>

</body>
</html>
