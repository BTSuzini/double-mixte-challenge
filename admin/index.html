<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260218" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">üõ†Ô∏è Admin ‚Äî Gestion</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav" id="navAdmin">
      <a href="../index.html">Accueil public</a>
      <a href="#" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">‚õî Acc√®s refus√©</h2>
    <p class="muted" style="margin:0;">Cette page est r√©serv√©e aux administrateurs.</p>
  </section>

  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">üéõÔ∏è Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general" selected>G√©n√©ral</option>
        <option value="etape1">√âtape 1</option>
        <option value="etape2">√âtape 2</option>
        <option value="etape3">√âtape 3</option>
        <option value="etape4">√âtape 4</option>
        <option value="etape5">√âtape 5</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- Zone: G√©n√©ral -->
  <section class="card" id="panelGeneral" style="display:none;">
    <h2 style="margin:0 0 10px;">üì∞ Infos (admin)</h2>

    <!-- Form add -->
    <form id="infoForm" class="form" autocomplete="off">
      <div class="field">
        <label for="infoTitle">Titre *</label>
        <input id="infoTitle" name="infoTitle" required maxlength="80" placeholder="Ex : Inscriptions ouvertes ‚úÖ">
      </div>

      <div class="field">
        <label for="infoText">Texte *</label>
        <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
          placeholder="Texte (emojis ok üòÑ)"></textarea>
      </div>

      <button class="btn" id="publishBtn" type="submit" style="font-weight:800; color:#111;">‚úÖ Publier</button>
      <p class="muted" id="adminStatus" role="status" aria-live="polite" style="margin:8px 0 0;"></p>
    </form>

    <hr class="sep" />

    <p class="muted" id="infosCount" style="margin:0;">Chargement‚Ä¶</p>
    <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

  <!-- Zone: √âtape -->
  <section class="card" id="panelEtape" style="display:none;">
    <h2 style="margin:0 0 10px;">üéæ Gestion de l‚Äô√©tape</h2>
    <p class="muted" style="margin:0;">
      Utilise les onglets ci-dessus (√âquipes / Inscriptions / R√©sultats).
    </p>
  </section>

</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc,
    collection, addDoc, deleteDoc, updateDoc,
    serverTimestamp,
    query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDAW66BD1V2Kr2w6ksM1_8bHGugeG6_cUI",
    authDomain: "suzini-double-mixte-challenge.firebaseapp.com",
    projectId: "suzini-double-mixte-challenge",
    storageBucket: "suzini-double-mixte-challenge.firebasestorage.app",
    messagingSenderId: "148641893645",
    appId: "1:148641893645:web:d73cb1727a7b96af3ff444"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const COL_INFOS = "infos";

  // DOM
  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl = document.getElementById("tabs");
  const hintEl = document.getElementById("hint");

  const panelGeneral = document.getElementById("panelGeneral");
  const panelEtape = document.getElementById("panelEtape");

  // Infos admin
  const infoForm = document.getElementById("infoForm");
  const publishBtn = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");
  const infosCount = document.getElementById("infosCount");
  const infosList = document.getElementById("infosList");

  let unsubscribeInfos = null;

  function escapeHTML(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "‚Äî";
      return d.toLocaleString("fr-FR", { year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit" });
    } catch { return "‚Äî"; }
  }

  async function getRoleByEmail(email){
    const s = await getDoc(doc(db, "roles", email));
    if(!s.exists()) return null;
    return s.data().role || null;
  }

  function showPanel(which){
    panelGeneral.style.display = which === "general" ? "block" : "none";
    panelEtape.style.display = which === "etape" ? "block" : "none";
  }

  function setTabsForScope(scope){
    tabsEl.innerHTML = "";

    if(scope === "general"){
      showPanel("general");
      hintEl.textContent = "Zone G√©n√©ral : gestion des infos (publication / modification / suppression).";

      // 1 seul onglet ‚ÄúInfos‚Äù
      const a = document.createElement("a");
      a.className = "btn";
      a.href = "#";
      a.textContent = "üì∞ Infos";
      a.onclick = (e)=>{ e.preventDefault(); showPanel("general"); };
      tabsEl.appendChild(a);

      startInfosStream();
      return;
    }

    // √âtapes
    showPanel("etape");
    hintEl.textContent = "Zone √âtape : √©quipes / inscriptions / r√©sultats.";

    // Arr√™ts stream infos
    stopInfosStream();

    const links = [
      ["üë• √âquipes", "equipes.html"],
      ["üìù Inscriptions", "inscriptions.html"],
      ["üèÅ R√©sultats", "resultats.html"]
    ];

    links.forEach(([label, url])=>{
      const a = document.createElement("a");
      a.className = "btn";
      a.href = url + "?scope=" + encodeURIComponent(scope);
      a.textContent = label;
      tabsEl.appendChild(a);
    });
  }

  function stopInfosStream(){
    if(unsubscribeInfos){
      unsubscribeInfos();
      unsubscribeInfos = null;
    }
  }

  function startInfosStream(){
    if(unsubscribeInfos) return;

    infosCount.textContent = "Chargement‚Ä¶";
    infosList.innerHTML = "";

    const q = query(collection(db, COL_INFOS), orderBy("createdAt", "desc"));
    unsubscribeInfos = onSnapshot(q, (snap)=>{
      const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      infosCount.textContent = `üìå ${items.length} info${items.length > 1 ? "s" : ""}`;
      infosList.innerHTML = "";

      if(items.length === 0){
        infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info publi√©e.</p>`;
        return;
      }

      for(const it of items){
        const title = escapeHTML(it.title);
        const text = escapeHTML(it.text).replaceAll("\n","<br>");
        const date = fmtDate(it.createdAt);

        const card = document.createElement("div");
        card.className = "card";
        card.style.margin = "0";

        card.innerHTML = `
          <div style="display:flex; gap:12px; justify-content:space-between; align-items:flex-start;">
            <div style="min-width:0;">
              <div style="font-weight:900;">${title}</div>
              <div class="muted" style="margin-top:6px;">üóìÔ∏è ${date}</div>
              <div style="margin-top:8px; line-height:1.45;">${text}</div>
            </div>

            <div style="display:flex; flex-direction:column; gap:8px; flex:0 0 auto;">
              <button class="btn" data-edit="${it.id}" style="font-weight:800; color:#111;">‚úèÔ∏è Modifier</button>
              <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">üóëÔ∏è Supprimer</button>
            </div>
          </div>
        `;

        infosList.appendChild(card);
      }

      // Delete
      infosList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-del");
          const ok = confirm("Supprimer cette info ?\n\n‚ö†Ô∏è Action irr√©versible.");
          if(!ok) return;
          try{
            await deleteDoc(doc(db, COL_INFOS, id));
            alert("Info supprim√©e ‚úÖ");
          }catch(e){
            console.error(e);
            alert("Erreur suppression ‚ùå");
          }
        };
      });

      // Edit (simple via prompt)
      infosList.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-edit");
          const ref = doc(db, COL_INFOS, id);
          try{
            const snap = await getDoc(ref);
            if(!snap.exists()) return;

            const cur = snap.data();
            const newTitle = prompt("Modifier le titre :", cur.title || "");
            if(newTitle === null) return;

            const newText = prompt("Modifier le texte :", cur.text || "");
            if(newText === null) return;

            await updateDoc(ref, { title: newTitle.trim(), text: newText.trim() });
            alert("Info modifi√©e ‚úÖ");
          }catch(e){
            console.error(e);
            alert("Erreur modification ‚ùå");
          }
        };
      });
    }, (err)=>{
      console.error(err);
      infosCount.textContent = "‚ùå Impossible de charger les infos.";
    });
  }

  // Publish
  infoForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publication‚Ä¶";

    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text = (infoForm.infoText.value || "").trim();
      if(!title || !text) throw new Error("Titre et texte obligatoires.");

      await addDoc(collection(db, COL_INFOS), {
        title, text,
        createdAt: serverTimestamp()
      });

      infoForm.reset();
      adminStatus.textContent = "‚úÖ Publi√© !";
    }catch(err){
      console.error(err);
      adminStatus.textContent = "‚ùå Erreur : " + (err?.message || "Impossible de publier.");
    }finally{
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });

  // Logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await signOut(auth);
    window.location.href = "../index.html";
  };

  // Auth guard
  onAuthStateChanged(auth, async (user)=>{
    accessDenied.style.display = "none";
    adminUI.style.display = "none";
    stopInfosStream();

    if(!user){
      accessDenied.style.display = "block";
      return;
    }

    const r = await getRoleByEmail(user.email);
    if(r !== "admin"){
      accessDenied.style.display = "block";
      return;
    }

    adminUI.style.display = "block";

    // init
    setTabsForScope(scopeEl.value);

    scopeEl.onchange = ()=>{
      setTabsForScope(scopeEl.value);
    };
  });
</script>

</body>
</html>
