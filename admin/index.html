<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260222" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <h1 class="brand-title">ğŸ› ï¸ Admin â€” Gestion</h1>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- âœ… Bandeau identique partout -->
    <nav class="nav">
      <a href="../index.html">ğŸ  Accueil public</a>
      <a href="#" id="btnLogout">ğŸšª DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs.</p>
  </section>

  <!-- âœ… Encart Zone (Ã  recopier dans toutes les pages admin) -->
  <section class="card" id="adminUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ§­ Zone</h2>

    <div class="field">
      <label for="scope">Choisir</label>
      <select id="scope">
        <option value="general">ğŸŒ GÃ©nÃ©ral</option>
        <option value="etape1">ğŸ¾ Ã‰tape 1</option>
        <option value="etape2">ğŸ¾ Ã‰tape 2</option>
        <option value="etape3">ğŸ¾ Ã‰tape 3</option>
        <option value="etape4">ğŸ¾ Ã‰tape 4</option>
        <option value="etape5">ğŸ§ª Ã‰tape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>
    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <!-- Zone: GÃ©nÃ©ral -->
  <section class="card" id="panelGeneral" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ“° Infos (admin)</h2>

    <form id="infoForm" class="form" autocomplete="off">
      <div class="field">
        <label for="infoTitle">Titre *</label>
        <input id="infoTitle" name="infoTitle" required maxlength="80" placeholder="Ex : Inscriptions ouvertes âœ…">
      </div>

      <div class="field">
        <label for="infoText">Texte *</label>
        <textarea id="infoText" name="infoText" rows="5" required maxlength="2000"
          placeholder="Texte (emojis ok ğŸ˜„)"></textarea>
      </div>

      <button class="btn" id="publishBtn" type="submit" style="font-weight:800; color:#111;">âœ… Publier</button>
      <p class="muted" id="adminStatus" role="status" aria-live="polite" style="margin:8px 0 0;"></p>
    </form>

    <hr class="sep" />

    <p class="muted" id="infosCount" style="margin:0;">Chargementâ€¦</p>
    <div id="infosList" style="display:grid; gap:10px; margin-top:10px;"></div>
  </section>

</main>

<script type="module">
  import { auth, db } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, addDoc, deleteDoc, updateDoc,
    serverTimestamp,
    query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const COL_INFOS = "infos";

  const accessDenied = document.getElementById("accessDenied");
  const adminUI = document.getElementById("adminUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl  = document.getElementById("tabs");
  const hintEl  = document.getElementById("hint");

  const panelGeneral = document.getElementById("panelGeneral");

  const infoForm = document.getElementById("infoForm");
  const publishBtn = document.getElementById("publishBtn");
  const adminStatus = document.getElementById("adminStatus");
  const infosCount = document.getElementById("infosCount");
  const infosList = document.getElementById("infosList");

  let unsubscribeInfos = null;

  const LS_SCOPE_KEY = "admin_scope_last";

  function esc(str){
    return (str || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "â€”";
      return d.toLocaleString("fr-FR", {
        year:"numeric", month:"long", day:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
    }catch{ return "â€”"; }
  }

  function stopInfos(){
    if(unsubscribeInfos){
      unsubscribeInfos();
      unsubscribeInfos = null;
    }
  }

  function startInfos(){
    if(unsubscribeInfos) return;

    infosCount.textContent = "Chargementâ€¦";
    infosList.innerHTML = "";

    const q = query(collection(db, COL_INFOS), orderBy("createdAt","desc"));
    unsubscribeInfos = onSnapshot(q, async (snap)=>{
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      infosCount.textContent = `ğŸ“Œ ${items.length} info${items.length>1?"s":""}`;
      infosList.innerHTML = "";

      if(items.length === 0){
        infosList.innerHTML = `<p class="muted" style="margin:0;">Aucune info publiÃ©e.</p>`;
        return;
      }

      for(const it of items){
        const title = esc(it.title);
        const text = esc(it.text).replaceAll("\n","<br>");
        const date = fmtDate(it.createdAt);

        const card = document.createElement("div");
        card.className = "card";
        card.style.margin = "0";
        card.innerHTML = `
          <div style="display:flex; gap:12px; justify-content:space-between; align-items:flex-start;">
            <div style="min-width:0;">
              <div style="font-weight:900;">${title}</div>
              <div class="muted" style="margin-top:6px;">ğŸ—“ï¸ ${date}</div>
              <div style="margin-top:8px; line-height:1.45;">${text}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; flex:0 0 auto;">
              <button class="btn" data-edit="${it.id}" style="font-weight:800; color:#111;">âœï¸ Modifier</button>
              <button class="btn" data-del="${it.id}" style="font-weight:800; color:#111;">ğŸ—‘ï¸ Supprimer</button>
            </div>
          </div>
        `;
        infosList.appendChild(card);
      }

      // delete
      infosList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.del;
          const ok = confirm("Supprimer cette info ?\n\nâš ï¸ Action irrÃ©versible.");
          if(!ok) return;
          await deleteDoc(doc(db, COL_INFOS, id));
        };
      });

      // edit via prompt (simple)
      infosList.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.edit;
          const ref = doc(db, COL_INFOS, id);
          const s = await getDoc(ref);
          if(!s.exists()) return;
          const cur = s.data();

          const newTitle = prompt("Modifier le titre :", cur.title || "");
          if(newTitle === null) return;
          const newText = prompt("Modifier le texte :", cur.text || "");
          if(newText === null) return;

          await updateDoc(ref, { title: newTitle.trim(), text: newText.trim() });
        };
      });
    }, (err)=>{
      console.error(err);
      infosCount.textContent = "âŒ Impossible de charger les infos.";
    });
  }

  function makeDisabledBtn(label, reason){
    const a = document.createElement("a");
    a.className = "btn disabled";
    a.href = "#";
    a.setAttribute("aria-disabled","true");
    a.textContent = label;
    a.onclick = (e)=>{ e.preventDefault(); alert(reason); };
    return a;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";
    panelGeneral.style.display = "none";
    stopInfos();

    // mÃ©morise la zone
    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch(e){}

    if(scope === "general"){
      hintEl.textContent = "ğŸŒ Zone GÃ©nÃ©ral : gestion des infos (publication / modification / suppression).";
      panelGeneral.style.display = "block";

      const a = document.createElement("a");
      a.className = "btn";
      a.href = "#";
      a.textContent = "ğŸ“° Infos";
      a.onclick = (e)=>{ e.preventDefault(); };
      tabsEl.appendChild(a);

      startInfos();
      return;
    }

    // Zone Ã‰tape
    hintEl.textContent = "ğŸ¾ Zone Ã‰tape : Ã©quipes / inscriptions / tirage / programmation / rÃ©sultats.";

    const links = [
      ["ğŸ‘¥ Ã‰quipes",        "equipes.html"],
      ["ğŸ“ Inscriptions",   "inscriptions.html"],
      ["ğŸ² Tirage",         "tirage.html"],
      ["ğŸ“… Programmation",  "programmation.html"],
      ["ğŸ RÃ©sultats",      "resultats.html"],
    ];

    // Repas : pas pour lâ€™Ã©tape 5 (test)
    if(scope !== "etape5"){
      links.splice(2, 0, ["ğŸ½ï¸ Repas", "repas.html"]);
    }else{
      // on affiche quand mÃªme un bouton â€œRepas (plus tard)â€ pour Ã©viter la confusion
      tabsEl.appendChild(
        makeDisabledBtn("ğŸ½ï¸ Repas (plus tard)", "Repas non activÃ© pour lâ€™Ã©tape 5 (zone test).")
      );
    }

    for(const [label, url] of links){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `${url}?scope=${encodeURIComponent(scope)}`;
      a.textContent = label;
      tabsEl.appendChild(a);
    }
  }

  // Publish infos
  infoForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    publishBtn.disabled = true;
    publishBtn.classList.add("disabled");
    adminStatus.textContent = "Publicationâ€¦";
    try{
      const title = (infoForm.infoTitle.value || "").trim();
      const text  = (infoForm.infoText.value || "").trim();
      if(!title || !text) throw new Error("Titre et texte obligatoires.");

      await addDoc(collection(db, COL_INFOS), { title, text, createdAt: serverTimestamp() });
      infoForm.reset();
      adminStatus.textContent = "âœ… PubliÃ© !";
    }catch(err){
      console.error(err);
      adminStatus.textContent = "âŒ Erreur : " + (err?.message || "Impossible de publier.");
    }finally{
      publishBtn.disabled = false;
      publishBtn.classList.remove("disabled");
    }
  });

  // Logout
  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  async function showDenied(){
    accessDenied.style.display = "block";
    adminUI.style.display = "none";
    panelGeneral.style.display = "none";
    stopInfos();
  }

  async function showAdmin(){
    accessDenied.style.display = "none";
    adminUI.style.display = "block";

    // restore scope
    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved && [...scopeEl.options].some(o => o.value === saved)){
        scopeEl.value = saved;
      }
    }catch(e){}

    setTabs(scopeEl.value);
    scopeEl.onchange = ()=> setTabs(scopeEl.value);
  }

  // Guard (admin only)
  const g = await requireRole(["admin"]);
  if(!g.ok){ await showDenied(); }
  else { await showAdmin(); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ await showDenied(); return; }
    const g2 = await requireRole(["admin"]);
    if(!g2.ok){ await showDenied(); return; }
  });
</script>

</body>
</html>
