<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√âquipes ‚Äî √âtape 1</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260223" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row topbar-row-step">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <!-- ‚úÖ Image au centre -->
      <div class="step-title-wrap" aria-label="√âtape 1">
        <img class="step-title-img" src="../assets/img/etape1.png" alt="√âtape 1">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- ‚úÖ Nav √âtape 1 -->
    <nav class="nav nav-step">
      <!-- 1) Accueil : emoji seul -->
      <a href="../index.html" title="Accueil" aria-label="Accueil">üè†</a>

      <!-- 2) Inscriptions -->
      <a href="inscriptions.html">üìù Inscriptions</a>

      <!-- 3) Repas -->
      <a href="repas.html">üçΩÔ∏è Repas</a>

      <!-- 4) Programmation -->
      <a href="programmation.html">üóìÔ∏è Programmation</a>

      <!-- 5) √âquipes -->
      <a href="equipes.html" aria-current="page">üë• √âquipes</a>

      <!-- 6) Tirage -->
      <a href="tirage.html">üé≤ Tirage</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Compteurs + sous-onglets -->
  <section class="card">
    <h2 style="margin-bottom:6px;">üë• √âquipes inscrites</h2>

    <p class="muted" style="margin-top:0;">
      Total : <strong><span id="totalCount">0</span></strong>
      ‚Äî Principale : <strong><span id="mainCount">0</span></strong>/8
      ‚Äî Attente : <strong><span id="waitCount">0</span></strong>
      ‚Äî STBY : <strong><span id="stbyCount">0</span></strong>
    </p>

    <div class="subtabs" role="tablist" aria-label="Affichage √©quipes">
      <button class="subtab" id="tabInscrits" type="button" role="tab" aria-selected="true" aria-controls="panelInscrits">
        ‚úÖ Inscrits
      </button>
      <button class="subtab" id="tabClassees" type="button" role="tab" aria-selected="false" aria-controls="panelClassees">
        üè∑Ô∏è Class√©es
      </button>
    </div>

    <p class="muted" id="status" style="margin-top:10px;">Connexion‚Ä¶</p>
  </section>

  <!-- =========================
       VUE 1 : INSCRITS
  ========================== -->
  <div id="panelInscrits" role="tabpanel" aria-labelledby="tabInscrits">

    <!-- Liste principale -->
    <section class="card">
      <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <span>‚úÖ Liste principale</span>
        <span class="muted" style="font-weight:700;"><span id="mainCount2">0</span>/8</span>
      </h2>

      <div id="mainList" class="teams-list" aria-label="Liste principale"></div>
    </section>

    <!-- Liste d'attente -->
    <section class="card">
      <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <span>‚è≥ Liste d‚Äôattente</span>
        <span class="muted" style="font-weight:700;"><span id="waitCount2">0</span></span>
      </h2>

      <div id="waitList" class="teams-list" aria-label="Liste d‚Äôattente"></div>
    </section>

  </div>

  <!-- =========================
       VUE 2 : CLASS√âES
  ========================== -->
  <div id="panelClassees" style="display:none;" role="tabpanel" aria-labelledby="tabClassees">

    <section class="card">
      <h2 style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <span>üè∑Ô∏è √âquipes class√©es (liste principale)</span>
        <span class="muted" style="font-weight:700;"><span id="rankedCount">0</span> √©quipe(s)</span>
      </h2>

      <p class="muted" style="margin-top:0;">
        Tri : <b>classement √©quipe croissant</b> (Joueuse + Joueur). Le plus petit est en haut.
      </p>

      <div id="rankedList" class="teams-list" aria-label="√âquipes class√©es"></div>

      <p class="muted" style="margin:10px 0 0;">
        ‚ö†Ô∏è Si le classement d‚Äôun joueur n‚Äôest pas encore renseign√©, l‚Äô√©quipe appara√Æt en bas avec ‚Äú‚Äî‚Äù.
      </p>
    </section>

  </div>

</main>

<style>
  /* ‚úÖ Centre image du bandeau √©tape */
  .topbar-row-step{
    grid-template-columns: var(--logo-size) 1fr var(--logo-size);
  }
  .step-title-wrap{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height: calc(var(--logo-size) * 0.55);
  }
  .step-title-img{
    width: min(520px, 100%);
    max-height: 88px;
    height: auto;
    object-fit: contain;
    display:block;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.15));
  }

  /* ‚úÖ Nav √©tape : 6 onglets justifi√©s (2 lignes) */
  .nav-step{
    justify-content: space-between;
    gap: 8px;
  }
  .nav-step::after{
    content:"";
    flex:auto; /* aide √† mieux "√©taler" sur 2 lignes */
  }

  .nav-step a{
    padding:8px 12px;
    flex: 1 1 auto;
    text-align:center;
  }

  /* ‚úÖ Lien actif plus visible */
  .nav a[aria-current="page"]{
    background: rgba(255,255,255,.26);
    border-color: rgba(255,255,255,.45);
    box-shadow: 0 6px 14px rgba(0,0,0,.10);
  }

  @media (max-width: 420px){
    .nav-step a{
      padding:7px 10px;
      font-size: 13px;
    }
    .step-title-img{ max-height: 74px; }
  }

  /* ======================================
     LISTES √âQUIPES (mobile-friendly)
  ======================================= */
  .teams-list{
    display:grid;
    gap:10px;
    margin-top:12px;
  }

  .team-card{
    border:1px solid #eee;
    border-radius:14px;
    background:#fff;
    padding:12px 12px;
    box-shadow: 0 6px 16px rgba(0,0,0,.04);
    display:flex;
    gap:12px;
    align-items:stretch;
    justify-content:space-between;
  }

  .team-left{
    min-width:0;
    flex: 1 1 auto;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .team-line1{
    display:flex;
    align-items:baseline;
    gap:10px;
    flex-wrap:wrap;
  }

  .team-num{
    color:#666;
    font-variant-numeric: tabular-nums;
    white-space:nowrap;
    font-weight:800;
  }

  .team-name{
    font-weight:900;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 100%;
  }

  .team-rank{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #d9e6ff;
    background:#f3f7ff;
    font-weight:900;
    white-space:nowrap;
  }

  /* ‚úÖ 2e ligne pas en gras */
  .team-line2{
    color:#222;
    font-weight:400;
    line-height:1.25;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 100%;
  }

  .team-right{
    flex: 0 0 auto;
    display:flex;
    align-items:flex-start;
    justify-content:flex-end;
  }

  .pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #eee;
    background:#fafafa;
    color:#333;
    white-space:nowrap;
    font-weight:900;
  }
  .pill.stby{
    border-color:#ffd37a;
    background:#fff7e6;
  }

  /* Sous-onglets */
  .subtabs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .subtab{
    appearance:none;
    border:1px solid #ddd;
    background:#fafafa;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
  }
  .subtab[aria-selected="true"]{
    background:#fff;
    border-color:#cfcfcf;
    box-shadow: 0 6px 14px rgba(0,0,0,.06);
  }
</style>

<script type="module">
  import { db } from "../assets/js/firebase.js";
  import {
    collection,
    query,
    orderBy,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const MAX_MAIN = 8;
  const COL_PUBLIC = "equipes_etape1_public";

  const statusEl = document.getElementById("status");

  const totalCountEl = document.getElementById("totalCount");
  const mainCountEl = document.getElementById("mainCount");
  const waitCountEl = document.getElementById("waitCount");
  const stbyCountEl = document.getElementById("stbyCount");

  const mainCount2El = document.getElementById("mainCount2");
  const waitCount2El = document.getElementById("waitCount2");

  const rankedCountEl = document.getElementById("rankedCount");

  const mainList = document.getElementById("mainList");
  const waitList = document.getElementById("waitList");
  const rankedList = document.getElementById("rankedList");

  // Tabs
  const tabInscrits = document.getElementById("tabInscrits");
  const tabClassees = document.getElementById("tabClassees");
  const panelInscrits = document.getElementById("panelInscrits");
  const panelClassees = document.getElementById("panelClassees");

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function toNum(v){
    if(v === null || v === undefined || v === "") return null;
    const n = typeof v === "number" ? v : Number(String(v).replace(",", ".").trim());
    return Number.isFinite(n) ? n : null;
  }

  function fmtRank(n){
    return (n === null || n === undefined) ? "‚Äî" : String(n);
  }

  function statusPill(r){
    return r.stby ? `<span class="pill stby">STBY</span>` : `<span class="pill">OK</span>`;
  }

  function cardInscritHtml(idx, r){
    return `
      <div class="team-card">
        <div class="team-left">
          <div class="team-line1">
            <span class="team-num">#${idx}</span>
            <span class="team-name">${esc(r.teamName)}</span>
          </div>
          <div class="team-line2">${esc(r.p1FirstName)} / ${esc(r.p2FirstName)}</div>
        </div>
        <div class="team-right">
          ${statusPill(r)}
        </div>
      </div>
    `;
  }

  function cardClasseeHtml(idx, r){
    const p1 = toNum(r.p1Rank);
    const p2 = toNum(r.p2Rank);
    const teamRank = (p1 !== null && p2 !== null) ? (p1 + p2) : null;

    return `
      <div class="team-card">
        <div class="team-left">
          <div class="team-line1">
            <span class="team-num">#${idx}</span>
            <span class="team-name">${esc(r.teamName)}</span>
            <span class="team-rank">üè∑Ô∏è ${esc(fmtRank(teamRank))}</span>
          </div>
          <div class="team-line2">
            ${esc(r.p1FirstName)} (${esc(fmtRank(p1))}) / ${esc(r.p2FirstName)} (${esc(fmtRank(p2))})
          </div>
        </div>
        <div class="team-right">
          ${statusPill(r)}
        </div>
      </div>
    `;
  }

  function computeLists(rows){
    rows.sort((a,b) => (a.createdAtMs||0) - (b.createdAtMs||0));

    const forcedMain = rows.filter(r => r.list === "main");
    const forcedWait = rows.filter(r => r.list === "wait");
    const auto = rows.filter(r => !r.list);

    const main = [];
    const used = new Set();

    for(const r of forcedMain){
      if(!used.has(r.id)){ main.push(r); used.add(r.id); }
    }
    for(const r of auto){
      if(main.length >= MAX_MAIN) break;
      if(!used.has(r.id)){ main.push(r); used.add(r.id); }
    }

    const wait = [];
    for(const r of forcedWait){
      if(!used.has(r.id)){ wait.push(r); used.add(r.id); }
    }
    for(const r of rows){
      if(!used.has(r.id)){ wait.push(r); used.add(r.id); }
    }

    return { main, wait };
  }

  function render(rows){
    const { main, wait } = computeLists(rows);

    totalCountEl.textContent = rows.length;
    mainCountEl.textContent = main.length;
    waitCountEl.textContent = wait.length;
    stbyCountEl.textContent = rows.filter(r => r.stby).length;

    mainCount2El.textContent = main.length;
    waitCount2El.textContent = wait.length;

    mainList.innerHTML = main.length
      ? main.map((r,i) => cardInscritHtml(i+1, r)).join("")
      : `<p class="muted" style="margin:0;">Aucune √©quipe pour le moment.</p>`;

    waitList.innerHTML = wait.length
      ? wait.map((r,i) => cardInscritHtml(main.length + i + 1, r)).join("")
      : `<p class="muted" style="margin:0;">Aucune √©quipe en liste d‚Äôattente.</p>`;

    const ranked = [...main];
    ranked.sort((a,b)=>{
      const a1 = toNum(a.p1Rank), a2 = toNum(a.p2Rank);
      const b1 = toNum(b.p1Rank), b2 = toNum(b.p2Rank);
      const at = (a1 !== null && a2 !== null) ? (a1+a2) : Number.POSITIVE_INFINITY;
      const bt = (b1 !== null && b2 !== null) ? (b1+b2) : Number.POSITIVE_INFINITY;
      if(at !== bt) return at - bt;
      return (a.createdAtMs||0) - (b.createdAtMs||0);
    });

    rankedCountEl.textContent = ranked.length;

    rankedList.innerHTML = ranked.length
      ? ranked.map((r,i) => cardClasseeHtml(i+1, r)).join("")
      : `<p class="muted" style="margin:0;">Aucune √©quipe sur la liste principale.</p>`;
  }

  function showInscrits(){
    tabInscrits.setAttribute("aria-selected", "true");
    tabClassees.setAttribute("aria-selected", "false");
    panelInscrits.style.display = "block";
    panelClassees.style.display = "none";
    try{ localStorage.setItem("etape1_equipes_view", "inscrits"); }catch(e){}
  }
  function showClassees(){
    tabInscrits.setAttribute("aria-selected", "false");
    tabClassees.setAttribute("aria-selected", "true");
    panelInscrits.style.display = "none";
    panelClassees.style.display = "block";
    try{ localStorage.setItem("etape1_equipes_view", "classees"); }catch(e){}
  }

  tabInscrits.addEventListener("click", showInscrits);
  tabClassees.addEventListener("click", showClassees);

  try{
    const saved = localStorage.getItem("etape1_equipes_view");
    if(saved === "classees") showClassees(); else showInscrits();
  }catch(e){
    showInscrits();
  }

  const q = query(collection(db, COL_PUBLIC), orderBy("createdAt", "asc"));

  onSnapshot(q, (snap) => {
    const rows = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      rows.push({
        id: doc.id,
        teamName: d.teamName || "",
        p1FirstName: d.p1FirstName || "",
        p2FirstName: d.p2FirstName || "",
        createdAtMs: d.createdAt?.toMillis ? d.createdAt.toMillis() : 0,
        list: d.list || null,
        stby: d.stby === true,
        p1Rank: d.p1Rank ?? null,
        p2Rank: d.p2Rank ?? null
      });
    });

    render(rows);
    statusEl.textContent = "üü¢ En direct";
  }, (err) => {
    console.error(err);
    statusEl.textContent = "üî¥ Erreur de connexion";
  });
</script>

</body>
</html>
