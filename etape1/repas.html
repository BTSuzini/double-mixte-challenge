<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Repas â€” Ã‰tape 1</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260223" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row topbar-row-step">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <!-- âœ… Image au centre -->
      <div class="step-title-wrap" aria-label="Ã‰tape 1">
        <img class="step-title-img" src="../assets/img/etape1.png" alt="Ã‰tape 1">
      </div>

      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <!-- âœ… Nav Ã‰tape 1 -->
    <nav class="nav nav-step">
      <a href="../index.html" title="Accueil">ğŸ </a>
      <a href="inscriptions.html">ğŸ“ Inscriptions</a>
      <a href="repas.html" aria-current="page">ğŸ½ï¸ Repas</a>
      <a href="programmation.html">ğŸ—“ï¸ Programmation</a>
      <a href="equipes.html">ğŸ‘¥ Ã‰quipes</a>
      <a href="tirage.html">ğŸ² Tirage</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Sous-onglets -->
  <section class="card">
    <h2 style="margin-bottom:6px;">ğŸ½ï¸ Espace repas</h2>

    <div class="subtabs" role="tablist">
      <button class="subtab" id="tabFlyer" type="button" aria-selected="true">ğŸ“„ Flyer</button>
      <button class="subtab" id="tabCommander" type="button" aria-selected="false">ğŸ›’ Commander</button>
      <button class="subtab" id="tabCommandes" type="button" aria-selected="false">ğŸ“¦ Commandes</button>
    </div>
  </section>

  <!-- ======================
        FLYER
  ======================= -->
  <section class="card" id="panelFlyer">
    <h2>ğŸ“„ Flyer officiel</h2>

    <div style="text-align:center; margin-top:15px;">
      <img
        src="../assets/img/flyer.jpeg"
        alt="Flyer soirÃ©e italienne"
        style="max-width:100%; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.08);"
      >
    </div>
  </section>

  <!-- ======================
        COMMANDER
  ======================= -->
  <section class="card" id="panelCommander" style="display:none;">
    <h2>ğŸ›’ Commander</h2>

    <div style="margin-top:12px; line-height:1.6;">
      <p style="font-size:18px; font-weight:900; margin:0;">
        ğŸ¾ Offre spÃ©ciale pour les beacheurs !
      </p>

      <p style="margin:10px 0 0;">
        <strong>3 arancini pour 10â‚¬</strong> ğŸ‡®ğŸ‡¹ğŸ”¥
      </p>

      <p style="margin:10px 0 0; font-weight:900;">
        â³ RÃ©servations possibles jusquâ€™au 25/08
      </p>

      <hr class="sep" style="margin:14px 0;" />
    </div>

    <form id="orderForm" class="form" autocomplete="off">
      <div class="field">
        <label for="beacheurSelect">Beacheur *</label>
        <select id="beacheurSelect" required>
          <option value="" selected disabled>Chargementâ€¦</option>
        </select>
      </div>

      <div class="field">
        <label for="qtySelect">Nombre de packs *</label>
        <select id="qtySelect" required>
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <button id="btnOrder" class="btn" type="submit">
        âœ… Valider la commande
      </button>

      <p id="orderStatus" class="muted" style="margin-top:10px;"></p>
    </form>

    <div id="orderDone" class="card" style="display:none; margin-top:14px;">
      <h3>âœ… Commande enregistrÃ©e</h3>
      <p id="orderDoneText" class="muted"></p>
      <div class="grid" style="margin-top:12px;">
        <button class="btn" id="btnNewOrder" type="button">â• Autre commande</button>
        <button class="btn" id="btnGoList" type="button">ğŸ“¦ Voir commandes</button>
      </div>
    </div>
  </section>

  <!-- ======================
        COMMANDES
  ======================= -->
  <section class="card" id="panelCommandes" style="display:none;">
    <h2>ğŸ“¦ Commandes</h2>

    <p id="ordersStatus" class="muted">Chargementâ€¦</p>
    <div id="ordersList" class="orders-list"></div>

    <p class="muted" style="margin-top:10px;">
      ğŸ’¡ QuantitÃ© = nombre de packs â€œ3 aranciniâ€.
    </p>
  </section>

</main>

<style>
  .subtabs{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  #tabFlyer{ grid-column:1/-1; }

  .subtab{
    border:1px solid #ddd;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    background:#fafafa;
    cursor:pointer;
  }
  .subtab[aria-selected="true"]{
    background:#fff;
    border-color:#cfcfcf;
    box-shadow:0 6px 14px rgba(0,0,0,.06);
  }

  .orders-list{
    display:grid;
    gap:8px;
    margin-top:10px;
  }
  .order-row{
    border:1px solid #eee;
    border-radius:14px;
    padding:10px;
    background:#fff;
    display:grid;
    grid-template-columns:38px 1fr auto;
    gap:10px;
    align-items:center;
  }
  .order-num{ font-weight:900; }
  .order-name{ font-weight:900; }
  .order-total{ font-weight:900; }
</style>

<script type="module">
  import { db } from "../assets/js/firebase.js";
  import {
    collection, query, orderBy, onSnapshot,
    doc, runTransaction, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const COL_TEAMS = "equipes_etape1_public";
  const COL_ORDERS = "repas_etape1";
  const UNIT_PRICE = 10;

  const tabFlyer = document.getElementById("tabFlyer");
  const tabCommander = document.getElementById("tabCommander");
  const tabCommandes = document.getElementById("tabCommandes");
  const panelFlyer = document.getElementById("panelFlyer");
  const panelCommander = document.getElementById("panelCommander");
  const panelCommandes = document.getElementById("panelCommandes");

  function show(panel){
    panelFlyer.style.display="none";
    panelCommander.style.display="none";
    panelCommandes.style.display="none";
    panel.style.display="block";
  }

  tabFlyer.onclick=()=>{show(panelFlyer)};
  tabCommander.onclick=()=>{show(panelCommander)};
  tabCommandes.onclick=()=>{show(panelCommandes)};

  show(panelFlyer);

  const beacheurSelect=document.getElementById("beacheurSelect");
  const ordersList=document.getElementById("ordersList");
  const ordersStatus=document.getElementById("ordersStatus");

  const teamsQ=query(collection(db,COL_TEAMS),orderBy("createdAt","asc"));
  onSnapshot(teamsQ,(snap)=>{
    const opts=[];
    snap.forEach(d=>{
      const data=d.data()||{};
      if(data.p1FirstName) opts.push({k:d.id+"_p1",n:data.p1FirstName});
      if(data.p2FirstName) opts.push({k:d.id+"_p2",n:data.p2FirstName});
    });
    beacheurSelect.innerHTML=`<option disabled selected>Choisirâ€¦</option>`+
      opts.map(o=>`<option value="${o.k}">${o.n}</option>`).join("");
  });

  const ordersQ=query(collection(db,COL_ORDERS),orderBy("beacheurName","asc"));
  onSnapshot(ordersQ,(snap)=>{
    const rows=[];
    snap.forEach(d=>rows.push(d.data()));
    if(!rows.length){
      ordersList.innerHTML="<p class='muted'>Aucune commande.</p>";
      ordersStatus.textContent="0 commande";
      return;
    }
    ordersList.innerHTML=rows.map((r,i)=>`
      <div class="order-row">
        <div class="order-num">#${i+1}</div>
        <div class="order-name">${r.beacheurName}</div>
        <div class="order-total">${r.total} â‚¬</div>
      </div>
    `).join("");
    ordersStatus.textContent=`${rows.length} commande(s)`;
  });
</script>

</body>
</html>
