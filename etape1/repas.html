<script type="module">
  import { db } from "../assets/js/firebase.js";
  import {
    collection, query, orderBy, onSnapshot,
    doc, getDoc, setDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const COL_TEAMS = "equipes_etape1_public";
  const COL_ORDERS = "repas_etape1";
  const UNIT_PRICE = 10;

  const tabFlyer = document.getElementById("tabFlyer");
  const tabCommander = document.getElementById("tabCommander");
  const tabCommandes = document.getElementById("tabCommandes");
  const panelFlyer = document.getElementById("panelFlyer");
  const panelCommander = document.getElementById("panelCommander");
  const panelCommandes = document.getElementById("panelCommandes");

  function setSelected(btn){
    tabFlyer.setAttribute("aria-selected", btn === tabFlyer ? "true" : "false");
    tabCommander.setAttribute("aria-selected", btn === tabCommander ? "true" : "false");
    tabCommandes.setAttribute("aria-selected", btn === tabCommandes ? "true" : "false");
  }

  function show(panel, btn){
    panelFlyer.style.display="none";
    panelCommander.style.display="none";
    panelCommandes.style.display="none";
    panel.style.display="block";
    setSelected(btn);
  }

  tabFlyer.onclick=()=>show(panelFlyer, tabFlyer);
  tabCommander.onclick=()=>show(panelCommander, tabCommander);
  tabCommandes.onclick=()=>show(panelCommandes, tabCommandes);

  show(panelFlyer, tabFlyer);

  const orderForm = document.getElementById("orderForm");
  const beacheurSelect = document.getElementById("beacheurSelect");
  const qtySelect = document.getElementById("qtySelect");
  const btnOrder = document.getElementById("btnOrder");
  const orderStatus = document.getElementById("orderStatus");

  const orderDone = document.getElementById("orderDone");
  const orderDoneText = document.getElementById("orderDoneText");
  const btnNewOrder = document.getElementById("btnNewOrder");
  const btnGoList = document.getElementById("btnGoList");

  const ordersList = document.getElementById("ordersList");
  const ordersStatus = document.getElementById("ordersStatus");

  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function setOrderEnabled(enabled){
    beacheurSelect.disabled = !enabled;
    qtySelect.disabled = !enabled;
    btnOrder.disabled = !enabled;
    btnOrder.classList.toggle("disabled", !enabled);
  }

  function resetOrderUI(){
    orderDone.style.display = "none";
    orderForm.style.display = "block";
    orderStatus.textContent = "";
    setOrderEnabled(true);
  }

  btnNewOrder?.addEventListener("click", resetOrderUI);
  btnGoList?.addEventListener("click", ()=>show(panelCommandes, tabCommandes));

  // =========================
  // Charger beacheurs
  // =========================
  const teamsQ = query(collection(db, COL_TEAMS), orderBy("createdAt","asc"));

  onSnapshot(teamsQ,(snap)=>{
    const opts=[];
    snap.forEach(d=>{
      const data=d.data()||{};
      const teamName = (data.teamName || "").trim();
      const p1 = (data.p1FirstName || "").trim();
      const p2 = (data.p2FirstName || "").trim();

      if(p1) opts.push({k:d.id+"_p1", n:p1, t: teamName});
      if(p2) opts.push({k:d.id+"_p2", n:p2, t: teamName});
    });

    opts.sort((a,b)=>
      (a.n||"").localeCompare((b.n||""),"fr") ||
      (a.t||"").localeCompare((b.t||""),"fr")
    );

    beacheurSelect.innerHTML =
      `<option value="" disabled selected>Choisir‚Ä¶</option>` +
      opts.map(o=>`
        <option value="${esc(o.k)}"
          data-name="${esc(o.n)}"
          data-team="${esc(o.t)}">
          ${esc(o.n)}${o.t ? " ("+esc(o.t)+")" : ""}
        </option>
      `).join("");
  });

  // =========================
  // Cr√©ation unique
  // =========================
  async function createOrderOnce({ beacheurKey, beacheurName, teamName, qty }){
    const ref = doc(db, COL_ORDERS, beacheurKey);
    const snap = await getDoc(ref);

    if(snap.exists()){
      return { ok:false };
    }

    await setDoc(ref,{
      beacheurKey,
      beacheurName,
      teamName,
      qty,
      unitPrice: UNIT_PRICE,
      total: qty * UNIT_PRICE,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    return { ok:true };
  }

  orderForm?.addEventListener("submit", async (e)=>{
    e.preventDefault();

    const key = beacheurSelect.value?.trim();
    const qty = Number(qtySelect.value);

    if(!key){
      orderStatus.textContent="‚ùå Choisis un beacheur.";
      return;
    }

    const opt = beacheurSelect.selectedOptions?.[0];
    const name = opt?.dataset?.name || "";
    const team = opt?.dataset?.team || "";

    setOrderEnabled(false);
    orderStatus.textContent="Enregistrement‚Ä¶";

    try{
      const res = await createOrderOnce({
        beacheurKey:key,
        beacheurName:name,
        teamName:team,
        qty
      });

      if(!res.ok){
        alert("‚ö†Ô∏è Tu as d√©j√† une commande.\n\nVa dans l‚Äôonglet ‚Äúüì¶ Commandes‚Äù pour la modifier.");
        setOrderEnabled(true);
        orderStatus.textContent="";
        show(panelCommandes, tabCommandes);
        return;
      }

      orderForm.reset();
      orderForm.style.display="none";
      orderDone.style.display="block";
      orderDoneText.innerHTML=`
        <b>${esc(name)}</b>${team ? " ("+esc(team)+")" : ""}<br>
        Commande : <b>${qty}</b> pack(s).
      `;

      orderStatus.textContent="";
    }catch(err){
      console.error(err);
      setOrderEnabled(true);
      orderStatus.textContent="‚ùå Erreur.";
    }
  });

  // =========================
  // Modifier commande
  // =========================
  async function updateOrderQty(id,newQty){
    await updateDoc(doc(db,COL_ORDERS,id),{
      qty:newQty,
      total:newQty*UNIT_PRICE,
      updatedAt:serverTimestamp()
    });
  }

  const ordersQ=query(collection(db,COL_ORDERS),orderBy("beacheurName","asc"));

  onSnapshot(ordersQ,(snap)=>{
    const rows=[];
    snap.forEach(d=>{
      const x=d.data()||{};
      rows.push({
        id:d.id,
        name:x.beacheurName,
        team:x.teamName,
        qty:x.qty,
        total:x.total
      });
    });

    if(!rows.length){
      ordersList.innerHTML="<p class='muted'>Aucune commande.</p>";
      ordersStatus.textContent="üü¢ En direct ‚Äî 0 commande";
      return;
    }

    ordersList.innerHTML=rows.map((r,i)=>`
      <div class="order-row">
        <div>#${i+1}</div>
        <div>
          <div style="font-weight:900;">
            ${esc(r.name)}
            ${r.team ? `<span class="muted">(${esc(r.team)})</span>` : ""}
          </div>
          <div class="muted">Qt√© : <b>${r.qty}</b></div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:900;">${r.total} ‚Ç¨</div>
          <button class="btn" data-edit="${r.id}" style="margin-top:6px;">
            ‚úèÔ∏è Modifier
          </button>
        </div>
      </div>
    `).join("");

    ordersStatus.textContent=`üü¢ En direct ‚Äî ${rows.length} commande(s)`;

    ordersList.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.onclick=async ()=>{
        const id=btn.dataset.edit;
        const row=rows.find(r=>r.id===id);
        const v=prompt("Nouvelle quantit√© :",row.qty);
        if(v===null) return;
        const n=Number(v);
        if(!Number.isFinite(n)||n<1) return alert("Quantit√© invalide");
        await updateOrderQty(id,n);
        alert("‚úÖ Commande modifi√©e");
      };
    });

  });
</script>
