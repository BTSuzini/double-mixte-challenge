<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JAT â€” Double Mixte Challenge</title>
  <link rel="stylesheet" href="../assets/css/main.css?v=20260223" />
</head>
<body>

<header class="topbar">
  <div class="container">
    <div class="topbar-row">
      <div class="brand-logo">
        <img src="../assets/img/logo-suzini.png" alt="Logo Suzini">
      </div>

      <!-- âœ… mÃªme bandeau que le rÃ¨glement (centre = image) -->
      <div class="brand-title" style="display:flex;align-items:center;justify-content:center;">
        <img src="../assets/img/etape1-jaune.png"
             alt="Suzini Beach Tennis Double Mixte Challenge"
             style="width:min(560px, 100%);max-height:90px;height:auto;object-fit:contain;display:block;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));">
      </div>


      <div class="brand-logo">
        <img src="../assets/img/logo-challenge.png" alt="Logo Challenge">
      </div>
    </div>

    <nav class="nav">
      <a href="../index.html">ğŸ  Accueil public</a>
      <a href="#" id="btnLogout">ğŸšª DÃ©connexion</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card" id="accessDenied" style="display:none;">
    <h2 style="margin:0 0 8px;">â›” AccÃ¨s refusÃ©</h2>
    <p class="muted" style="margin:0;">Cette page est rÃ©servÃ©e aux administrateurs et aux JAT.</p>
  </section>

  <section class="card" id="jatUI" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ›ï¸ Zone</h2>

    <div class="field">
      <label for="scope">Choisir une Ã©tape</label>
      <select id="scope">
        <option value="general">ğŸŒ GÃ©nÃ©ral</option>
        <option value="etape1">ğŸ¾ Ã‰tape 1</option>
        <option value="etape2">ğŸ¾ Ã‰tape 2</option>
        <option value="etape3">ğŸ¾ Ã‰tape 3</option>
        <option value="etape4">ğŸ¾ Ã‰tape 4</option>
        <option value="etape5">ğŸ§ª Ã‰tape 5 (test)</option>
      </select>
    </div>

    <div class="grid" style="margin-top:10px;" id="tabs"></div>

    <p class="muted" id="hint" style="margin-top:10px;"></p>
  </section>

  <section class="card" id="panelGeneral" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ“° Infos (lecture)</h2>
    <p class="muted" style="margin:0;">
      AccÃ¨s rapide aux infos (mÃªme interface que lâ€™admin si besoin), sinon on pourra faire une version lecture seule plus tard.
    </p>

    <div class="grid" style="margin-top:12px;">
      <a class="btn" id="btnGoInfos" href="../admin/index.html" style="font-weight:900; color:#111;">
        ğŸ“° Ouvrir Infos (admin)
      </a>
    </div>
  </section>

  <section class="card" id="panelStep" style="display:none;">
    <h2 style="margin:0 0 10px;">ğŸ¾ Outils JAT</h2>
    <p class="muted" style="margin:0;" id="stepTitle">â€”</p>

    <div class="grid" style="margin-top:12px;">
      <a class="btn" id="goProg" href="#" style="font-weight:900; color:#111;">ğŸ“… Programmation</a>
      <a class="btn" id="goRes"  href="#" style="font-weight:900; color:#111;">ğŸ RÃ©sultats</a>
      <a class="btn" id="goVer"  href="#" style="font-weight:900; color:#111;">ğŸ” VÃ©rification</a>
      <a class="btn" id="goCls"  href="#" style="font-weight:900; color:#111;">ğŸ… Classement</a>
    </div>

    <p class="muted" style="margin-top:12px;">
      â„¹ï¸ Pour lâ€™instant, droits identiques Ã  lâ€™admin. On affinera plus tard.
    </p>
  </section>

</main>

<script type="module">
  import { auth } from "../assets/js/firebase.js";
  import { logout, requireRole } from "../assets/js/session.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const accessDenied = document.getElementById("accessDenied");
  const jatUI = document.getElementById("jatUI");

  const scopeEl = document.getElementById("scope");
  const tabsEl = document.getElementById("tabs");
  const hintEl = document.getElementById("hint");

  const panelGeneral = document.getElementById("panelGeneral");
  const panelStep = document.getElementById("panelStep");
  const stepTitle = document.getElementById("stepTitle");

  const goProg = document.getElementById("goProg");
  const goRes  = document.getElementById("goRes");
  const goVer  = document.getElementById("goVer");
  const goCls  = document.getElementById("goCls");

  const LS_SCOPE_KEY = "jat_scope_last";

  function stepLabel(scope){
    if(!scope || scope === "general") return "GÃ©nÃ©ral";
    return `Ã‰tape ${scope.replace("etape","")}`;
  }

  function setTabs(scope){
    tabsEl.innerHTML = "";
    panelGeneral.style.display = "none";
    panelStep.style.display = "none";

    try{ localStorage.setItem(LS_SCOPE_KEY, scope); }catch{}

    if(scope === "general"){
      hintEl.textContent = "ğŸŒ Zone GÃ©nÃ©ral : accÃ¨s infos.";
      panelGeneral.style.display = "block";

      const a = document.createElement("a");
      a.className = "btn";
      a.href = "#";
      a.textContent = "ğŸ“° Infos";
      a.onclick = (e)=> e.preventDefault();
      tabsEl.appendChild(a);

      return;
    }

    hintEl.textContent = "ğŸ¾ Zone Ã‰tape : programmation / rÃ©sultats / vÃ©rification / classement.";
    panelStep.style.display = "block";

    stepTitle.textContent = `${stepLabel(scope)} â€” BT250`;

    goProg.href = `programmation.html?scope=${encodeURIComponent(scope)}`;
    goRes.href  = `resultats.html?scope=${encodeURIComponent(scope)}`;
    goVer.href  = `verification.html?scope=${encodeURIComponent(scope)}`;
    goCls.href  = `classement.html?scope=${encodeURIComponent(scope)}`;
  }

  document.getElementById("btnLogout").onclick = async (e)=>{
    e.preventDefault();
    await logout();
    window.location.href = "../index.html";
  };

  function showDenied(){
    accessDenied.style.display = "block";
    jatUI.style.display = "none";
  }

  function showJat(){
    accessDenied.style.display = "none";
    jatUI.style.display = "block";

    try{
      const saved = localStorage.getItem(LS_SCOPE_KEY);
      if(saved && [...scopeEl.options].some(o => o.value === saved)){
        scopeEl.value = saved;
      }
    }catch{}

    setTabs(scopeEl.value);
    scopeEl.onchange = ()=> setTabs(scopeEl.value);
  }

  const g = await requireRole(["admin","jat"]);
  if(!g.ok){ showDenied(); } else { showJat(); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showDenied(); return; }
    const g2 = await requireRole(["admin","jat"]);
    if(!g2.ok){ showDenied(); return; }
  });
</script>

</body>
</html>
